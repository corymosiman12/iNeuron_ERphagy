---
title: "ERphagy_FigureGeneration1"
author: "Ian Smith"
date: "2023-02-15"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}
library(tidyverse)
library(ggpubr)
library(pheatmap)
library(RColorBrewer)
library(cowplot)
library(ggrepel)
library(purrr)
'%!in%' <- function(x,y)!('%in%'(x,y))

```


## Organelle annotation import

```{r}
ss_organelle_list<-read.csv("C:/Harper/Side_analysis/Melissa_shiny/ERphagy/ss_organelle_list2_wh_annotation_cytoAddedBasedGO_ERannotation.csv")

#tidy form annotations for localizations
ss_organelle_list<-ss_organelle_list%>%
  tidyr::gather("Compartment_ss","Gene.Symbol",1:23)%>%
  dplyr::filter(!is.na(Gene.Symbol), Gene.Symbol != "")


sub_all_er<- c("Golgi", "Lysosome","Mitochondria","Plasma.Membrane","Endosome","Peroxisome",
               "Nucleus","Cytosol","ER","ER.Lumen","ER.high.curvature","ER.high.sheet",
               "ER.Membrane","ER.Membrane.associated","ER.Receptors"   ,"Trans.Golgi","Cis.Golgi","ERGIC"   )

simp_all_er<- c("Golgi", "Lysosome","Mitochondria","Plasma.Membrane","Endosome","Peroxisome",
               "Nucleus","Cytosol","ER"  )

sub_all_er_more<- c("Golgi", "Lysosome","Mitochondria","Plasma.Membrane","Endosome","Peroxisome",
               "Nucleus","Cytosol","ER","ER.Lumen","ER.high.curvature","ER.high.sheet",
               "ER.Membrane","ER.Membrane.associated"  )

organelle_input_er_split <- ss_organelle_list %>% dplyr::filter(Compartment_ss %in% sub_all_er )

organelle_input_er_simple <- ss_organelle_list %>% dplyr::filter(Compartment_ss %in% simp_all_er )
organelle_input_er_more <- ss_organelle_list %>% dplyr::filter(Compartment_ss %in% sub_all_er_more )


```


## Figure 1 Data 



### Alban Differentiation dataset

```{r}
ao_data<-read.csv("C:/Harper/Side_analysis/Melissa_shiny/ERphagy/alban_data/ShinyApp_hotelling_results.csv")



diff_df_full<-left_join(ao_data,organelle_input_er_simple,by="Gene.Symbol")%>%
  distinct()


diff_df_full_erOnly<-left_join(ao_data,organelle_input_er_split,by="Gene.Symbol")%>%
  distinct()%>%
  filter(Compartment_ss %in% c("ER.Lumen","ER.Membrane","ER.Membrane.associated","ER.high.curvature","ER.Receptors","ER.high.sheet"))


write.csv(diff_df_full_erOnly, "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/SuppData_Diff_erOnly.csv")

write.csv(diff_df_full, "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/SuppData_Diff_allData.csv")













# ao_data_ann <- dplyr::left_join(ao_data,organelle_input_er_split, by="Gene.Symbol")

ao_data_tidy<-ao_data%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,
                d0_1,d0_2,d1_1,d1_2,d2_1,d2_2,d4_1,d4_2,
                d6_1,d6_2,d8_1,d8_2,d10_1,d10_2,d12_1,d12_2)%>%
  # group_by(Reference,Gene.Symbol,Annotation)%>%
  # gather("sample","log2_int",4:19)%>%
  dplyr::left_join(.,organelle_input_er_simple, by="Gene.Symbol")%>%
  dplyr::filter(Compartment_ss =="ER")
  

only_er<- c("ER.Lumen","ER.high.curvature","ER.high.sheet",
               "ER.Membrane","ER.Membrane.associated","ER.Receptors"   )

only_er_list<- ss_organelle_list %>% dplyr::filter(Compartment_ss %in% only_er )%>%
  dplyr::mutate(to_remove = paste(Gene.Symbol,Compartment_ss))%>%
  dplyr::filter(to_remove %!in%  c("RRBP1 ER.Membrane","KTN1 ER.Lumen","RETREG1 ER.high.curvature",
                                   "RETREG2 ER.high.curvature","RETREG3 ER.high.curvature",
                                   "ATL3 ER.high.curvature","RTN3 ER.high.curvature","FAM134A ER.high.curvature",
                                   "FAM134B ER.high.curvature","FAM134C ER.high.curvature"))%>%
  dplyr::select(-to_remove)


ao_data_tidy<-ao_data_tidy%>%
  dplyr::select(-Compartment_ss)%>%
  dplyr::left_join(.,only_er_list, by="Gene.Symbol")%>%
  dplyr::mutate(d12tod0 = (d12_1+d12_2)/2 - (d0_1+d0_2)/2)%>%
  dplyr::arrange(Compartment_ss, d12tod0)%>%
  dplyr::distinct()%>%
  tidyr::unite("ProtID", c(Reference,Gene.Symbol,Annotation),sep="__X__")%>%
  tibble::rowid_to_column("Rank")%>%
  dplyr::mutate(Rank= as.numeric(as.character(Rank)))

### z-score annotation
ao_data<-read.csv("C:/Harper/Side_analysis/Melissa_shiny/ERphagy/alban_data/ShinyApp_hotelling_results.csv")


ao_data_tidy2<-ao_data%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,
                d0_1,d0_2,d1_1,d1_2,d2_1,d2_2,d4_1,d4_2,
                d6_1,d6_2,d8_1,d8_2,d10_1,d10_2,d12_1,d12_2)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  gather("sample","log2_int",4:19)%>%
  dplyr::left_join(.,organelle_input_er_simple, by="Gene.Symbol")%>%
  dplyr::filter(Compartment_ss =="ER")%>%
  dplyr::distinct()


ao_data_tidy2$sample <- factor(ao_data_tidy2$sample,levels = c("d0_1","d0_2","d1_1","d1_2","d2_1","d2_2","d4_1","d4_2",
                "d6_1","d6_2","d8_1","d8_2","d10_1","d10_2","d12_1","d12_2"))

heatmap_input<-ao_data_tidy2%>%
      tidyr::unite("ProtID", c(Reference,Gene.Symbol,Annotation),sep="__X__")%>%
      dplyr::ungroup()%>%
      dplyr::group_by(ProtID)%>%
      dplyr::mutate(mean_row = mean(log2_int),
             sd_row = sd(log2_int),
             z_scale = (log2_int - mean_row)/sd_row,
             mean_scale = log2_int - mean_row)

heatmap_input_scale_t0<-ao_data_tidy2%>%
  dplyr::filter(sample == "d0_1"|sample == "d0_2")%>%
      tidyr::unite("ProtID", c(Reference,Gene.Symbol,Annotation),sep="__X__")%>%
      dplyr::ungroup()%>%
      dplyr::group_by(ProtID)%>%
      dplyr::summarise(mean_row_d0 = mean(log2_int))


heatmap_input_scale_D0_join<- dplyr::left_join(heatmap_input,heatmap_input_scale_t0,by="ProtID" )%>%
  dplyr::mutate(d0_scale_value = log2_int - mean_row_d0)


heatmap_input2<-heatmap_input%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,mean_scale)%>%
  dplyr::group_by(ProtID)%>%
  tidyr::spread(sample,mean_scale)%>%
  # dplyr::filter(ProtID %in% sig$ProtID)%>%
  tibble::column_to_rownames("ProtID")

annotation<-heatmap_input%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,mean_scale)%>%
  dplyr::group_by(ProtID)%>%
  tidyr::spread(sample,mean_scale)%>%
  tidyr::separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::select(-Annotation)%>%
  dplyr::mutate(protein = paste(Gene.Symbol,Reference,sep="_"))%>%
  dplyr::left_join(.,only_er_list,by="Gene.Symbol")

annotation_df<-annotation%>%
  dplyr::select(Compartment_ss)%>%
  dplyr::rename(Var1 = Compartment_ss)

rownames(annotation_df) <- annotation$protein



annotation_heatmap <- annotation%>%
  select(protein,3:18)%>%
  column_to_rownames("protein")

rownames(annotation_df) <- rownames(annotation_heatmap)


# add group annotation
anno<-data.frame(row.names=annotation$protein, Annotation=annotation$Compartment_ss)
library(RColorBrewer)

# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(anno$Annotation))))
annoCol <- newCols(length(unique(anno$Annotation)))
names(annoCol) <- unique(anno$Annotation)
annoCol <- list(category = annoCol)


# quantile_breaks <- function(xs, n = 10) {
#   breaks <- quantile(xs, probs = seq(0, 1, length.out = n))
#   breaks[!duplicated(breaks)]
# }
# 
# mat_breaks <- quantile_breaks(annotation_heatmap, n = 11)

# test<-pheatmap(annotation_heatmap, cluster_cols = F,  annotation_row = anno, cellheight = 10, cellwidth = 10)


paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-4, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 4, length.out=floor(paletteLength/2)))

# Plot the heatmap
# pheatmap(test, color=myColor, breaks=myBreaks)
# test<-pheatmap(annotation_heatmap, cluster_cols = F,  annotation_row = anno,show_rownames=F, color=myColor, breaks=myBreaks)

# test<-pheatmap(annotation_heatmap, cluster_cols = F,  annotation_row = anno,show_rownames=F, color=rev(colorRampPalette(brewer.pal(6,name="PuOr"))(16)))





# annotation$order<-test$tree_row$order

# annotation2<-annotation%>%
#   dplyr::group_by(Reference,Gene.Symbol,protein,Compartment_ss,order)%>%
#   gather("sample","row_mean_val",3:18)
# 
# 
# 
# annotation2$sample <- factor(annotation2$sample,levels = c("d0_1","d0_2","d1_1","d1_2","d2_1","d2_2","d4_1","d4_2",
#                 "d6_1","d6_2","d8_1","d8_2","d10_1","d10_2","d12_1","d12_2"))
# 
# # annotation2$protein <- factor(annotation2$protein,levels = reorder(annotation$protein,order,min))
# 
# annotation2<-annotation2%>%
#   arrange(order)
# 
# 
# # annotation2$sample <- factor(annotation2$sample,levels = seq(1,324,1))
# 
# # ggplot(annotation2, aes(factor(sample),reorder(factor(protein),order),fill=row_mean_val))+geom_tile()+scale_fill_gradient2(breaks=breaks,low = "blue",mid="white",high="red")
# breaks <- c(-4,-0.5,0,0.5,5)
# 
# ggplot(annotation2, aes(factor(sample),reorder(factor(protein),order),fill=row_mean_val))+geom_tile()+scale_fill_gradient2(breaks=breaks,low = "blue",mid="white",high="red")+theme()
```

```{r}
heatmap_input2<-heatmap_input_scale_D0_join%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,d0_scale_value)%>%
  dplyr::group_by(ProtID)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  # dplyr::filter(ProtID %in% sig$ProtID)%>%
  tibble::column_to_rownames("ProtID")

annotation<-heatmap_input_scale_D0_join%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,d0_scale_value)%>%
  dplyr::group_by(ProtID)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  tidyr::separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::select(-Annotation)%>%
  dplyr::mutate(protein = paste(Gene.Symbol,Reference,sep="_"))%>%
  dplyr::left_join(.,only_er_list,by="Gene.Symbol")

annotation_df<-annotation%>%
  dplyr::select(Compartment_ss)%>%
  dplyr::rename(Var1 = Compartment_ss)

rownames(annotation_df) <- annotation$protein



annotation_heatmap <- annotation%>%
  select(protein,3:18)%>%
  column_to_rownames("protein")

rownames(annotation_df) <- rownames(annotation_heatmap)


# add group annotation
anno<-data.frame(row.names=annotation$protein, Annotation=annotation$Compartment_ss)
library(RColorBrewer)

# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(anno$Annotation))))
annoCol <- newCols(length(unique(anno$Annotation)))
names(annoCol) <- unique(anno$Annotation)
annoCol <- list(category = annoCol)


# quantile_breaks <- function(xs, n = 10) {
#   breaks <- quantile(xs, probs = seq(0, 1, length.out = n))
#   breaks[!duplicated(breaks)]
# }
# 
# mat_breaks <- quantile_breaks(annotation_heatmap, n = 11)

# test<-pheatmap(annotation_heatmap, cluster_cols = F,  annotation_row = anno, cellheight = 10, cellwidth = 10)


paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-4, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 4, length.out=floor(paletteLength/2)))

# Plot the heatmap
# pheatmap(test, color=myColor, breaks=myBreaks)
# test<-pheatmap(annotation_heatmap, cluster_cols = F,  annotation_row = anno,show_rownames=F, color=myColor, breaks=myBreaks)






# ggsave(test,filename="C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_firstPass/ER_diff_protein_heatmap_all.pdf",height = 14,width=8)
```


### Most changing from d0 to d12

```{r}
d12_changers <-heatmap_input_scale_D0_join%>%
  dplyr::filter(sample == "d12_1" | sample == "d12_2")%>%
  group_by(ProtID)%>%
  summarise(mean_d12_change = mean(d0_scale_value))

d12_changers <-d12_changers%>%
  dplyr::arrange(mean_d12_change)

d12_input <- left_join(heatmap_input_scale_D0_join, d12_changers, by="ProtID")





bottom25<-d12_changers[1:50,]%>%
  tibble::rowid_to_column("Rank")%>%
  dplyr::mutate(Rank=as.numeric(as.character(Rank)))


top25<-d12_changers[275:324,]%>%
  tibble::rowid_to_column("Rank")%>%
  dplyr::mutate(Rank=as.numeric(as.character(Rank)))


top25_data<- heatmap_input_scale_D0_join %>% dplyr::filter(ProtID %in%top25$ProtID )%>%
  dplyr::arrange(desc(d0_scale_value))
# %>%
#   tidyr::separate(ProtID, into= c("Reference","Gene.Symbol","Annotation"),sep="__X__")


bottom25_data<- heatmap_input_scale_D0_join %>% dplyr::filter(ProtID %in%bottom25$ProtID )%>%
  dplyr::arrange(d0_scale_value)
# %>%
#   tidyr::separate(ProtID, into= c("Reference","Gene.Symbol","Annotation"),sep="__X__")

bottom25_data<- inner_join(heatmap_input_scale_D0_join,bottom25,by="ProtID")%>%
  dplyr::arrange(Rank)

top25_data<- inner_join(heatmap_input_scale_D0_join,top25,by="ProtID")%>%
  dplyr::arrange(Rank)


receptors<- organelle_input_er_split%>%
  filter(Compartment_ss == "ER.Receptors")%>%
  filter(Gene.Symbol %in% c("TEX264","CCPG1","SEC62"))

high<-organelle_input_er_split%>%
  filter(Compartment_ss %in% c("ER.high.sheet","ER.high.curvature"))

high <- bind_rows(high,receptors)

high_curve <- heatmap_input_scale_D0_join%>%
  mutate(dup = ProtID)%>%
  separate(dup ,  c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  select(-Compartment_ss)%>%
  # filter(Gene.Symbol %in% c(high$Gene.Symbol))%>%
  inner_join(.,high,by="Gene.Symbol")%>%
  select(-Reference,-Gene.Symbol,-Annotation)
# %>%
#   select(ProtID)
  
high_data<- inner_join(heatmap_input_scale_D0_join,high_curve,by="ProtID")%>%
  distinct()



# %>%
#   dplyr::arrange(Rank)
```


### high curve

```{r}
 

annotation<-high_curve%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,d0_scale_value, Compartment_ss)%>%
  dplyr::group_by(ProtID,Compartment_ss)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  # arrange(desc(Rank))%>%
  # dplyr::ungroup()%>%
  # dplyr::select(-Rank)%>%
  tidyr::separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::select(-Annotation)%>%
  separate(Reference , into = c("type","Reference","Annotation"),sep="\\|")%>%
  dplyr::mutate(protein = paste(Gene.Symbol,Reference,sep="_"))%>%
  # dplyr::left_join(.,only_er_list,by="Gene.Symbol")%>%
  # mutate(Compartment_ss = if_else(Compartment_ss == "ER.Receptors","ER.high.curvature",Compartment_ss))%>%
  arrange(Compartment_ss,Gene.Symbol)



# heatmap_input2<-high_data%>%
#   dplyr::ungroup()%>%
#   dplyr::select(ProtID,sample,d0_scale_value)%>%
#   separate(ProtID,c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
#   dplyr::select(-Annotation,-Reference)%>%
#   dplyr::group_by(Gene.Symbol)%>%
#   tidyr::spread(sample,d0_scale_value)%>%
#   # arrange(Rank)%>%
#   # dplyr::ungroup()%>%
#   # dplyr::select(-Rank)%>%
#   # dplyr::filter(ProtID %in% sig$ProtID)%>%
#   tibble::column_to_rownames("Gene.Symbol")%>%
#   dplyr::left_join(.,only_er_list,by="Gene.Symbol")%>%
#   mutate(Compartment_ss = if_else(Compartment_ss == "ER.Receptors","ER.high.curvature",Compartment_ss))%>%
#   arrange(Compartment_ss)



annotation_df<-annotation%>%
  dplyr::select(Compartment_ss)%>%
  dplyr::rename(Var1 = Compartment_ss)

rownames(annotation_df) <- annotation$protein



annotation_heatmap <- annotation%>%
  ungroup()%>%
  select(protein,6:21)%>%
  column_to_rownames("protein")

rownames(annotation_df) <- rownames(annotation_heatmap)


# add group annotation
anno<-data.frame(row.names=annotation$protein, Annotation=annotation$Compartment_ss)
library(RColorBrewer)


# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(anno$Annotation))))
annoCol <- newCols(length(unique(anno$Annotation)))
names(annoCol) <- unique(anno$Annotation)
annoCol <- list(category = annoCol)


# quantile_breaks <- function(xs, n = 10) {
#   breaks <- quantile(xs, probs = seq(0, 1, length.out = n))
#   breaks[!duplicated(breaks)]
# }
# 
# mat_breaks <- quantile_breaks(annotation_heatmap, n = 11)

# test<-pheatmap(annotation_heatmap, cluster_cols = F,  annotation_row = anno, cellheight = 10, cellwidth = 10)


paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-3, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength,3, length.out=floor(paletteLength/2)))

# Plot the heatmap
# pheatmap(test, color=myColor, breaks=myBreaks)
annotation_heatmap<-annotation_heatmap


df_col_ann <- data.frame("sample"= colnames(annotation)[6:21], values = c("d0","d0","d1","d1","d2","d2","d4","d4","d6","d6","d8","d8","d10","d10","d12","d12"))

df_col_ann$values <- factor(df_col_ann$values, levels = c("d0","d1","d2","d4","d6","d8","d10","d12"))
annoD<-data.frame(row.names=df_col_ann$sample, Condition=df_col_ann$values)

test<-pheatmap(annotation_heatmap, cluster_cols = F,  cluster_rows = F, color=myColor,annotation_row = anno,annotation = annoD, breaks=myBreaks, border_color = FALSE)



# ggsave(test,filename="C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig1c_heatmap_highcurveSheet_receptors.pdf",height = 6.5,width=8)


```




### top50

```{r}
 

heatmap_input2<-top25_data%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,Rank,d0_scale_value)%>%
  tidyr::separate(ProtID,c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::select(-Annotation,-Reference)%>%
  dplyr::group_by(Gene.Symbol,Rank)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  arrange(Rank)%>%
  dplyr::ungroup()%>%
  dplyr::select(-Rank)%>%
  # dplyr::filter(ProtID %in% sig$ProtID)%>%
  tibble::column_to_rownames("Gene.Symbol")

annotation<-top25_data%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,Rank,d0_scale_value)%>%
  dplyr::group_by(ProtID,Rank)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  arrange(desc(Rank))%>%
  dplyr::ungroup()%>%
  # dplyr::select(-Rank)%>%
  tidyr::separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::select(-Annotation)%>%
  dplyr::mutate(protein = paste(Gene.Symbol,Reference,sep="_"))%>%
  dplyr::left_join(.,only_er_list,by="Gene.Symbol")%>%
  arrange(Compartment_ss)

annotation_df<-annotation%>%
  dplyr::select(Compartment_ss)%>%
  dplyr::rename(Var1 = Compartment_ss)

rownames(annotation_df) <- annotation$Gene.Symbol



annotation_heatmap <- annotation%>%
  select(Gene.Symbol,3:19)%>%
  column_to_rownames("Gene.Symbol")

rownames(annotation_df) <- rownames(annotation_heatmap)


# add group annotation
anno<-data.frame(row.names=annotation$Gene.Symbol, Annotation=annotation$Compartment_ss)
library(RColorBrewer)


# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(anno$Annotation))))
annoCol <- newCols(length(unique(anno$Annotation)))
names(annoCol) <- unique(anno$Annotation)
annoCol <- list(category = annoCol)


# quantile_breaks <- function(xs, n = 10) {
#   breaks <- quantile(xs, probs = seq(0, 1, length.out = n))
#   breaks[!duplicated(breaks)]
# }
# 
# mat_breaks <- quantile_breaks(annotation_heatmap, n = 11)

# test<-pheatmap(annotation_heatmap, cluster_cols = F,  annotation_row = anno, cellheight = 10, cellwidth = 10)


paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-4, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 4, length.out=floor(paletteLength/2)))

# Plot the heatmap
# pheatmap(test, color=myColor, breaks=myBreaks)
annotation_heatmap<-annotation_heatmap%>%
  select(-Rank)

test<-pheatmap(annotation_heatmap, cluster_cols = F,  cluster_rows = F,annotation_row = anno, color=myColor, breaks=myBreaks, border_color = FALSE)



# ggsave(test,filename="C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig1b_ER_top50up_diff_protein_heatmap_all.pdf",height = 10,width=8)


```

### bottom50

```{r}
 

heatmap_input2<-bottom25_data%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,Rank,d0_scale_value)%>%
  tidyr::separate(ProtID,c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::select(-Annotation,-Reference)%>%
  dplyr::group_by(Gene.Symbol,Rank)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  arrange(Rank)%>%
  dplyr::ungroup()%>%
  dplyr::select(-Rank)%>%
  # dplyr::filter(ProtID %in% sig$ProtID)%>%
  tibble::column_to_rownames("Gene.Symbol")

annotation<-bottom25_data%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,Rank,d0_scale_value)%>%
  dplyr::group_by(ProtID,Rank)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  arrange((Rank))%>%
  dplyr::ungroup()%>%
  # dplyr::select(-Rank)%>%
  tidyr::separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::select(-Annotation)%>%
  dplyr::mutate(protein = paste(Gene.Symbol,Reference,sep="_"))%>%
  dplyr::left_join(.,only_er_list,by="Gene.Symbol")%>%
  arrange(Compartment_ss)

annotation_df<-annotation%>%
  dplyr::select(Compartment_ss)%>%
  dplyr::rename(Var1 = Compartment_ss)

rownames(annotation_df) <- annotation$Gene.Symbol



annotation_heatmap <- annotation%>%
  select(Gene.Symbol,3:19)%>%
  column_to_rownames("Gene.Symbol")

rownames(annotation_df) <- rownames(annotation_heatmap)


# add group annotation
anno<-data.frame(row.names=annotation$Gene.Symbol, Annotation=annotation$Compartment_ss)
library(RColorBrewer)


# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(anno$Annotation))))
annoCol <- newCols(length(unique(anno$Annotation)))
names(annoCol) <- unique(anno$Annotation)
annoCol <- list(category = annoCol)


# quantile_breaks <- function(xs, n = 10) {
#   breaks <- quantile(xs, probs = seq(0, 1, length.out = n))
#   breaks[!duplicated(breaks)]
# }
# 
# mat_breaks <- quantile_breaks(annotation_heatmap, n = 11)

# test<-pheatmap(annotation_heatmap, cluster_cols = F,  annotation_row = anno, cellheight = 10, cellwidth = 10)


paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-4, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 4, length.out=floor(paletteLength/2)))

# Plot the heatmap
# pheatmap(test, color=myColor, breaks=myBreaks)
annotation_heatmap<-annotation_heatmap%>%
  select(-Rank)

test<-pheatmap(annotation_heatmap, cluster_cols = F,  cluster_rows = F,annotation_row = anno, color=myColor, breaks=myBreaks,border_color = FALSE)


# ggsave(test,filename="C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig1a_ER_down50down_diff_protein_heatmap_all.pdf",height = 10,width=8)



```



### differentiation of major fluxers


```{r}


list_accum<-c("TEX264","CCPG1","RTN3","RTN1","RTN2","RTN3","RTN4",
              "ARL6IP1","REEP2","REEP3","REEP4","REEP5","REEP6",
              "SEC62","SQSTM1","ATL3","ATL2","AKAP11","CALCOCO1",
              "CALCOCO2","TAX1BP1","GABARAPL1","GABARAPL2",
              "RETREG1","RETREG2","RETREG3",
              "ZFYVE27","LNP")





ao_data_tidy_individ<-ao_data_tidy%>%
  dplyr::group_by(Rank,ProtID)%>%
  tidyr::gather("sample", "log2_int",3:18)%>%
  tidyr::separate(ProtID,into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::filter(Gene.Symbol %in% list_accum)

ao_data_tidy_individ$sample <- factor(ao_data_tidy_individ$sample,levels = c("d0_1","d0_2","d1_1","d1_2","d2_1","d2_2","d4_1","d4_2",
                "d6_1","d6_2","d8_1","d8_2","d10_1","d10_2","d12_1","d12_2"))

d0_mean<- ao_data_tidy_individ%>%
  dplyr::filter(sample == "d0_1" | sample == "d0_2")%>%
  dplyr::group_by(Gene.Symbol)%>%
  dplyr::mutate(mean_d0 = mean(log2_int))%>%
  dplyr::ungroup()%>%
  dplyr::distinct(Gene.Symbol,mean_d0)

ao_data_tidy_individ<-ao_data_tidy_individ%>%
  dplyr::left_join(.,d0_mean,by="Gene.Symbol")%>%
  dplyr::ungroup()%>%
  dplyr::mutate(Log2FC = log2_int - mean_d0,
                time_pt_factor = stringr::str_sub(sample,start = 1,end=-3 ),
                time= str_remove(time_pt_factor, "d"),
                time=as.numeric(as.character(time)))




ao_data_tidy_individ$sample <- factor(ao_data_tidy_individ$sample,levels = c("d0_1","d0_2","d1_1","d1_2","d2_1","d2_2","d4_1","d4_2",
                "d6_1","d6_2","d8_1","d8_2","d10_1","d10_2","d12_1","d12_2"))

ao_data_tidy_individ$time_pt_factor <- factor(ao_data_tidy_individ$time_pt_factor,levels = c("d0","d1","d2","d4",
                "d6","d8","d10","d12"))
dif_plot_accum<-ggplot()+
  geom_point(data=ao_data_tidy_individ, aes(time,Log2FC,color=time_pt_factor,group=sample),size=3,alpha=0.5)+
  geom_line(data=ao_data_tidy_individ%>%ungroup()%>%group_by(Gene.Symbol,time,time_pt_factor)%>%
              summarise(Log2FC=mean(Log2FC)), aes(time,Log2FC))+
  # geom_col(data=ao_data_tidy_individ%>%ungroup()%>%group_by(Gene.Symbol,time,time_pt_factor)%>%
  #             summarise(Log2FC=mean(Log2FC)), aes(factor(time),Log2FC))+
  theme_classic()+
  facet_wrap(.~Gene.Symbol,nrow=5)+
  geom_hline(yintercept = 0,linetype="dashed")+
  scale_color_viridis_d(end=0.8,option = "inferno",direction = 1)+
  theme(axis.title = element_text(size=14), axis.text = element_text(size=12),
        strip.text.x = element_text(size = 10))+
  labs(x="Time (days)", y="Log2(Day # / Day 0)",color="# of days")+ scale_x_continuous(breaks=seq(0,12,2))

dif_plot_accum

# ggsave(dif_plot_accum, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_firstPass/ER_diff_highCurv_linePlot.pdf",height = 8,width=8)


```




## Single KO data

### Import data

```{r}
singles <- read.csv("C:/Harper/Side_analysis/Melissa_shiny/ERphagy/data/Shiny_MS3_d12_WTATG12singles/all_ttest_results_WTATG12singles.csv")


singles_df_full<-left_join(singles,organelle_input_er_simple,by="Gene.Symbol")%>%
  distinct()


singles_df_full_erOnly<-left_join(singles,organelle_input_er_split,by="Gene.Symbol")%>%
  distinct()%>%
  filter(Compartment_ss %in% c("ER.Lumen","ER.Membrane","ER.Membrane.associated","ER.high.curvature","ER.Receptors","ER.high.sheet"))


write.csv(singles_df_full_erOnly, "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/SuppData_singlesKO_erOnly.csv")

write.csv(singles_df_full, "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/SuppData_singlesKO_allData.csv")




singles_slim<-singles%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,99:116)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  gather("sample","log2_int",4:21)%>%
  dplyr::mutate(cellLine=dplyr::if_else(str_detect(sample,"WT"),0,1))%>%
  dplyr::ungroup()




wt_Only_singles_slim<-singles_slim%>%
  dplyr::filter(cellLine==0)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  summarise(mean_wt0 = mean(log2_int))


singles_norm<-left_join(singles_slim,wt_Only_singles_slim, by=c("Reference","Gene.Symbol","Annotation") )%>%
  dplyr::mutate(log2_int_wtd0_norm = log2_int - mean_wt0)

singles_norm$sample <- factor(singles_norm$sample,
                              levels=c("WT_1","WT_2","WT_3",
                                       "ATG12_1","ATG12_2","ATG12_3",
                                       "CCPG1_1","CCPG1_2","CCPG1_3",
                                       "TEX264_1","TEX264_2","TEX264_3",
                                       "FAM134A_1","FAM134A_2",
                                       "FAM134B_1","FAM134B_2",
                                       "FAM134C_1","FAM134C_2" ))



```


### heatmap Singles er

heat map of only high curvature and high sheet normalized to mean wt value


```{r}
high


er_raw<-singles_norm%>%
  # left_join(.,organelle_input_er_split,by="Gene.Symbol")%>%
  inner_join(.,high,by="Gene.Symbol")%>%
  # filter(str_detect(Compartment_ss,"ER")==T)%>%
  # filter(Compartment_ss != "ER")%>%
  # filter(Compartment_ss != 'Peroxisome')%>%
  # filter(Compartment_ss == "ER.high.curvature"| Compartment_ss == "ER.high.sheet")%>%
  group_by(Gene.Symbol)%>%
  mutate(counts=n(),
         Compartment=Compartment_ss)%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  select(-type,-desc)%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-log2_int,-cellLine,-mean_wt0, -counts,-Annotation,-Compartment)%>%
  group_by(ProtID, Compartment_ss)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  arrange(Compartment_ss)%>%
  mutate(Compartment_ss =str_replace_all(Compartment_ss,"\\."," "))


all_dataB_heatmap <- er_raw %>%
  ungroup()%>%
  # filter(Compartment_ss =="ER")%>%
  select(-Compartment_ss)%>%
  column_to_rownames(var="ProtID")

annotation_allB<-er_raw %>%
  # filter(Compartment_ss =="ER")%>%
  select(ProtID, Compartment_ss)

df_col_ann <- data.frame("sample"= colnames(er_raw)[3:20], values = c("WT","WT","WT",
                                                                "ATG12","ATG12","ATG12",
                                                                "CCPG1","CCPG1","CCPG1",
                                                                "TEX264","TEX264","TEX264",
                                                                "FAM134A","FAM134A",
                                                                "FAM134B","FAM134B",
                                                                "FAM134C","FAM134C"))
annoD<-data.frame(row.names=df_col_ann$sample, Condition=df_col_ann$values)
annoB<-data.frame(row.names=annotation_allB$ProtID, Annotation=annotation_allB$Compartment_ss)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann$sample, Condition=df_col_ann$values)

# annoD$Condition<-factor(annoD$Condition, values=c("WT","ATG12","CCPG1","TEX264","FAM134A","FAM134B","FAM134C"))

# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 1, length.out=floor(paletteLength/2)))

# test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


rownames(annoD) <- colnames(all_dataB_heatmap)

test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB,annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)

# ggsave(plot = test, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4a_singlets_heatmap_ERhc_ERhs.pdf", height = 4.5,width=7.5)

```







### ATG12 singlets heatmap

heat map of only high curvature and high sheet normalized to mean wt value


```{r}
er_raw<-singles_norm%>%
  # left_join(.,organelle_input_er_split,by="Gene.Symbol")%>%
  # filter(str_detect(Compartment_ss,"ER")==T)%>%
  filter(str_detect(sample,"WT") |str_detect(sample,"ATG12") )%>%
  # filter(Compartment_ss != "ER")%>%
  # filter(Compartment_ss != 'Peroxisome')%>%
  # filter(Compartment_ss == "ER.high.curvature"| Compartment_ss == "ER.high.sheet")%>%
  inner_join(.,high,by="Gene.Symbol")%>%
  group_by(Gene.Symbol)%>%
  mutate(counts=n(),
         Compartment=Compartment_ss)%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  select(-type,-desc)%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-log2_int,-cellLine,-mean_wt0, -counts,-Annotation,-Compartment)%>%
  group_by(ProtID, Compartment_ss)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  arrange(Compartment_ss)%>%
  mutate(Compartment_ss =str_replace_all(Compartment_ss,"\\."," "))


all_dataB_heatmap <- er_raw %>%
  ungroup()%>%
  # filter(Compartment_ss =="ER")%>%
  select(-Compartment_ss)%>%
  column_to_rownames(var="ProtID")

annotation_allB<-er_raw %>%
  # filter(Compartment_ss =="ER")%>%
  select(ProtID, Compartment_ss)

df_col_ann <- data.frame("sample"= colnames(er_raw)[3:8], values = c("WT","WT","WT",
                                                                "ATG12","ATG12","ATG12"))

annoB<-data.frame(row.names=annotation_allB$ProtID, Annotation=annotation_allB$Compartment_ss)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann$sample, Condition=df_col_ann$values)

# annoD$Condition<-factor(annoD$Condition, values=c("WT","ATG12","CCPG1","TEX264","FAM134A","FAM134B","FAM134C"))

# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 1, length.out=floor(paletteLength/2)))

# test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


rownames(annoD) <- colnames(all_dataB_heatmap)

test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB,annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)

# ggsave(plot = test, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig1f_singlets_ATG12only_heatmap_ERhc_ERhs.pdf", height = 4.5,width=5)

```





### Single ER accumulation plots violin by compartment


```{r}

## extract organellar FC data to WT
singles_fc<-singles%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WT"))%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  pivot_longer(cols = starts_with("log2FC_"),
               names_to = "Condition",
               values_to = "FCval")%>%
  mutate(Condition = str_remove(Condition,"log2FC_"),
         Condition = str_remove(Condition,"\\.WT"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))

singles_fc$Condition <- factor(singles_fc$Condition, levels=c("ATG12","CCPG1","TEX264","FAM134A", "FAM134B","FAM134C"))



## all organelles

plot1<-ggplot(singles_fc%>%filter(!is.na(Compartment_ss),Compartment_ss != "ER high sheet", Compartment_ss %!in% c("ER high curvature","ER Lumen","ER Membrane","ER Membrane associated"),Condition != "ATG12")%>%
         filter(Gene.Symbol != Condition), aes(fill=Condition,x=" ", y=FCval))+
  geom_hline(yintercept = 0,linetype="dashed")+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.8)+
  theme_classic()+
  labs(x="",y=bquote(""~Log[2]~"(KO / WT)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "top",
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))+
  facet_wrap(.~Compartment_ss,nrow=3)+ylim(c(-1.5,1.5))+ guides(fill = guide_legend(nrow = 1))+
  scale_fill_manual(values = c("#C29BA3","#C9EBEF","lightgreen","#FFCCB6","#69A6D1"))


plot1

# ggsave(plot = plot1, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/supfig3a_singlets_violin_organelle_accum.pdf", height = 12,width=14)


### ER substructure


pv_fc_er_singles<-ggplot(singles_fc%>%filter(!is.na(Compartment_ss),Compartment_ss != "ER high sheet", Compartment_ss %in% c("ER Lumen","ER Membrane","ER Membrane associated","ER"),Condition != "ATG12", Gene.Symbol != Condition)%>%
         filter(Gene.Symbol != Condition), aes(fill=Condition,x=" ", y=FCval))+
  geom_hline(yintercept = 0,linetype="dashed")+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.8)+
  theme_classic()+facet_wrap(.~Compartment_ss,nrow=1)+
  scale_fill_manual(values = c("#C29BA3","#C9EBEF","lightgreen","#FFCCB6","#69A6D1"))+
  scale_color_manual(values = c("#C29BA3","#C9EBEF","lightgreen","#FFCCB6","#69A6D1"))+
  labs(x="",y=bquote(""~Log[2]~"(KO/WT)"))+ylim(c(-1.5,2.5))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "bottom",
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))

pv_fc_er_singles

# ggsave(plot = pv_fc_er_singles, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig3c_Singles_KO_accum_ERonly_violin_FC.pdf", height = 6,width=12)
```




## New data 202302_diff 

Sample set contains WT, ATG12, CA, CAB, CAB_TEX,CAB_TEX_CCPG1

```{r}
d12_plexa<- read.csv("C:/Harper/Side_analysis/Melissa_shiny/ERphagy/data/2023_02_05 d12 WTATG12_CA_CAB_quad_penta/d12_WTATG12_CA_CAB_quad_penta_ttest_results (5).csv")

### with normalized replicate information

d12_plexa_slim<-d12_plexa%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,74:91)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  gather("sample","log2_int",4:21)%>%
  dplyr::mutate(cellLine=dplyr::if_else(str_detect(sample,"WT"),0,1))%>%
  dplyr::ungroup()

### calculate mean WT intensity for nmomalization
wt_Only_d12_plexa_slim<-d12_plexa_slim%>%
  dplyr::filter(cellLine==0)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  summarise(mean_wt0 = mean(log2_int))

### mean WT subtract form replicate values with no ATG12
norm_d12_plex<-left_join(d12_plexa_slim,wt_Only_d12_plexa_slim, by=c("Reference","Gene.Symbol","Annotation") )%>%
  dplyr::mutate(log2_int_wtd0_norm = log2_int - mean_wt0)%>%
  filter(str_detect(sample,"ATG12")==F)

### same as above but with ATG12
norm_d12_plex2<-left_join(d12_plexa_slim,wt_Only_d12_plexa_slim, by=c("Reference","Gene.Symbol","Annotation") )%>%
  dplyr::mutate(log2_int_wtd0_norm = log2_int - mean_wt0)

```

### Violin plots for organelle differences

```{r}
## FC extraction

accum_fc<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WTd12"))%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  pivot_longer(cols = starts_with("log2FC_"),
               names_to = "Condition",
               values_to = "FCval")%>%
  mutate(Condition = str_remove(Condition,"log2FC_"),
         Condition = str_remove_all(Condition,"d12"),
         Condition = str_remove(Condition,"\\.WT"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))

accum_fc$Condition <- factor(accum_fc$Condition, 
                             levels=c("ATG12","CA","CAB","CABTEX","CABTEXCCPG1"))


### ER only

norm_d12_plex2_ann2<-accum_fc%>%
  filter(str_detect(Compartment_ss,"ER")==T, Compartment_ss != "ERGIC",Compartment_ss != "ER high sheet",Compartment_ss != "ER Receptors",Compartment_ss != "ER high curvature")%>%
         mutate(Compartment_ss=str_replace_all(Compartment_ss,"\\."," "))

norm_d12_plex2_ann2$Condition <- factor(norm_d12_plex2_ann2$Condition,levels=c("ATG12","CA","CAB","CABTEX","CABTEXCCPG1"))


pv_fc_er<-ggplot(norm_d12_plex2_ann2%>%filter(Gene.Symbol %!in% c("FAM134C","FAM134B","FAM134A","TEX264","CCPG1"))%>%filter(Condition != "WTd12"), aes(" ", FCval, color=Condition,fill=Condition))+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.8, position = position_dodge(),color="black")+theme_classic()+geom_hline(yintercept = 0,linetype="dashed")+
  scale_fill_manual(values=c("maroon","#5ec962","#21918c","#3b528b","#440154"))+
  labs(x="",y=bquote(""~Log[2]~"(KO / WT)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "bottom",
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))+
  facet_wrap(.~Compartment_ss, nrow=1)+ylim(c(-1.5,2.5))
pv_fc_er

# ggsave(plot = pv_fc_er, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig3d_KO_accum_ERonly_violin_FC.pdf", height = 6,width=12)

## all locale


norm_d12_plex2_ann4<-accum_fc%>%
  filter( Compartment_ss %in% c("Cytosol","Endosome","ER",
                                "Golgi","Lysosome","Mitochondria",
                                "Nucleus","Peroxisome","Plasma Membrane"))

norm_d12_plex2_ann4$Condition <- factor(norm_d12_plex2_ann4$Condition,levels=c("ATG12","CA","CAB","CABTEX","CABTEXCCPG1"))


pv_fc_all<-ggplot(norm_d12_plex2_ann4, aes(" ", FCval, color=Condition,fill=Condition))+
  # geom_point(position=position_jitterdodge(dodge.width = 0.9),size=0.75,alpha=0.25)+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.8, position = position_dodge(),color="black")+theme_classic()+geom_hline(yintercept = 0,linetype="dashed")+
  # scale_fill_viridis_d(end = 0.8,direction = -1)+
  # scale_color_viridis_d(end=0.8,direction = -1)+
  scale_fill_manual(values=c("maroon","#5ec962","#21918c","#3b528b","#440154"))+
  scale_color_manual(values=c("maroon","#5ec962","#21918c","#3b528b","#440154"))+
  labs(x="",y=bquote(""~Log[2]~"(KO / WT)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "top",
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))+
  facet_wrap(.~Compartment_ss,nrow=3)+ylim(c(-1.5,1.5))+ guides(fill = guide_legend(nrow = 1))

pv_fc_all

# ggsave(plot = pv_fc_all, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/supfig3b_KO_accum_AllOrganelles_violin_FC_nopoints.pdf", height = 12,width=14)






```

### ATG12 only effect


```{r}

norm_d12_plex2$sample<-factor(norm_d12_plex2$sample,levels=c("WTd12_1","WTd12_2","WTd12_3",          "ATG12d12_1","ATG12d12_2","ATG12d12_3","CAd12_1","CAd12_2","CAd12_3","CABd12_1","CABd12_2","CABd12_3","CABTEXd12_1","CABTEXd12_2","CABTEXd12_3","CABTEXCCPG1d12_1","CABTEXCCPG1d12_2", "CABTEXCCPG1d12_3"))

er_raw<-norm_d12_plex2%>%
  # left_join(.,organelle_input_er_split,by="Gene.Symbol")%>%
  # filter(str_detect(Compartment_ss,"ER")==T)%>%
  filter(str_detect(sample,"WT") |str_detect(sample,"ATG12") )%>%
  # filter(Compartment_ss != "ER")%>%
  # filter(Compartment_ss != 'Peroxisome')%>%
  # filter(Compartment_ss == "ER.high.curvature"| Compartment_ss == "ER.high.sheet")%>%
  inner_join(.,high,by="Gene.Symbol")%>%
  group_by(Gene.Symbol)%>%
  mutate(counts=n(),
         Compartment=Compartment_ss)%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  select(-type,-desc)%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-log2_int,-cellLine,-mean_wt0, -counts,-Annotation,-Compartment)%>%
  group_by(ProtID, Compartment_ss)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  arrange(Compartment_ss)%>%
  mutate(Compartment_ss =str_replace_all(Compartment_ss,"\\."," "))



all_dataB_heatmap <- er_raw %>%
  ungroup()%>%
  # filter(Compartment_ss =="ER")%>%
  select(-Compartment_ss)%>%
  column_to_rownames(var="ProtID")

annotation_allB<-er_raw %>%
  # filter(Compartment_ss =="ER")%>%
  select(ProtID, Compartment_ss)

df_col_ann <- data.frame("sample"= colnames(er_raw)[3:8], values = c("WT","WT","WT",
                                                                "ATG12","ATG12","ATG12"))

df_col_ann$values <- factor(df_col_ann$values, levels=c("WT","ATG12"))

annoB<-data.frame(row.names=annotation_allB$ProtID, Annotation=annotation_allB$Compartment_ss)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann$sample, Condition=df_col_ann$values)

# annoD$Condition<-factor(annoD$Condition, values=c("WT","ATG12","CCPG1","TEX264","FAM134A","FAM134B","FAM134C"))

# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 1, length.out=floor(paletteLength/2)))

# test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


rownames(annoD) <- colnames(all_dataB_heatmap)

test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB,annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)

# ggsave(plot = test, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig1f_accumdataset_ATG12only_heatmap_ERhc_ERhs.pdf", height = 4.5,width=5)


```




### ATG12 effect


```{r}


### ATG12 only 



norm_d12_plex2_ann4<-accum_fc%>%
  filter(str_detect(Compartment_ss,"ER")==T, Compartment_ss %in% c("ER","ER high curvature","ER Membrane","ER Membrane associated","ER Lumen"))

norm_d12_plex2_ann4$Condition <- factor(norm_d12_plex2_ann4$Condition,levels = c("WT","ATG12","CA","CAB","CABTEX","CABTEXCCPG1"))

norm_d12_plex2_ann4%>%
  distinct(Reference,Compartment_ss)%>%
  group_by(Compartment_ss)%>%
  summarise(counts=n())

er_atg12_violin<-ggplot(norm_d12_plex2_ann4%>%
         filter(Condition =="ATG12"), aes(Compartment_ss, FCval, color=Compartment_ss,fill=Compartment_ss))+
  geom_jitter(alpha=0.2,color="black")+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.75, position = position_dodge(),color="black")+
  # geom_text_repel(data=norm_d12_plex2_ann4%>%
  #        filter(Condition =="ATG12",Compartment_ss == "ER high curvature"),aes(Compartment_ss, FCval,fill=Compartment_ss,label=Gene.Symbol), color="black",box.padding = 1,max.overlaps = Inf)+
  # geom_boxplot(position = position_dodge(),outlier.shape = NA)+
  theme_classic()+geom_hline(yintercept = 0,linetype="dashed")+
  # scale_color_brewer(palette = "Greens", direction = -1)+
  # scale_fill_brewer(palette = "Greens",direction = -1)+
  scale_fill_manual(values = c("#C29BA3","#C9EBEF","lightgreen","#FFCCB6","#69A6D1"))+
  scale_color_manual(values=c("#C29BA3","#C9EBEF","lightgreen","#FFCCB6","#69A6D1"))+
  labs(x="",y=bquote(""~Log[2]~"(ATG12 KO / WT)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        # legend.position = "bottom",
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))

er_atg12_violin

# ggsave(plot = er_atg12_violin, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig1e_accumdataset_ATG12only_ERonly_violin_FC.pdf", height = 6,width=8)


### all locales

norm_d12_plex2_ann4<-accum_fc%>%
  filter(Compartment_ss %in% c("ER","Peroxisome","Endosome", "Golgi","Plasma Membrane","Nucleus","Cytosol","Mitochondria","Lysosome"))

norm_d12_plex2_ann4$Condition <- factor(norm_d12_plex2_ann4$Condition,levels = c("WT","ATG12","CA","CAB","CABTEX","CABTEXCCPG1"))

norm_d12_plex2_ann4%>%
  distinct(Reference,Compartment_ss)%>%
  group_by(Compartment_ss)%>%
  summarise(counts=n())

all_atg12_violin<-ggplot(norm_d12_plex2_ann4%>%
         filter(Condition =="ATG12"), aes(Compartment_ss, FCval, color=Compartment_ss,fill=Compartment_ss))+
  # geom_jitter(alpha=0.35,color="darkgreen")+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.75, position = position_dodge(),color="black")+
  # geom_text_repel(data=norm_d12_plex2_ann4%>%
  #        filter(Condition =="ATG12",Compartment_ss == "ER high curvature"),aes(Compartment_ss, FCval,fill=Compartment_ss,label=Gene.Symbol), color="black",box.padding = 1,max.overlaps = Inf)+
  # geom_boxplot(position = position_dodge(),outlier.shape = NA)+
  theme_classic()+geom_hline(yintercept = 0,linetype="dashed")+
  # scale_color_brewer(palette = "Greens", direction = -1)+
  # scale_fill_brewer(palette = "Greens",direction = -1)+
  scale_fill_viridis_d(direction=-1)+

  labs(x="",y=bquote(""~Log[2]~"(ATG12 KO / WT)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        # legend.position = "bottom",
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))+ylim(c(-1,1))

all_atg12_violin

# ggsave(plot = all_atg12_violin, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig1d_accumdataset_ATG12only_AllOrganelle_violin_FC.pdf", height = 6,width=10)


###
accum_fc<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WTd12"))%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  pivot_longer(cols = starts_with("log2FC_"),
               names_to = "Condition",
               values_to = "FCval")%>%
  mutate(Condition = str_remove(Condition,"log2FC_"),
         Condition = str_remove_all(Condition,"d12"),
         Condition = str_remove(Condition,"\\.WT"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))


high_curve <- organelle_input_er_split%>%filter(Compartment_ss == "ER.high.curvature")

eronly<-organelle_input_er_split%>%filter(Compartment_ss == "ER")

slim_atg<-d12_plexa %>%
  select(Reference,Gene.Symbol,Annotation,log2FC_ATG12d12.WTd12,q.val_ATG12d12.WTd12,sig_ATG12d12.WTd12)


d12_plexa_annotation <- d12_plexa%>%
  mutate(Annotation_vol = if_else(Gene.Symbol %in% c("ATG16L1","ATG5","RB1CC1","ATG12","STX17","RAB33B","ATG10"), "down_autophagy",
                                  if_else(Gene.Symbol %in%  c("GABARAPL1","GABARAPL2","SQSTM1","SEC62","TAX1BP1","MAP1LC3B1","MAP1LC3B2","MAP1LC3A1","CALCOCO1","CALCOCO2","AKAP11","TEX264"), "up_autophagy", if_else(Gene.Symbol %in% c(high_curve$Gene.Symbol), "high_curve",if_else(Gene.Symbol %in% c("CKAP4","KTN1","RRBP1"), "high_sheet",if_else(Gene.Symbol %in% c(eronly$Gene.Symbol),"ER","neither"))))))
    


fig1_atg12_volcano<-ggplot(d12_plexa_annotation%>%filter(Annotation_vol == "neither"), aes(log2FC_ATG12d12.WTd12,-log10(q.val_ATG12d12.WTd12)))+
  geom_point(color="honeydew3", alpha=0.4)+
  geom_point(data=d12_plexa_annotation%>%filter(Annotation_vol != "neither"),aes(log2FC_ATG12d12.WTd12,-log10(q.val_ATG12d12.WTd12),color=Annotation_vol))+
  theme_classic()+
  scale_color_manual(values=c("#542788","darkolivegreen4","mediumvioletred","lightslateblue","#B35806"))+
  geom_text_repel(data=d12_plexa_annotation%>%filter(Annotation_vol != "neither" , Annotation_vol != "ER"), aes(log2FC_ATG12d12.WTd12,-log10(q.val_ATG12d12.WTd12),  label=Gene.Symbol,color=Annotation_vol),size=4, max.overlaps = Inf,box.padding = 1 ,show.legend = FALSE)+
  geom_hline(yintercept = -log10(0.05),linetype="dashed")+
  geom_vline(xintercept = log2(1.5),linetype="dashed")+
  geom_vline(xintercept = -log2(1.5),linetype="dashed")+
  labs(x= bquote(""~Log[2]~"(ATG12 KO / WT)"),
       y= bquote("-"~Log[10]~"(q-value)"))+
  theme(legend.title = element_blank(),
        axis.title = element_text(size=18),
        axis.text = element_text(size=16))
  
    
# ggsave(plot = fig1_atg12_volcano, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig1g_accumdataset_ATG12only_VolcanoPlot.pdf", height = 6,width=10)


```

#### Fig1 : correlation diff vs atg12 effect


```{r}


ss_organelle_list_ex<-read.csv("C:/Harper/Side_analysis/Melissa_shiny/ERphagy/ss_organelle_list2_wh_annotation_cytoAddedBasedGO_ERannotation.csv")

#tidy form annotations for localizations
ss_organelle_list_ex<-ss_organelle_list_ex%>%
  tidyr::gather("Compartment_ss","Gene.Symbol",1:23)%>%
  dplyr::filter(!is.na(Gene.Symbol), Gene.Symbol != "")%>%
  filter(Compartment_ss == "ER")

diff_results_d12diff<-heatmap_input_scale_D0_join%>%
  select(ProtID,sample,d0_scale_value)%>%
  filter(sample %in% c("d12_1","d12_2"))%>%
  group_by(ProtID)%>%
  summarise(d12tod0= mean(d0_scale_value))%>%
  ungroup()%>%
  separate(ProtID,into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  filter(Gene.Symbol %in% ss_organelle_list_ex$Gene.Symbol )

atg12_effectOnly<-norm_d12_plex2%>%
  select(Reference,Gene.Symbol,Annotation,sample,log2_int_wtd0_norm)%>%
  filter(sample %in% c("ATG12d12_1","ATG12d12_2","ATG12d12_3"))%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  summarise(atg12_effect = mean(log2_int_wtd0_norm))%>%
  filter(Gene.Symbol %in% ss_organelle_list_ex$Gene.Symbol )%>%
  inner_join(., diff_results_d12diff, by= c("Reference","Gene.Symbol"))

library(ggpubr)

ggplot(atg12_effectOnly,aes(d12tod0,atg12_effect))+geom_point()+
  geom_label_repel(data=atg12_effectOnly%>%filter(d12tod0 > log2(1.5) | d12tod0<(-log2(1.5)))%>%filter(atg12_effect>log2(1.5)),aes(d12tod0,atg12_effect,label=Gene.Symbol), box.padding = 1,max.overlaps = Inf)+
  geom_label_repel(data=atg12_effectOnly%>%filter(Gene.Symbol %in% c("REEP1","REEP2","REEP3","REEP4","REEP5","RTN1","RTN2","RTN3")),aes(d12tod0,atg12_effect,label=Gene.Symbol), box.padding = 1,max.overlaps = Inf)+
  geom_abline(linetype="dashed")+
  geom_hline(yintercept = 0,linetype="dashed")+
  geom_vline(xintercept = 0,linetype="dashed")+
  xlim(c(-3,4))+ylim(c(-3,4))+
  theme_classic()+
  stat_cor()
  
  
```



### GO terms ATG12


```{r}
goinput_start<-read.csv("C:/Harper/Side_analysis/Kelsey_shiny/Golgiphagy_final/PaperCode/human_mouse_go.csv")%>%
  dplyr::mutate(GO=dplyr::if_else(stringr::str_sub(GO,1,1)==" ",stringr::str_sub(GO,2,-1),GO))%>%
  dplyr::filter(GO != "")

go.df <- goinput_start%>%
      dplyr::filter(organism == "human")%>%
      dplyr::select(-organism)



filt_ttest2<-d12_plexa%>%
    dplyr::ungroup()%>%
    dplyr::mutate(set = dplyr::if_else(log2FC_ATG12d12.WTd12> 0, dplyr::if_else(q.val_ATG12d12.WTd12 < 0.05,"sig","n.s."),"n.s."))%>%
    tidyr::separate(Reference,into = c("type","Reference","Description"),sep="\\|")%>%
    dplyr::select(Reference,set)

  
  
  
df.bg <- filt_ttest2 %>% 
  dplyr::distinct(Reference) %>% 
  dplyr::left_join(go.df) %>% 
  dplyr::mutate(all = dplyr::n_distinct(Reference)) %>% 
  dplyr::group_by(GO,GO_cat) %>% 
  dplyr::summarise("pos" = dplyr::n_distinct(Reference),
            "neg" = all - pos) %>% 
  dplyr::distinct() %>% 
  dplyr::mutate(selection="background") %>% 
  dplyr::ungroup()


go.df <- df.bg %>%
  dplyr::select(GO,GO_cat) %>%
  dplyr::left_join(go.df)


df.fg <- filt_ttest2 %>%  
  dplyr::mutate(selection = "foreground") %>% 
  dplyr::distinct(Reference, selection, set) %>% 
  dplyr::right_join(go.df) %>% 
  dplyr::group_by(selection, set) %>% 
  dplyr::mutate(term_all = dplyr::n_distinct(Reference)) %>% 
  dplyr::group_by(GO,GO_cat, selection, set) %>% 
  dplyr::summarise("pos" = dplyr::n_distinct(Reference),
            "neg" = term_all - pos) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(set == "sig")%>%
  dplyr::distinct()

df.nest <- df.bg %>% dplyr::left_join(df.fg %>% dplyr::distinct(GO,GO_cat, set)) %>% 
  dplyr::distinct() %>% 
  dplyr::full_join(df.fg) %>% 
  tidyr::drop_na(set) %>% 
  tidyr::drop_na(GO) %>% 
  dplyr::distinct() %>% 
  dplyr::group_by(GO,GO_cat, set) %>% 
  tidyr::nest() 


exact_pval_fun<-function(data){
  dataframe<-data.frame(data) %>%
    tibble::column_to_rownames(var = "selection")
  matrix<-as.matrix(dataframe) 
  exact_test_result<-fisher.test(matrix, alternative = "two.sided")
  return(exact_test_result$p.value)
}

## function to perform fisher test and get enrichment
enrich_fun<-function(data){
  dataframe<-data.frame(data) %>% 
    dplyr::mutate(frac = pos/neg) %>% 
    dplyr::select(-c(pos,neg)) %>% 
    tidyr::pivot_wider(names_from = selection, values_from = frac) %>% 
    dplyr::summarise(enrichment = foreground/background) 
  
  return(dataframe$enrichment[1])
}


fish.df <- df.nest %>% 
  dplyr::mutate(p.val = data %>% purrr::map_dbl(exact_pval_fun)) %>% #calc p val
  dplyr::mutate(enrich = data %>% purrr::map_dbl(enrich_fun)) %>%   #calc enrichment
  dplyr::select(-c(data)) %>%
  dplyr::filter(GO != "")%>%
  dplyr::arrange(p.val)
# print("fifth")


fish.df$p.val.adj <- p.adjust(fish.df$p.val,method="fdr")

fish.df<-fish.df%>%
  dplyr::arrange(p.val.adj)%>%    
  tibble::rownames_to_column("GORank")%>%
  dplyr::mutate(GORank=as.numeric(as.character(GORank)))


fish.df.sig_atg12<-fish.df%>%
  dplyr::mutate(sig_GO = dplyr::if_else(p.val.adj<0.05,"sig","n.s."))%>%
  dplyr::mutate(GO_id = stringr::str_sub(GO,-11,-2),
         GO_shrink1 = stringr::str_sub(GO,1,-13),
         GO_shrink = stringr::str_sub(GO_shrink1,1,70))

fish.df.sig_atg12$GO_cat <- factor(fish.df.sig_atg12$GO_cat, levels = c("molecular_function","cellular_component","biological_process"))
  
  

ggplot()+geom_point(data=fish.df.sig_atg12%>%filter(sig_GO != "sig"),  aes(log2(enrich), -log10(p.val.adj)),color="grey50",alpha=0.75)+
  theme_classic()+
  geom_point(data=fish.df.sig_atg12%>%filter(sig_GO == "sig"),  aes(log2(enrich), -log10(p.val.adj),color=GO_cat),alpha=0.75)+
    geom_hline(yintercept = -log10(0.05))+scale_color_viridis_d(end=0.8)+
    theme(axis.title = element_text(size=20),axis.text = element_text(size = 18))+
  geom_label_repel(data=fish.df.sig_atg12%>%filter(sig_GO == "sig"),  aes(log2(enrich), -log10(p.val.adj), color=GO_cat,label=GO_shrink),box.padding = 1,max.overlaps = Inf,size=3)+ 
    labs(x="Enrichment", y="-log10(q-value)",title="Up Regulated in ATG12 KO")
```



### Linear Model code

#### Build contrast matrix

```{r}
sample_list<-unique(norm_d12_plex$sample)

sample_list<-str_remove_all(sample_list,"d12")
# sample_list<-str_sub(sample_list,start = 1,end=-3)
# sample_list<-uni

contrast_matrix<-data.frame("sample" = sample_list,
                            # "WT" =      c(0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0),
                            # "ATG12" =    c(0,0,0, 1,1,1, 0,0,0, 0,0,0, 0,0,0),
                            # "FAM134C" =             c( 1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1),
                            "FAM134AC" =            c( 0,0,0, 1,1,1, 1,1,1, 1,1,1, 1,1,1),
                            "FAM134ABC"=            c( 0,0,0, 0,0,0, 1,1,1, 1,1,1, 1,1,1),
                            "FAM134ABCTEX"=        c( 0,0,0, 0,0,0, 0,0,0, 1,1,1, 1,1,1),
                            "FAM134ABCTEXCCPG1"=  c( 0,0,0, 0,0,0, 0,0,0, 0,0,0, 1,1,1)
                            
                    )%>%
  mutate(samp = str_sub(sample,1,-3))




```



#### perform test

```{r}
combine_df_complete<-norm_d12_plex %>%
  group_by(Reference,Gene.Symbol,Annotation,sample,log2_int_wtd0_norm)%>%
  mutate(sample = str_remove(sample,"d12"))%>%
  # gather("sample","intensity", 4:34)%>%
  left_join(.,contrast_matrix,by="sample")

combine_df_complete$samp <- factor(combine_df_complete$samp , levels= c("WT","CA" , "CAB" , "CABTEX" , "CABTEXCCPG1"))


nest_df<-combine_df_complete%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  nest()

linear_fit_fun <- function(data){
  input<-data.frame(data)
  model<-lm(data=input,log2_int_wtd0_norm ~   FAM134AC + FAM134ABC + FAM134ABCTEX + FAM134ABCTEXCCPG1)
  summary(model)
  lm_results<-data.frame(coeff = summary(model)$coefficients[1:5,1],p.value = summary(model)$coefficients[1:5,4])%>%
    rownames_to_column("Contrast")%>%
    mutate(Contrast = as.character(Contrast))
  return(lm_results) 
}


nest_df2<-nest_df%>%
  mutate(lm_results = data %>% map(linear_fit_fun))

convert_long<-function(lm_results){
  df<-data.frame(lm_results)
  df_all<-df%>%
    pivot_wider( 
            names_from = Contrast, 
            values_from = c(coeff,p.value ))
  return(df_all)
}

nest_df3<-nest_df2%>%
  mutate(results= lm_results %>% map(convert_long))%>%
  unnest(results)%>%
  select(-data, -lm_results)%>%
  distinct()






nest_df3$q.value_FAM134AC <- p.adjust(nest_df3$p.value_FAM134AC,method="fdr")
nest_df3$q.value_FAM134ABC <- p.adjust(nest_df3$p.value_FAM134ABC,method="fdr")
nest_df3$q.value_FAM134ABCTEX <- p.adjust(nest_df3$p.value_FAM134ABCTEX,method="fdr")
nest_df3$q.value_FAM134ABCTEXCCPG1 <- p.adjust(nest_df3$p.value_FAM134ABCTEXCCPG1,method="fdr")

nest_df4<-nest_df3%>%
  arrange(coeff_FAM134ABCTEXCCPG1)


nest_df4_tidy_coef<-nest_df4%>%
  unite("ProtID",c(Reference,Gene.Symbol,Annotation), sep="__X__")%>%
  select(ProtID,coeff_FAM134AC,coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1)%>%
  group_by(ProtID)%>%
  gather("coeff_CellLine","value",2:5)

nest_df4_ann<-nest_df4%>%
  left_join(.,organelle_input_er_simple, by="Gene.Symbol")


## Volcanoes based on the betas

# ggplot(nest_df4_ann, aes(coeff_FAM134AC,-log10(q.value_FAM134AC),color=Compartment_ss ))+
#   geom_point(size=0.5,alpha=0.5)+
#   facet_wrap(.~Compartment_ss)+
#   geom_hline(yintercept = -log10(0.05), linetype="dashed")+
#   geom_vline(xintercept = 0,linetype="dashed")+
#   theme_classic()+xlim(c(-1.5,1.5))
# 
# ggplot(nest_df4_ann, aes(coeff_FAM134ABC,-log10(q.value_FAM134ABC),color=Compartment_ss ))+
#   geom_point(size=0.5,alpha=0.5)+
#   facet_wrap(.~Compartment_ss)+
#   geom_hline(yintercept = -log10(0.05), linetype="dashed")+
#   geom_vline(xintercept = 0, linetype="dashed")+
#   theme_classic()

# ggplot(nest_df4_ann, aes(coeff_FAM134ABCTEX,-log10(q.value_FAM134ABCTEX),color=Compartment_ss ))+
#   geom_point(size=0.5,alpha=0.5)+
#   facet_wrap(.~Compartment_ss)+
#   geom_hline(yintercept = -log10(0.05), linetype="dashed")+
#   geom_vline(xintercept = 0,linetype="dashed")+
#   theme_classic()
# 
# ggplot(nest_df4_ann, aes(coeff_FAM134ABCTEXCCPG1,-log10(q.value_FAM134ABCTEXCCPG1),color=Compartment_ss ))+
#   geom_point(size=0.5,alpha=0.5)+
#   facet_wrap(.~Compartment_ss)+
#   geom_hline(yintercept = -log10(0.05), linetype="dashed")+
#   geom_vline(xintercept = 0,linetype="dashed")+
#   theme_classic()



### er only
# 
# p1<-ggplot(nest_df4_ann%>%filter(Compartment_ss == "ER"), aes(coeff_FAM134AC,-log10(q.value_FAM134AC),color=Compartment_ss ))+
#   geom_point(size=0.7,alpha=0.5)+
#   facet_wrap(.~Compartment_ss)+
#   geom_hline(yintercept = -log10(0.05), linetype="dashed")+
#   geom_vline(xintercept = 0,linetype="dashed")+
#   theme_classic()+ylim(c(0,4))+xlim(c(-2.8,2.8))

# p2<-ggplot(nest_df4_ann%>%filter(Compartment_ss == "ER"), aes(coeff_FAM134ABC,-log10(q.value_FAM134ABC),color=Compartment_ss ))+
#   geom_point(size=0.7,alpha=0.5)+
#   facet_wrap(.~Compartment_ss)+
#   geom_hline(yintercept = -log10(0.05), linetype="dashed")+
#   geom_vline(xintercept = 0,linetype="dashed")+
#   theme_classic()+ylim(c(0,4))+xlim(c(-2.8,2.8))
# 
# p3<-ggplot(nest_df4_ann%>%filter(Compartment_ss == "ER"), aes(coeff_FAM134ABCTEX,-log10(q.value_FAM134ABCTEX),color=Compartment_ss ))+
#   geom_point(size=0.7,alpha=0.5)+
#   facet_wrap(.~Compartment_ss)+
#   geom_hline(yintercept = -log10(0.05), linetype="dashed")+
#   geom_vline(xintercept = 0,linetype="dashed")+
#   theme_classic()+ylim(c(0,4))+xlim(c(-2.8,2.8))

# p4<-ggplot(nest_df4_ann%>%filter(Compartment_ss == "ER"), aes(coeff_FAM134ABCTEXCCPG1,-log10(q.value_FAM134ABCTEXCCPG1),color=Compartment_ss ))+
#   geom_point(size=0.7,alpha=0.5)+
#   facet_wrap(.~Compartment_ss)+
#   geom_hline(yintercept = -log10(0.05), linetype="dashed")+
#   geom_vline(xintercept = 0,linetype="dashed")+
#   theme_classic()+ylim(c(0,4))+xlim(c(-2.8,2.8))
# 
# plot_grid(p1,p2,p3,p4, nrow = 1)

### er sub

nest_df4_ann2<-nest_df4%>%
  left_join(.,organelle_input_er_split, by="Gene.Symbol")

# p1<-ggplot(nest_df4_ann2%>%filter(Compartment_ss %in% c("ER.high.curvature","ER.Lumen","ER.Membrane.associated","ER.Membrane","ER.high.sheet")), aes(coeff_FAM134AC,-log10(q.value_FAM134AC),color=Compartment_ss ))+
#   geom_point(size=0.7,alpha=0.5)+
#   facet_wrap(.~Compartment_ss)+
#   geom_hline(yintercept = -log10(0.05), linetype="dashed")+
#   geom_vline(xintercept = 0,linetype="dashed")+
#   theme_classic()+ylim(c(0,4))+xlim(c(-2.8,2.8))
# 
# p2<-ggplot(nest_df4_ann2%>%filter(Compartment_ss %in% c("ER.high.curvature","ER.Lumen","ER.Membrane.associated","ER.Membrane","ER.high.sheet")), aes(coeff_FAM134ABC,-log10(q.value_FAM134ABC),color=Compartment_ss ))+
#   geom_point(size=0.7,alpha=0.5)+
#   facet_wrap(.~Compartment_ss)+
#   geom_hline(yintercept = -log10(0.05), linetype="dashed")+
#   geom_vline(xintercept = 0,linetype="dashed")+
#   theme_classic()+ylim(c(0,4))+xlim(c(-2.8,2.8))

# p3<-ggplot(nest_df4_ann2%>%filter(Compartment_ss %in% c("ER.high.curvature","ER.Lumen","ER.Membrane.associated","ER.Membrane","ER.high.sheet")), aes(coeff_FAM134ABCTEX,-log10(q.value_FAM134ABCTEX),color=Compartment_ss ))+
#   geom_point(size=0.7,alpha=0.5)+
#   facet_wrap(.~Compartment_ss)+
#   geom_hline(yintercept = -log10(0.05), linetype="dashed")+
#   geom_vline(xintercept = 0,linetype="dashed")+
#   theme_classic()+ylim(c(0,4))+xlim(c(-2.8,2.8))
# 
# p4<-ggplot(nest_df4_ann2%>%filter(Compartment_ss %in% c("ER.high.curvature","ER.Lumen","ER.Membrane.associated","ER.Membrane","ER.high.sheet")), aes(coeff_FAM134ABCTEXCCPG1,-log10(q.value_FAM134ABCTEXCCPG1),color=Compartment_ss ))+
#   geom_point(size=0.7,alpha=0.5)+
#   facet_wrap(.~Compartment_ss)+
#   geom_hline(yintercept = -log10(0.05), linetype="dashed")+
#   geom_vline(xintercept = 0,linetype="dashed")+
#   theme_classic()+ylim(c(0,4))+xlim(c(-2.8,2.8))
# 
# plot_grid(p1,p2,p3,p4, nrow = 1)

```



#### coeff by compartment

```{r}

linear_results <- nest_df4_ann2%>%
  select(Reference, Gene.Symbol, Annotation, coeff_FAM134AC, coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1, q.value_FAM134AC,q.value_FAM134ABC,q.value_FAM134ABCTEX,q.value_FAM134ABCTEXCCPG1)%>%
  distinct()%>%
  group_by(Reference, Gene.Symbol, Annotation)%>%
  pivot_longer(cols = 4:11,
               names_to = c("val_type","condition"),
               names_sep = "_")%>%
  group_by(Reference, Gene.Symbol, Annotation)%>%
  pivot_wider( 
            # id_cols = Contrast, 
            names_from = val_type, 
            values_from = value)%>%
  left_join(.,organelle_input_er_split, by="Gene.Symbol")%>%
  mutate(sig = if_else(q.value < 0.05,if_else(coeff > 0 , "up","down"),"n.s."))%>%
  mutate(Compartment_ss=str_replace_all(Compartment_ss,"\\."," "))


linear_results$condition <- factor(linear_results$condition,levels= c("FAM134AC","FAM134ABC" , "FAM134ABCTEX","FAM134ABCTEXCCPG1"))

up_down<-linear_results%>%filter( q.value < 0.05 )

violin_betas<-ggplot(linear_results %>%filter(Compartment_ss %in% c("Golgi","Lysosome","Mitochondria","Plasma Membrane","Endosome","Peroxisome",
                                                     "Nucleus","Cytosol","ER" )), aes(condition,coeff,fill=condition))+
  geom_violin(draw_quantiles = c(0.25,.5,.75),alpha=0.8)+
  facet_wrap(.~Compartment_ss)+ylim(c(-1,1))+theme_classic()+
  scale_fill_manual(values = c("#5ec962","#21918c","#3b528b","#440154"))+
  geom_hline(yintercept = 0,linetype="dashed")+
  labs(y=bquote(""~beta[KO]~": Log2FC(additive KO)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "bottom",
        axis.title = element_text(size=18),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))
violin_betas

# ggsave(plot = violin_betas, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/supfig4_KO_accum_AllOrganelles_violin_LinearModelBetas.pdf", height = 12,width=14)




## ER only



er_violin_betas<-ggplot(linear_results %>%filter(Compartment_ss %in% c("ER","ER Membrane", "ER Lumen", "ER Membrane associated" )), aes("",coeff,fill=condition,color=condition))+
  geom_violin(draw_quantiles = c(0.25,.5,.75),alpha=0.8,color="black")+
  facet_wrap(.~Compartment_ss,nrow=1)+ylim(c(-1,1))+theme_classic()+
  geom_point(position=position_jitterdodge(dodge.width = 0.9),size=0.75,alpha=0.25)+
  geom_hline(yintercept = 0,linetype="dashed")+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "bottom",
        axis.title = element_text(size=18),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))+
  scale_fill_manual(values = c("#5ec962","#21918c","#3b528b","#440154"))+
  scale_color_manual(values = c("#5ec962","#21918c","#3b528b","#440154"))+
  guides(fill = guide_legend(nrow = 1))+
  labs(y=bquote(""~beta[KO]~": Log2FC(additive KO)"))
  

er_violin_betas
# ggsave(plot = er_violin_betas, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4f_KO_accum_ERonly_violin_LinearModelBetas.pdf", height = 6,width=12)

```



#### heatmap ER high curve Accum

heat map of only high curvature and high sheet normalized to mean wt value


```{r}
### same as above but with ATG12
norm_d12_plex2<-left_join(d12_plexa_slim,wt_Only_d12_plexa_slim, by=c("Reference","Gene.Symbol","Annotation") )%>%
  dplyr::mutate(log2_int_wtd0_norm = log2_int - mean_wt0)

norm_d12_plex2<-norm_d12_plex2%>%
  mutate(sample = str_remove(sample,"d12"))

norm_d12_plex2$sample <- factor(norm_d12_plex2$sample,
                                levels = c("WT_1","WT_2","WT_3",
                                           "ATG12_1","ATG12_2","ATG12_3",
                                           "CA_1","CA_2","CA_3",
                                           "CAB_1","CAB_2","CAB_3",
                                           "CABTEX_1","CABTEX_2","CABTEX_3",
                                           "CABTEXCCPG1_1","CABTEXCCPG1_2","CABTEXCCPG1_3"))


er_raw_accum<-norm_d12_plex2%>%
  inner_join(.,high,by="Gene.Symbol")%>%
  # left_join(.,organelle_input_er_split,by="Gene.Symbol")%>%
  # filter(str_detect(Compartment_ss,"ER")==T)%>%
  # filter(Compartment_ss != "ER")%>%
  # filter(Compartment_ss != 'Peroxisome')%>%
  # filter(Compartment_ss == "ER.high.curvature"| Compartment_ss == "ER.high.sheet")%>%
  group_by(Gene.Symbol)%>%
  mutate(counts=n(),
         Compartment=Compartment_ss)%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  select(-type,-desc)%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-log2_int,-cellLine,-mean_wt0, -counts,-Annotation,-Compartment)%>%
  group_by(ProtID, Compartment_ss)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  arrange(Compartment_ss)%>%
  mutate(Compartment_ss =str_replace_all(Compartment_ss,"\\."," "))




all_dataB_heatmap2 <- er_raw_accum %>%
  ungroup()%>%
  select(-Compartment_ss)%>%
  column_to_rownames(var="ProtID")

annotation_allB2<-er_raw_accum %>%
  select(ProtID, Compartment_ss)

df_col_ann2 <- data.frame("sample"= colnames(er_raw_accum)[3:20], values = c("WT","WT","WT",
                                           "ATG12","ATG12","ATG12",
                                           "CA","CA","CA",
                                           "CAB","CAB","CAB",
                                           "CABTEX","CABTEX","CABTEX",
                                           "CABTEXCCPG1","CABTEXCCPG1","CABTEXCCPG1"))

annoB<-data.frame(row.names=annotation_allB2$ProtID, Annotation=annotation_allB2$Compartment_ss)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann2$sample, Condition=df_col_ann2$values)

# annoD$Condition<-factor(annoD$Condition, values=c("WT","ATG12","CCPG1","TEX264","FAM134A","FAM134B","FAM134C"))

# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 1, length.out=floor(paletteLength/2)))

# test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


rownames(annoD) <- colnames(all_dataB_heatmap2)

test<-pheatmap(all_dataB_heatmap2, cluster_cols = F,  annotation_row = annoB,annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)

# ggsave(plot = test, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4b_Accum_heatmap_ERhc_ERhs.pdf", height = 4.5,width=7.5)

```


#### heatmap Luminal ER

heat map of only high curvature and high sheet normalized to mean wt value


```{r}

luminal_rank_list<-nest_df4_ann2%>%
  select(Reference,Gene.Symbol,Annotation,coeff_FAM134ABCTEXCCPG1,Compartment_ss)%>%
  filter(Compartment_ss == "ER.Lumen")%>%
  arrange(desc(coeff_FAM134ABCTEXCCPG1))%>%
  rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-type,-desc,-Annotation,-coeff_FAM134ABCTEXCCPG1,-Compartment_ss)

er_raw_accum_lumen<-norm_d12_plex2%>%
  group_by(Gene.Symbol)%>%
  mutate(counts=n())%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  select(-type,-desc)%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-log2_int,-cellLine,-mean_wt0, -counts,-Annotation)%>%
  group_by(ProtID)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  inner_join(.,luminal_rank_list,by="ProtID")%>%
  arrange(Rank)%>%
  select(-Rank)%>%
  select(1,5:7,17:19)




all_dataB_heatmap2 <- er_raw_accum_lumen %>%
  ungroup()%>%
  # select(-Compartment_ss)%>%
  column_to_rownames(var="ProtID")

annotation_allB2<-er_raw_accum_lumen %>%
  select(ProtID)

df_col_ann2 <- data.frame("sample"= colnames(er_raw_accum_lumen)[2:7], values = c(
  # "WT","WT","WT",
                                           "ATG12","ATG12","ATG12",
                                           # "CA","CA","CA",
                                           # "CAB","CAB","CAB",
                                           # "CABTEX","CABTEX","CABTEX",
                                           "CABTEXCCPG1","CABTEXCCPG1","CABTEXCCPG1"))

annoB<-data.frame(row.names=annotation_allB2$ProtID)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann2$sample, Condition=df_col_ann2$values)

# annoD$Condition<-factor(annoD$Condition, values=c("WT","ATG12","CCPG1","TEX264","FAM134A","FAM134B","FAM134C"))

# creat colours for each group
# newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 1, length.out=floor(paletteLength/2)))

# test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


rownames(annoD) <- colnames(all_dataB_heatmap2)

test<-pheatmap(all_dataB_heatmap2, cluster_cols = F,  annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)

# ggsave(plot = test, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4b_Accum_heatmap_ERhc_ERhs.pdf", height = 4.5,width=7.5)

```


#### Luminal Coef 


```{r}

luminal_rank_list2<-nest_df4_ann2%>%
  select(Reference,Gene.Symbol,Annotation,coeff_FAM134ABCTEXCCPG1,Compartment_ss)%>%
  filter(Compartment_ss == "ER.Lumen")%>%
  arrange(desc(coeff_FAM134ABCTEXCCPG1))%>%
  rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-type,-desc,-Annotation,-Compartment_ss,-Rank)


all_dataB_heatmap4 <- luminal_rank_list2 %>%
  ungroup()%>%
  # select(-Compartment_ss, -Gene)%>%
  column_to_rownames(var="ProtID")


library(RColorBrewer)


paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 1, length.out=floor(paletteLength/2)))

# test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


# rownames(annoD) <- colnames(all_dataB_heatmap3)

test<-pheatmap(all_dataB_heatmap4, cluster_cols = F, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)
#annotation = annoD, 
# ggsave(plot = test, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4X_Accum_heatmap_ERhc_ERhs_LinearModelBetas.pdf", height = 4.5,width=5)

```

#### Combine beta and fold change


```{r}
luminal_input<-left_join(er_raw_accum_lumen,luminal_rank_list2,by ="ProtID")


all_dataB_heatmap7 <- luminal_input %>%
  rename(CCPG1_1 = CABTEXCCPG1_1,
         CCPG1_2 = CABTEXCCPG1_2,
         CCPG1_3 = CABTEXCCPG1_3,
         Beta_PKO = coeff_FAM134ABCTEXCCPG1
         )%>%
  ungroup()%>%
  # select(-Compartment_ss)%>%
  column_to_rownames(var="ProtID")
# 
# annotation_allB2<-er_raw_accum_lumen %>%
#   select(ProtID)

df_col_ann7 <- data.frame("sample"= colnames(luminal_input)[2:8], values = c(
  # "WT","WT","WT",
                                           "ATG12","ATG12","ATG12",
                                           # "CA","CA","CA",
                                           # "CAB","CAB","CAB",
                                           # "CABTEX","CABTEX","CABTEX",
                                           "CCPG1","CCPG1","CCPG1",
                                           "Beta CCPG1"))

# annoB<-data.frame(row.names=annotation_allB2$ProtID)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann7$sample, Condition=df_col_ann7$values)

annoD$Condition <- factor(annoD$Condition, levels=c("ATG12","CCPG1","Beta CCPG1"))

paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-.75, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, .75, length.out=floor(paletteLength/2)))

# test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


rownames(annoD) <- colnames(all_dataB_heatmap7)

test<-pheatmap(all_dataB_heatmap7, cluster_cols = F,  annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


# ggsave(plot = test, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/supfig_ccpg1_heatmap_ERlumen.pdf", height = 13,width=4.5)
```

#### Export data

```{r}
accum_df_full<-full_join(d12_plexa,nest_df4,by=c("Reference","Gene.Symbol","Annotation"))%>%
  left_join(.,organelle_input_er_simple,by="Gene.Symbol")%>%
  distinct()


# accum_df_full_dup <- accum_df_full%>%
#   group_by(Reference,Gene.Symbol,Annotation)%>%
#   mutate(counts=n())%>%
#   select(Reference,Gene.Symbol,Annotation, Compartment_ss,counts)%>%
#   filter(counts==2)


accum_df_full_erOnly<-full_join(d12_plexa,nest_df4,by=c("Reference","Gene.Symbol","Annotation"))%>%
  left_join(.,organelle_input_er_split,by="Gene.Symbol")%>%
  distinct()%>%
  filter(Compartment_ss %in% c("ER.Lumen","ER.Membrane","ER.Membrane.associated","ER.high.curvature","ER.Receptors","ER.high.sheet"))


write.csv(accum_df_full_erOnly, "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/SuppData_accumKO_erOnly.csv")

write.csv(accum_df_full, "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/SuppData_accumKO_allData.csv")

```


#### heatmap singles Luminal ER

heat map of only high curvature and high sheet normalized to mean wt value


```{r}


singles_norm_annot<-singles_norm%>%
  select(Reference,Gene.Symbol,Annotation,sample,log2_int_wtd0_norm)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  left_join(.,organelle_input_er_split,by="Gene.Symbol")%>%
  filter(Compartment_ss == "ER.Lumen")%>%
  select(-Compartment_ss)%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-type,-desc,-Annotation)%>%
  inner_join(.,luminal_rank_list,by="ProtID")%>%
  arrange(Rank)%>%
  select(-Rank)%>%
  select(1,8:10)




all_dataB_heatmap2 <- singles_norm_annot %>%
  ungroup()%>%
  # select(-Compartment_ss)%>%
  column_to_rownames(var="ProtID")

annotation_allB2<-singles_norm_annot %>%
  select(ProtID)

df_col_ann2 <- data.frame("sample"= colnames(singles_norm_annot)[2:4], values = c(
  # "WT_1","WT_2","WT_3",
  #                                                                                  "ATG12_1","ATG12_2","ATG12_3",
                                                                                   "CCPG1_1","CCPG1_2","CCPG1_3"
                                                                                   # ,
                                                                                   # "TEX264_1","TEX264_2","TEX264_3",
                                                                                   # "FAM134A_1","FAM134A_2",
                                                                                   # "FAM134B_1","FAM134B_2",
                                                                                   # "FAM134C_1","FAM134C_2"
                                                                                   ))

annoB<-data.frame(row.names=annotation_allB2$ProtID)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann2$sample, Condition=df_col_ann2$values)%>%
  mutate(Condition = str_sub(Condition,1,-3))

# annoD$Condition<-factor(annoD$Condition, values=c("WT","ATG12","CCPG1","TEX264","FAM134A","FAM134B","FAM134C"))

# creat colours for each group
# newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
# annoCol <- newCols(length(unique(annoB$Annotation)))
# names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-.75, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, .75, length.out=floor(paletteLength/2)))

# test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


rownames(annoD) <- colnames(all_dataB_heatmap2)

test2<-pheatmap(all_dataB_heatmap2, cluster_cols = F,  annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)



# ggsave(test2, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/supfig_ccpg1_heatmap_ERlumen_singles.pdf", height = 13,width=3.5)

```




#### heatmap autophagy logFC

heat map of only high curvature and high sheet normalized to mean wt value


```{r}

list_autophagy <- c(
  "ACBD5","AMBRA1","ATG10","ATG101","ATG12",
  "ATG13","ATG14","ATG16L1","ATG2A","ATG2B",
  "ATG3","ATG4A","ATG4B","ATG4C","ATG5",
  "ATG7","ATG9A","BAG3","BCL2L13","BECN1",
  "BNIP3L","CALCOCO2","CCPG1","CDK5RAP3","CHMP2B",
  "CHMP4B","EGFR","EIF4G1","ERBB2","FUNDC1",
  "FYCO1","GABARAP","GABARAPL2","GOPC","HDAC6",
  "HGS","HIF1A","HSPA8","ITGB1","LGALS3",
  "LGALS8","MAP1LC3A","MAP1LC3B","MTOR","NBR1",
  "NCOA4","NLRX1","OPTN","PEX13","PEX14",
  "PEX3","PEX5","PIK3C3","PIK3R4","PINK1",
  "PLEKHM1","PRKN","PTEN","RAB11A","RAB1A",
  "RAB24","RAB33B","RAB5A","RAB7A","RAC1",
  "RB1CC1","RETREG1","RPTOR","RUBCN","SH3GLB1",
  "SIRT1","SIRT2","SQSTM1","STBD1","STK11",
  "STX17","TAX1BP1","TBK1","TEX264","TM9SF1",
  "TOLLIP","TRIM5","TSC2","ULK1","ULK2",
  "UVRAG","WDFY3","WDR45","WDR45B","WIPI1",
  "WIPI2","ZFYVE1")

norm_d12_plex2<-norm_d12_plex2%>%
  mutate(sample = str_remove(sample,"d12"))

norm_d12_plex2$sample <- factor(norm_d12_plex2$sample,
                                levels = c("WT_1","WT_2","WT_3",
                                           "ATG12_1","ATG12_2","ATG12_3",
                                           "CA_1","CA_2","CA_3",
                                           "CAB_1","CAB_2","CAB_3",
                                           "CABTEX_1","CABTEX_2","CABTEX_3",
                                           "CABTEXCCPG1_1","CABTEXCCPG1_2","CABTEXCCPG1_3"))


er_raw_accum<-norm_d12_plex2%>%
  left_join(.,organelle_input_er_simple,by="Gene.Symbol")%>%
  filter(Gene.Symbol %in% list_autophagy)%>%
  filter(Gene.Symbol != "CDK5RAP3")%>%
  # filter(str_detect(Compartment_ss,"ER")==T)%>%
  # filter(Compartment_ss != "ER")%>%
  # filter(Compartment_ss != 'Peroxisome')%>%
  # filter(Compartment_ss == "ER.high.curvature"| Compartment_ss == "ER.high.sheet")%>%
  group_by(Gene.Symbol)%>%
  mutate(counts=n(),
         Compartment=Compartment_ss)%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  select(-type,-desc)%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-log2_int,-cellLine,-mean_wt0, -counts,-Annotation,-Compartment)%>%
  group_by(ProtID, Compartment_ss)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  arrange(Compartment_ss, desc(ATG12_3))%>%
  mutate(Compartment_ss =str_replace_all(Compartment_ss,"\\."," "))




all_dataB_heatmap2 <- er_raw_accum %>%
  ungroup()%>%
  select(-Compartment_ss)%>%
  column_to_rownames(var="ProtID")

annotation_allB2<-er_raw_accum %>%
  select(ProtID, Compartment_ss)

df_col_ann2 <- data.frame("sample"= colnames(er_raw_accum)[3:20], values = c("WT","WT","WT",
                                           "ATG12","ATG12","ATG12",
                                           "CA","CA","CA",
                                           "CAB","CAB","CAB",
                                           "CABTEX","CABTEX","CABTEX",
                                           "CABTEXCCPG1","CABTEXCCPG1","CABTEXCCPG1"))

annoB<-data.frame(row.names=annotation_allB2$ProtID, Annotation=annotation_allB2$Compartment_ss)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann2$sample, Condition=df_col_ann2$values)

# annoD$Condition<-factor(annoD$Condition, values=c("WT","ATG12","CCPG1","TEX264","FAM134A","FAM134B","FAM134C"))

# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-0.5, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 0.5, length.out=floor(paletteLength/2)))

# test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


rownames(annoD) <- colnames(all_dataB_heatmap2)

test<-pheatmap(all_dataB_heatmap2, cluster_cols = F,  annotation_row = annoB,annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)

# ggsave(plot = test, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/Extra_Accum_heatmap_Aut0phagy_heatmap.pdf", height = 11,width=7.5)

```


### Rank plots 

#### Rank plot AC

```{r}
high_curve_proteins <- organelle_input_er_split%>%
  filter(Compartment_ss == "ER.high.curvature")


# limit_hc<-nest_df4_ann2%>%filter(Gene.Symbol %in% high_curve_proteins$Gene.Symbol)

er_ac<-nest_df4_ann2%>%
  dplyr::filter(Compartment_ss %in% c("ER.Membrane","ER.Lumen","ER.Membrane.associated","ER.high.curvature") , Gene.Symbol != "FAM134A" )%>%
  # mutate(Compartment_ss = if_else(Compartment_ss == "ER.high.curvature","ER.Membrane",Compartment_ss))%>%
  arrange(desc(coeff_FAM134AC))%>%
  tibble::rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))


er_ac$Compartment_ss <- factor(er_ac$Compartment_ss, levels = c("ER.Lumen","ER.high.curvature","ER.Membrane","ER.Membrane.associated"))



er_ac2<-nest_df4_ann2%>%
  dplyr::filter(Compartment_ss %in% c("ER.Membrane","ER.Lumen","ER.Membrane.associated","ER.high.curvature") , Gene.Symbol != "FAM134A")%>%
  # mutate(Compartment_ss = if_else(Compartment_ss == "ER.high.curvature","ER.Membrane",Compartment_ss))%>%
  arrange(desc(coeff_FAM134ABCTEXCCPG1))%>%
  tibble::rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))

er_ac2$Compartment_ss <- factor(er_ac2$Compartment_ss, levels = c("ER.Lumen","ER.high.curvature","ER.Membrane","ER.Membrane.associated"))

ggplot()+
  geom_point(data = er_ac, aes(Rank, coeff_FAM134AC,color=Compartment_ss),size=1,alpha=0.5)+
  geom_text_repel(data = er_ac%>%filter(Rank  < 26), aes(Rank, coeff_FAM134AC,color=Compartment_ss,label=Gene.Symbol),box.padding = 1,max.overlaps = Inf,show.legend = F)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+
  theme(axis.title = element_text(size=16),
        axis.text = element_text(size=14),
        legend.position = "top")+
  scale_color_viridis_d(end=0.8,direction=-1)+
  labs(y=bquote(""~beta[FAM134A/C]~""),color="")+xlim(c(0,25.5))






ggplot()+
  geom_point(data = er_ac2, aes(Rank, coeff_FAM134ABCTEXCCPG1,color=Compartment_ss),size=1,alpha=0.5)+
  geom_text_repel(data = er_ac2%>%filter(Rank  < 26), aes(Rank, coeff_FAM134ABCTEXCCPG1,color=Compartment_ss,label=Gene.Symbol),box.padding = 1,max.overlaps = Inf,show.legend = F)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+
  theme(axis.title = element_text(size=16),
        axis.text = element_text(size=14),
        legend.position = "top")+
  scale_color_viridis_d(end=0.8,direction=-1)+
  labs(y=bquote(""~beta[PKO]~""),color="")+xlim(c(0,25.5))


ggplot()+
  geom_point(data = er_ac2%>%filter( Rank >25), aes(Rank, coeff_FAM134ABCTEXCCPG1,color=Compartment_ss),size=0.25,alpha=0.5,color="grey")+
  geom_point(data = er_ac2%>%filter(Compartment_ss =="ER.Lumen",Rank <25.5), aes(Rank, coeff_FAM134ABCTEXCCPG1,color=Compartment_ss),size=1,alpha=0.5)+
  
  geom_text_repel(data = er_ac2%>%filter(Rank  < 26), aes(Rank, coeff_FAM134ABCTEXCCPG1,color=Compartment_ss,label=Gene.Symbol),box.padding = 1,max.overlaps = Inf,show.legend = F)+
  geom_text_repel(data = er_ac2%>%filter(Rank  > 262), aes(Rank, coeff_FAM134ABCTEXCCPG1,color=Compartment_ss,label=Gene.Symbol),box.padding = 1,max.overlaps = Inf,show.legend = F)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+
  theme(axis.title = element_text(size=16),
        axis.text = element_text(size=14),
        legend.position = "top")+
  scale_color_viridis_d(end=0.8,direction=-1)+
  labs(y=bquote(""~beta[PKO]~""),color="")+xlim(c(0,25.5))


ggplot()+
  geom_point(data = er_ac2%>%filter( Rank >25), aes(Rank, coeff_FAM134ABCTEXCCPG1,color=Compartment_ss),size=0.25,alpha=0.5,color="grey")+
  geom_point(data = er_ac2%>%filter(Compartment_ss =="ER.Lumen",Rank <25.5), aes(Rank, coeff_FAM134ABCTEXCCPG1,color=Compartment_ss),size=1,alpha=0.5)+
  
  geom_text_repel(data = er_ac2%>%filter(Rank  < 26), aes(Rank, coeff_FAM134ABCTEXCCPG1,color=Compartment_ss,label=Gene.Symbol),box.padding = 1,max.overlaps = Inf,show.legend = F)+
  geom_text_repel(data = er_ac2%>%filter(Rank  > 262), aes(Rank, coeff_FAM134ABCTEXCCPG1,color=Compartment_ss,label=Gene.Symbol),box.padding = 1,max.overlaps = Inf,show.legend = F)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+
  theme(axis.title = element_text(size=16),
        axis.text = element_text(size=14),
        legend.position = "top")+
  scale_color_viridis_d(end=0.8,direction=-1)+
  labs(y=bquote(""~beta[PKO]~""),color="")+xlim(c(261.5,268))


ggplot()+
  geom_point(data = er_ac%>%filter( Rank >25), aes(Rank, coeff_FAM134AC,color=Compartment_ss),size=0.25,alpha=0.5,color="grey")+
  geom_point(data = er_ac%>%filter(Compartment_ss =="ER.Lumen",Rank <25.5), aes(Rank, coeff_FAM134AC,color=Compartment_ss),size=1,alpha=0.5)+
  
  geom_text_repel(data = er_ac%>%filter(Rank  < 26), aes(Rank, coeff_FAM134AC,color=Compartment_ss,label=Gene.Symbol),box.padding = 1,max.overlaps = Inf,show.legend = F)+
  geom_text_repel(data = er_ac%>%filter(Rank  > 262), aes(Rank, coeff_FAM134AC,color=Compartment_ss,label=Gene.Symbol),box.padding = 1,max.overlaps = Inf,show.legend = F)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+
  theme(axis.title = element_text(size=16),
        axis.text = element_text(size=14),
        legend.position = "top")+
  scale_color_viridis_d(end=0.8,direction=-1)+
  labs(y=bquote(""~beta[PKO]~""),color="")+xlim(c(261.5,268))


ggplot()+
  geom_point(data = er_ac2, aes(Rank, coeff_FAM134ABCTEXCCPG1,color=Compartment_ss),size=0.5,alpha=0.5,color="grey")+
  geom_point(data = er_ac2%>%filter(Compartment_ss =="ER.Lumen"), aes(Rank, coeff_FAM134ABCTEXCCPG1,color=Compartment_ss),size=1.5,alpha=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+
  theme(axis.title = element_text(size=16),
        axis.text = element_text(size=14),
        legend.position = "top")+
  scale_color_viridis_d(end=0.8,direction=-1)+
  labs(y=bquote(""~beta[PKO]~""),color="")


ggplot()+
  geom_point(data = er_ac, aes(Rank, coeff_FAM134AC,color=Compartment_ss),size=0.5,alpha=0.5,color="grey")+
  geom_point(data = er_ac%>%filter(Compartment_ss =="ER.Membrane"), aes(Rank, coeff_FAM134AC,color=Compartment_ss),size=1.5,alpha=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+
  theme(axis.title = element_text(size=16),
        axis.text = element_text(size=14),
        legend.position = "top")+
  scale_color_viridis_d(end=0.4,direction=-1)+
  labs(y=bquote(""~beta[DKO]~""),color="")
  




top25_penta<-er_ac2%>%filter(Rank < 26)%>%group_by(Compartment_ss)%>%
  summarise(counts=n())


penta_bar<-er_ac2%>%group_by(Compartment_ss)%>%
  summarise(counts=n())%>%
  left_join(.,top25_penta,by="Compartment_ss",suffix=c("_All","_Penta KO"))%>%
  gather("count_type","counts",2:3)%>%
  mutate(counts = replace_na(counts,0))%>%
  mutate(count_type= str_remove(count_type,"counts_"))%>%
  ungroup()%>%
  group_by(count_type)%>%
  mutate(sum_count=sum(counts))


ggplot(penta_bar,aes(count_type,counts/sum_count*100,fill=Compartment_ss))+
  geom_bar(stat="identity")+
  scale_fill_viridis_d(end=0.8,direction=-1)+
  theme_classic()



## ac 
top25_ac<-er_ac%>%
  filter(Rank < 26)%>%
  group_by(Compartment_ss)%>%
  summarise(counts=n())


ac_bar<-er_ac%>%
  group_by(Compartment_ss)%>%
  summarise(counts=n())%>%
  left_join(.,top25_ac,by="Compartment_ss",suffix=c("_All","_AC KO"))%>%
  gather("count_type","counts",2:3)%>%
  mutate(count_type= str_remove(count_type,"counts_"))%>%
  ungroup()%>%
  group_by(count_type)%>%
  mutate(sum_count=sum(counts))%>%
  bind_rows(penta_bar)%>%
  distinct()%>%
  mutate(count_type = if_else(count_type=="All","All",paste("top25 \n",count_type,sep="")))



percentage_plot<-ggplot(ac_bar,aes(count_type,counts/sum_count*100,fill=Compartment_ss))+
  geom_bar(stat="identity")+
  scale_fill_viridis_d(end=0.8,direction=-1)+
  theme_classic()+
  theme(legend.position = "top",
        axis.text = element_text(size=14),
        axis.title = element_text(size=16),
        legend.text = element_text(size=6))+
  labs(x="",y="Percentage by \n Sub-ER Compartment",fill="")

percentage_plot
# ggsave(percentage_plot, file="C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/fig5c_subER_percentTop25.pdf", height=5,width=4 )
```

#### heatmap for each of the proteins rank proteins

```{r}

er_ac_heat<-nest_df4_ann2%>%
  dplyr::filter(Compartment_ss %in% c("ER.Membrane","ER.Lumen","ER.Membrane.associated","ER.high.curvature") , Gene.Symbol != "FAM134A" )%>%
  # mutate(Compartment_ss = if_else(Compartment_ss == "ER.high.curvature","ER.Membrane",Compartment_ss))%>%
  arrange(desc(coeff_FAM134AC))%>%
  tibble::rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))%>%
  left_join(.,d12_plexa,by=c("Reference","Gene.Symbol","Annotation"))


er_ac_heat_rankatg12<-er_ac_heat%>%
  arrange(desc(log2FC_ATG12d12.WTd12))%>%
  rownames_to_column("Rank_atg12")%>%
  mutate(Rank_atg12 = as.numeric(as.character(Rank_atg12)))%>%
  filter(Rank<26|Rank>262)%>%
  mutate(Rank3 = paste("(",Rank,")",sep=""))%>%
  mutate(Rank = if_else(Rank >25, Rank-236,Rank))%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss , "\\."," "))

er_ac_heat_rankatg12$Compartment_ss <- factor(er_ac_heat_rankatg12$Compartment_ss, levels = c("ER Lumen","ER high curvature","ER Membrane","ER Membrane associated"))


p5b<-ggplot()+
  geom_tile(data=er_ac_heat_rankatg12, aes(Rank,3,fill=coeff_FAM134ABCTEXCCPG1))+
  geom_tile(data=er_ac_heat_rankatg12, aes(Rank,4,fill=coeff_FAM134ABCTEX))+
  geom_tile(data=er_ac_heat_rankatg12, aes(Rank,5,fill=coeff_FAM134ABC))+
  geom_tile(data=er_ac_heat_rankatg12, aes(Rank,2,fill=log2FC_CABTEXCCPG1d12.WTd12))+
  geom_tile(data=er_ac_heat_rankatg12, aes(Rank,6,fill=coeff_FAM134AC))+
  geom_tile(data=er_ac_heat_rankatg12, aes(Rank,1,fill=log2FC_ATG12d12.WTd12))+
  scale_fill_gradient2(low="#542788",high="#B35806",midpoint = 0,mid = "grey95")+
  geom_text(data=er_ac_heat_rankatg12, aes(x=Rank,y=7.45,label=Gene.Symbol, color=Compartment_ss),size=4,angle=90)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=Rank,y=6,label=Rank3),size=4,angle=90)+
  ylim(c(0.5,8))+xlim(c(-2.5,32.5))+
  theme_classic()+
  theme(axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.line = element_blank(),
        legend.title = element_blank())+
  scale_color_viridis_d(end=0.8,direction=-1)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=-2,y=3,label="Beta PKO"),size=4)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=-2,y=4,label="Beta QKO"),size=4)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=-2,y=5,label="Beta TKO"),size=4)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=-2,y=6,label="Beta DKO"),size=4)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=-2,y=2,label="Penta-WT"),size=4)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=-2,y=1,label="ATG12-WT"),size=4)

#### penta

er_ac_heat2<-nest_df4_ann2%>%
  dplyr::filter(Compartment_ss %in% c("ER.Membrane","ER.Lumen","ER.Membrane.associated","ER.high.curvature") , Gene.Symbol != "FAM134A" )%>%
  arrange(desc(coeff_FAM134ABCTEXCCPG1))%>%
  tibble::rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))%>%
  left_join(.,d12_plexa,by=c("Reference","Gene.Symbol","Annotation"))

er_ac_heat2_rankatg12<-er_ac_heat2%>%
  arrange(desc(log2FC_ATG12d12.WTd12))%>%
  rownames_to_column("Rank_atg12")%>%
  mutate(Rank_atg12 = as.numeric(as.character(Rank_atg12)))%>%
  filter(Rank<26|Rank>262)%>%
  mutate(Rank3 = paste("(",Rank,")",sep=""))%>%
  mutate(Rank = if_else(Rank >25, Rank-236,Rank))%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss , "\\."," "))

er_ac_heat2_rankatg12$Compartment_ss <- factor(er_ac_heat2_rankatg12$Compartment_ss, levels = c("ER Lumen","ER high curvature","ER Membrane","ER Membrane associated"))

p5c<-ggplot()+
  geom_tile(data=er_ac_heat2_rankatg12, aes(Rank,3,fill=coeff_FAM134ABCTEXCCPG1))+
  geom_tile(data=er_ac_heat2_rankatg12, aes(Rank,4,fill=coeff_FAM134ABCTEX))+
  geom_tile(data=er_ac_heat2_rankatg12, aes(Rank,5,fill=coeff_FAM134ABC))+
  geom_tile(data=er_ac_heat2_rankatg12, aes(Rank,2,fill=log2FC_CABTEXCCPG1d12.WTd12))+
  geom_tile(data=er_ac_heat2_rankatg12, aes(Rank,6,fill=coeff_FAM134AC))+
  geom_tile(data=er_ac_heat2_rankatg12, aes(Rank,1,fill=log2FC_ATG12d12.WTd12))+
  scale_fill_gradient2(low="#542788",high="#B35806",midpoint = 0,mid = "grey95")+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=Rank,y=7.45,label=Gene.Symbol, color=Compartment_ss),size=4,angle=90)+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=Rank,y=3,label=Rank3),size=4,angle=90)+
  ylim(c(0.5,8))+xlim(c(-2.5,32.5))+
  theme_classic()+
  theme(axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.line = element_blank(),
        legend.title = element_blank())+
  scale_color_manual(values=c("#5DC863FF", "#3B528BFF","#440154FF"))+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=-2,y=3,label="Beta PKO"),size=4)+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=-2,y=4,label="Beta QKO"),size=4)+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=-2,y=5,label="Beta TKO"),size=4)+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=-2,y=6,label="Beta DKO"),size=4)+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=-2,y=2,label="Penta-WT"),size=4)+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=-2,y=1,label="ATG12-WT"),size=4)

###atg12 only

er_ac_heat3_rankatg12<-nest_df4_ann2%>%
  dplyr::filter(Compartment_ss %in% c("ER.Membrane","ER.Lumen","ER.Membrane.associated","ER.high.curvature") , Gene.Symbol != "FAM134A" )%>%
  # mutate(Compartment_ss = if_else(Compartment_ss == "ER.high.curvature","ER.Membrane",Compartment_ss))%>%
  
  
  left_join(.,d12_plexa,by=c("Reference","Gene.Symbol","Annotation"))%>%
  arrange(desc(log2FC_ATG12d12.WTd12))%>%
  tibble::rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))%>%
  # arrange(desc(log2FC_ATG12d12.WTd12))%>%
  # rownames_to_column("Rank_atg12")%>%
  # mutate(Rank_atg12 = as.numeric(as.character(Rank_atg12)))%>%
  filter(Rank<26|Rank>262)%>%
  mutate(Rank3 = paste("(",Rank,")",sep=""))%>%
  mutate(Rank = if_else(Rank >25, Rank-236,Rank))%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss , "\\."," "))

er_ac_heat3_rankatg12$Compartment_ss <- factor(er_ac_heat3_rankatg12$Compartment_ss, levels = c("ER Lumen","ER high curvature","ER Membrane","ER Membrane associated"))




p5d<-ggplot()+
  geom_tile(data=er_ac_heat3_rankatg12, aes(Rank,3,fill=coeff_FAM134ABCTEXCCPG1))+
  geom_tile(data=er_ac_heat3_rankatg12, aes(Rank,4,fill=coeff_FAM134ABCTEX))+
  geom_tile(data=er_ac_heat3_rankatg12, aes(Rank,5,fill=coeff_FAM134ABC))+
  geom_tile(data=er_ac_heat3_rankatg12, aes(Rank,2,fill=log2FC_CABTEXCCPG1d12.WTd12))+
  geom_tile(data=er_ac_heat3_rankatg12, aes(Rank,6,fill=coeff_FAM134AC))+
  geom_tile(data=er_ac_heat3_rankatg12, aes(Rank,1,fill=log2FC_ATG12d12.WTd12))+
  scale_fill_gradient2(low="#542788",high="#B35806",midpoint = 0,mid = "grey95")+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=Rank,y=7.45,label=Gene.Symbol, color=Compartment_ss),size=4,angle=90)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=Rank,y=1,label=Rank3),size=4,angle=90)+
  ylim(c(0.5,8))+xlim(c(-2.5,32.5))+
  theme_classic()+
  theme(axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.line = element_blank(),
        legend.title = element_blank())+
  scale_color_viridis_d(end=0.8,direction=-1)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=-2,y=3,label="Beta PKO"),size=4)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=-2,y=4,label="Beta QKO"),size=4)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=-2,y=5,label="Beta TKO"),size=4)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=-2,y=6,label="Beta DKO"),size=4)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=-2,y=2,label="Penta-WT"),size=4)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=-2,y=1,label="ATG12-WT"),size=4)




# ggsave(p5b,file="C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/Fig5b_DKOtop25_heatmap.pdf",width=10,height=4)

# ggsave(p5c,file="C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/Fig5c_DKOtop25_heatmap.pdf",width=10,height=4)

# ggsave(p5d,file="C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/Fig5d_DKOtop25_heatmap.pdf",width=10,height=4)
```






### Beta based heat map for coefficients


```{r}


heatmap_coef_highcurve <- nest_df4_ann2%>%
  select(Reference, Gene.Symbol, Annotation, coeff_FAM134AC, coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1)%>%
  rename(FAM134AC = coeff_FAM134AC,
         FAM134ABC = coeff_FAM134ABC,
         FAM134ABCTEX = coeff_FAM134ABCTEX,
         FAM134ABCTEXCCPG1 = coeff_FAM134ABCTEXCCPG1)%>%
  distinct()%>%
  separate(Reference, into= c("type","Reference","nameextra"),sep="\\|")%>%
  select(-type,-nameextra)%>%
  inner_join(.,high, by="Gene.Symbol")%>%
  mutate(Compartment_ss=str_replace_all(Compartment_ss,"\\."," "),
         Gene = paste(Gene.Symbol,Reference,sep="_"),
         ProtID = Gene)%>%
  ungroup()%>%
  select(-Annotation, -Reference, -Gene.Symbol)%>%
  # filter(Compartment_ss %in% c("ER high curvature","ER high sheet"))%>%
  select(ProtID,FAM134AC, FAM134ABC,FAM134ABCTEX,FAM134ABCTEXCCPG1,
         Compartment_ss,Gene)%>%
  arrange(Compartment_ss,ProtID)



all_dataB_heatmap3 <- heatmap_coef_highcurve %>%
  ungroup()%>%
  select(-Compartment_ss, -Gene)%>%
  column_to_rownames(var="ProtID")

annotation_allB3<-heatmap_coef_highcurve %>%
  select(ProtID, Compartment_ss)

df_col_ann3 <- data.frame("sample"= colnames(heatmap_coef_highcurve)[2:5], values = c("FAM134AC","FAM134ABC","FAM134ABCTEX","FAM134ABCTEXCCPG1"))

annoB<-data.frame(row.names=annotation_allB3$ProtID, Annotation=annotation_allB3$Compartment_ss)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann3$sample, Condition=df_col_ann3$values)

# annoD$Condition<-factor(annoD$Condition, values=c("WT","ATG12","CCPG1","TEX264","FAM134A","FAM134B","FAM134C"))

# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-0.5, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 0.5, length.out=floor(paletteLength/2)))

# test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


rownames(annoD) <- colnames(all_dataB_heatmap3)

test<-pheatmap(all_dataB_heatmap3, cluster_cols = F,  annotation_row = annoB,color=myColor, breaks=myBreaks, border_color = FALSE,annotation = annoD,cluster_rows = F)
#annotation = annoD, 
# ggsave(plot = test, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4X_Accum_heatmap_ERhc_ERhs_LinearModelBetas.pdf", height = 4.5,width=5)

```


### Autophagy Beta based heat map for coefficients


```{r}

list_autophagy <- c(
  "ACBD5","AMBRA1","ATG10","ATG101","ATG12",
  "ATG13","ATG14","ATG16L1","ATG2A","ATG2B",
  "ATG3","ATG4A","ATG4B","ATG4C","ATG5",
  "ATG7","ATG9A","BAG3","BCL2L13","BECN1",
  "BNIP3L","CALCOCO2","CCPG1","CDK5RAP3","CHMP2B",
  "CHMP4B","EGFR","EIF4G1","ERBB2","FUNDC1",
  "FYCO1","GABARAP","GABARAPL2","GOPC","HDAC6",
  "HGS","HIF1A","HSPA8","ITGB1","LGALS3",
  "LGALS8","MAP1LC3A","MAP1LC3B","MTOR","NBR1",
  "NCOA4","NLRX1","OPTN","PEX13","PEX14",
  "PEX3","PEX5","PIK3C3","PIK3R4","PINK1",
  "PLEKHM1","PRKN","PTEN","RAB11A","RAB1A",
  "RAB24","RAB33B","RAB5A","RAB7A","RAC1",
  "RB1CC1","RETREG1","RPTOR","RUBCN","SH3GLB1",
  "SIRT1","SIRT2","SQSTM1","STBD1","STK11",
  "STX17","TAX1BP1","TBK1","TEX264","TM9SF1",
  "TOLLIP","TRIM5","TSC2","ULK1","ULK2",
  "UVRAG","WDFY3","WDR45","WDR45B","WIPI1",
  "WIPI2","ZFYVE1")

heatmap_coef_highcurve <- nest_df4_ann2%>%
  select(Reference, Gene.Symbol, Annotation, coeff_FAM134AC, coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1)%>%
  rename(FAM134AC = coeff_FAM134AC,
         FAM134ABC = coeff_FAM134ABC,
         FAM134ABCTEX = coeff_FAM134ABCTEX,
         FAM134ABCTEXCCPG1 = coeff_FAM134ABCTEXCCPG1)%>%
  distinct()%>%
  separate(Reference, into= c("type","Reference","nameextra"),sep="\\|")%>%
  select(-type,-nameextra)%>%
  left_join(.,organelle_input_er_split, by="Gene.Symbol")%>%
  mutate(Compartment_ss=str_replace_all(Compartment_ss,"\\."," "),
         Gene = paste(Gene.Symbol,Reference,sep="_"),
         ProtID = Gene)%>%
  ungroup()%>%
  filter(Gene.Symbol %in% list_autophagy)%>%
  filter(Gene.Symbol != "CDK5RAP3")%>%
  select(-Annotation, -Reference, -Gene.Symbol)%>%
  filter(Compartment_ss %in% c("ER","Golgi","Peroxisome",
                               "Endosome","Lysosome",
                               "Cytosol") | is.na(Compartment_ss))%>%
  # mutate(Compartment_ss = str_replace(is.na(Compartment_ss),"Unannotated"))%>%
  select(ProtID,FAM134AC, FAM134ABC,FAM134ABCTEX,FAM134ABCTEXCCPG1,
         Compartment_ss,Gene)%>%
  arrange(Compartment_ss,ProtID)



all_dataB_heatmap3 <- heatmap_coef_highcurve %>%
  ungroup()%>%
  select(-Compartment_ss, -Gene)%>%
  column_to_rownames(var="ProtID")

annotation_allB3<-heatmap_coef_highcurve %>%
  select(ProtID, Compartment_ss)

df_col_ann3 <- data.frame("sample"= colnames(heatmap_coef_highcurve)[2:5], values = c("FAM134AC","FAM134ABC","FAM134ABCTEX","FAM134ABCTEXCCPG1"))

annoB<-data.frame(row.names=annotation_allB3$ProtID, Annotation=annotation_allB3$Compartment_ss)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann3$sample, Condition=df_col_ann3$values)

# annoD$Condition<-factor(annoD$Condition, values=c("WT","ATG12","CCPG1","TEX264","FAM134A","FAM134B","FAM134C"))

# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-0.5, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 0.5, length.out=floor(paletteLength/2)))

# test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


rownames(annoD) <- colnames(all_dataB_heatmap3)

test<-pheatmap(all_dataB_heatmap3, cluster_cols = F,  annotation_row = annoB,color=myColor, breaks=myBreaks, border_color = FALSE,annotation = annoD,cluster_rows = F)
#annotation = annoD, 
# ggsave(plot = test, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/Extra_Accum_heatmap_ERhc_ERhs_LinearModelBetas.pdf", height = 11,width=7.5)

```






#### Point Plot ATG12 vs KO FC


```{r}


### extra based on all proteins by compartment
accum_fc2_CA<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WTd12"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  # dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
  #        delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CA = median(log2FC_CAd12.WTd12),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CA= quantile(log2FC_CAd12.WTd12,0.25),
            q3_CA= quantile(log2FC_CAd12.WTd12,0.75),
            num_proteins = n())

p1<-ggplot(accum_fc2_CA%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CA,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CA,yend=med_CA,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CA,yend=q3_CA,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CA%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CA,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="FAM134A/C KO - WT",x="ATG12 KO - WT")+
  ylim(c(-.2,.45))+geom_abline(slope = 1,linetype="dashed")

## CAB

accum_fc2_CAB<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WTd12"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  # dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
  #        delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CAB = median(log2FC_CABd12.WTd12),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CAB= quantile(log2FC_CABd12.WTd12,0.25),
            q3_CAB= quantile(log2FC_CABd12.WTd12,0.75),
            num_proteins = n())

p2<-ggplot(accum_fc2_CAB%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CAB,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CAB,yend=med_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CAB,yend=q3_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CAB%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CAB,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC KO - WT",x="ATG12 KO - WT")+
  ylim(c(-.2,.45))+geom_abline(slope = 1,linetype="dashed")


## CAB TEX

accum_fc2_CABTEX<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WTd12"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  # dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
  #        delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CABTEX = median(log2FC_CABTEXd12.WTd12),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CABTEX= quantile(log2FC_CABTEXd12.WTd12,0.25),
            q3_CABTEX= quantile(log2FC_CABTEXd12.WTd12,0.75),
            num_proteins = n())

p3<-ggplot(accum_fc2_CABTEX%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEX,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CABTEX,yend=med_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CABTEX,yend=q3_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEX%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEX,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC_TEX KO - WT",x="ATG12 KO - WT")+
  ylim(c(-.2,.45))+geom_abline(slope = 1,linetype="dashed")




## CAB TEX

accum_fc2_CABTEXCCPG1<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WTd12"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  # dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
  #        delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CABTEXCCPG1 = median(log2FC_CABTEXCCPG1d12.WTd12),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CABTEXCCPG1= quantile(log2FC_CABTEXCCPG1d12.WTd12,0.25),
            q3_CABTEXCCPG1= quantile(log2FC_CABTEXCCPG1d12.WTd12,0.75),
            num_proteins = n())

p4<-ggplot(accum_fc2_CABTEXCCPG1%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEXCCPG1%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC_TEX_CCPG1 KO - WT",x="ATG12 KO - WT")+
  ylim(c(-.2,.45))+geom_abline(slope = 1,linetype="dashed")

plot_fc_accum_point<-plot_grid(p1,p2,p3,p4,nrow=1)

plot_fc_accum_point

# ggsave(plot = plot_fc_accum_point, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/supfig5_point_plot_fc_toATG12.pdf", height = 6,width=20)

```


#### Point Plot previous accum vs KO FC


```{r}


### extra based on all proteins by compartment
accum_fc2_CA<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WTd12"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  # dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
  #        delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CAB=median(log2FC_CABd12.WTd12),
            med_CA = median(log2FC_CAd12.WTd12),
            q1_CAB= quantile(log2FC_CABd12.WTd12,0.25),
            q3_CAB= quantile(log2FC_CABd12.WTd12,0.75),
            q1_CA= quantile(log2FC_CAd12.WTd12,0.25),
            q3_CA= quantile(log2FC_CAd12.WTd12,0.75),
            num_proteins = n())%>%
  distinct()

p1<-ggplot(accum_fc2_CA%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CAB,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CA,xend=q3_CA,y=med_CAB,yend=med_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CA,xend=med_CA,y=q1_CAB,yend=q3_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CA%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CAB,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~Log[2]~"(CAB KO - WT)"),x=bquote(""~Log[2]~"(CA KO - WT)"))+
  ylim(c(-.25,.45))+geom_abline(slope = 1,linetype="dashed")+
  xlim(c(-.25,.45))

## CAB

accum_fc2_CAB<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WTd12"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  # dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
  #        delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CABTEX=median(log2FC_CABTEXd12.WTd12),
            med_CAB = median(log2FC_CABd12.WTd12),
            q1_CABTEX= quantile(log2FC_CABTEXd12.WTd12,0.25),
            q3_CABTEX= quantile(log2FC_CABTEXd12.WTd12,0.75),
            q1_CAB= quantile(log2FC_CABd12.WTd12,0.25),
            q3_CAB= quantile(log2FC_CABd12.WTd12,0.75),
            num_proteins = n())

p2<-ggplot(accum_fc2_CAB%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CAB,med_CABTEX,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CAB,xend=q3_CAB,y=med_CABTEX,yend=med_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CAB,xend=med_CAB,y=q1_CABTEX,yend=q3_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CAB%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CAB,med_CABTEX,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~Log[2]~"(ABCTEX KO - WT)"),x=bquote(""~Log[2]~"(ABC KO - WT)"))+
  ylim(c(-.25,.45))+geom_abline(slope = 1,linetype="dashed")+
  xlim(c(-.25,.45))


## CAB TEX

accum_fc2_CABTEX<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WTd12"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  # dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
  #        delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CABTEXCCPG1=median(log2FC_CABTEXCCPG1d12.WTd12),
            med_CABTEX = median(log2FC_CABTEXd12.WTd12),
            q1_CABTEXCCPG1= quantile(log2FC_CABTEXCCPG1d12.WTd12,0.25),
            q3_CABTEXCCPG1= quantile(log2FC_CABTEXCCPG1d12.WTd12,0.75),
            q1_CABTEX= quantile(log2FC_CABTEXd12.WTd12,0.25),
            q3_CABTEX= quantile(log2FC_CABTEXd12.WTd12,0.75),
            num_proteins = n())

p3<-ggplot(accum_fc2_CABTEX%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CABTEX,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CABTEX,xend=q3_CABTEX,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CABTEX,xend=med_CABTEX,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEX%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CABTEX,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~Log[2]~"(ABCTEXCCPG1 KO - WT)"),x=bquote(""~Log[2]~"(ABCTEX KO - WT)"))+
  ylim(c(-.25,.45))+geom_abline(slope = 1,linetype="dashed")+
  xlim(c(-.25,.45))




## CAB TEX

accum_fc2_CABTEXCCPG1<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WTd12"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  # dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
  #        delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CABTEXCCPG1 = median(log2FC_CABTEXCCPG1d12.WTd12),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CABTEXCCPG1= quantile(log2FC_CABTEXCCPG1d12.WTd12,0.25),
            q3_CABTEXCCPG1= quantile(log2FC_CABTEXCCPG1d12.WTd12,0.75),
            num_proteins = n())

p4<-ggplot(accum_fc2_CABTEXCCPG1%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEXCCPG1%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC_TEX_CCPG1 KO - WT",x="ATG12 KO - WT")+
  ylim(c(-.25,.45))+geom_abline(slope = 1,linetype="dashed")+
  xlim(c(-.25,.45))

plot_accum_fc <- plot_grid(p1,p2,p3,p4,nrow=1, rel_widths = c(1,1,1,1.5))


plot_accum_fc <- plot_grid(p1,p2,p3,nrow=1, rel_widths = c(1,1,1))

plot_accum_fc

# ggsave(plot = plot_accum_fc, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig3e_point_plot_fc_accum_compare.pdf", height = 5,width=15)
```




#### COME back to Coeff based  vs ATG12

```{r}
accum_fc2_all<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WTd12"))


linear_results_all <- nest_df4_ann2%>%
  select(Reference, Gene.Symbol, Annotation, coeff_FAM134AC, coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1, q.value_FAM134AC,q.value_FAM134ABC,q.value_FAM134ABCTEX,q.value_FAM134ABCTEXCCPG1)%>%
  left_join(.,accum_fc2_all,by = c("Reference", "Gene.Symbol","Annotation"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  distinct()

ggplot(nest_df4_ann2%>%filter(Compartment_ss == "ER.Lumen"),aes(coeff_FAM134ABCTEXCCPG1,-log10(q.value_FAM134ABCTEXCCPG1)))+geom_point()+
  geom_text_repel(data=nest_df4_ann2%>%filter(Compartment_ss == "ER.Lumen")%>%filter(coeff_FAM134ABCTEXCCPG1>0,q.value_FAM134ABCTEXCCPG1<0.05),aes(coeff_FAM134ABCTEXCCPG1,-log10(q.value_FAM134ABCTEXCCPG1),label=Gene.Symbol),max.overlaps = Inf,box.padding = 1)+theme_classic()




accum_fc2_CA_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CA = median(coeff_FAM134AC),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CA= quantile(coeff_FAM134AC,0.25),
            q3_CA= quantile(coeff_FAM134AC,0.75),
            num_proteins = n())

p1<-ggplot(accum_fc2_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CA,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CA,yend=med_CA,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CA,yend=q3_CA,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CA,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="Beta FAM134A/C KO - WT",x="ATG12 KO - WT")+
  ylim(c(-.2,.45))+geom_abline(slope = 1,linetype="dashed")


### CAB

accum_fc2_CAB_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CAB = median(coeff_FAM134ABC),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CAB= quantile(coeff_FAM134ABC,0.25),
            q3_CAB= quantile(coeff_FAM134ABC,0.75),
            num_proteins = n())

p2<-ggplot(accum_fc2_CAB_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CAB,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CAB,yend=med_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CAB,yend=q3_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CAB_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CAB,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC KO Coeff - WT",x="ATG12 KO - WT")+
  ylim(c(-.2,.45))+geom_abline(slope = 1,linetype="dashed")



### CAB TEX

accum_fc2_CABTEX_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CABTEX = median(coeff_FAM134ABCTEX),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CABTEX= quantile(coeff_FAM134ABCTEX,0.25),
            q3_CABTEX= quantile(coeff_FAM134ABCTEX,0.75),
            num_proteins = n())

p3<-ggplot(accum_fc2_CABTEX_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEX,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CABTEX,yend=med_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CABTEX,yend=q3_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEX_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEX,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC TEX KO Coeff - WT",x="ATG12 KO - WT")+
  ylim(c(-.2,.45))+geom_abline(slope = 1,linetype="dashed")
p3

### CAB TEX

accum_fc2_CABTEXCCPG1_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CABTEXCCPG1 = median(coeff_FAM134ABCTEXCCPG1),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1,0.25),
            q3_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1,0.75),
            num_proteins = n())

p4<-ggplot(accum_fc2_CABTEXCCPG1_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEXCCPG1_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC TEX CCPG1 KO Coeff - WT",x="ATG12 KO - WT")+
  ylim(c(-.2,.45))+geom_abline(slope = 1,linetype="dashed")
  
# 
# plot_grid(p1,p2,p3,p4,nrow=1)

plot_fc_accum_point<-plot_grid(p1,p2,p3,p4,nrow=1)

plot_fc_accum_point

# ggsave(plot = plot_fc_accum_point, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/point_plot_coef_toATG12.pdf", height = 6,width=20)
```






#### Accum KO Coeff based

```{r}
accum_fc2_all<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WTd12"))


linear_results_all <- nest_df4_ann2%>%
  select(Reference, Gene.Symbol, Annotation, coeff_FAM134AC, coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1, q.value_FAM134AC,q.value_FAM134ABC,q.value_FAM134ABCTEX,q.value_FAM134ABCTEXCCPG1)%>%
  left_join(.,accum_fc2_all,by = c("Reference", "Gene.Symbol","Annotation"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  distinct()



accum_fc2_CA_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CAB=median(coeff_FAM134ABC),
            med_CA = median(coeff_FAM134AC),
            q1_CAB= quantile(coeff_FAM134ABC,0.25),
            q3_CAB= quantile(coeff_FAM134ABC,0.75),
            q1_CA= quantile(coeff_FAM134AC,0.25),
            q3_CA= quantile(coeff_FAM134AC,0.75),
            num_proteins = n())

p1<-ggplot(accum_fc2_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CAB,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CA,xend=q3_CA,y=med_CAB,yend=med_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CA,xend=med_CA,y=q1_CAB,yend=q3_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CAB,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  # labs(y="CAB KO Coef - WT",x="CA KO Coef - WT")+
  labs(y=bquote(""~beta[FAM134A/B/C]~""),x=bquote(""~beta[FAM134A/C]~""))+
  ylim(c(-.25,.25))+geom_abline(slope = 1,linetype="dashed")+
  scale_x_continuous(limits=c(-.25,.4), breaks = c(-.2,-.1,0,.1,.2,.3,.4))

 # p1

### CAB

accum_fc2_CAB_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CABTEX=median(coeff_FAM134ABCTEX),
            med_CAB = median(coeff_FAM134ABC),
            q1_CABTEX= quantile(coeff_FAM134ABCTEX,0.25),
            q3_CABTEX= quantile(coeff_FAM134ABCTEX,0.75),
            q1_CAB= quantile(coeff_FAM134ABC,0.25),
            q3_CAB= quantile(coeff_FAM134ABC,0.75),
            num_proteins = n())

p2<-ggplot(accum_fc2_CAB_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CAB,med_CABTEX,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CAB,xend=q3_CAB,y=med_CABTEX,yend=med_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CAB,xend=med_CAB,y=q1_CABTEX,yend=q3_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CAB_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CAB,med_CABTEX,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  # labs(y="ABC TEX KO Coef - WT",x="CAB KO Coef- WT")+
  labs(y=bquote(""~beta[FAM134A/B/C_TEX264]~""),x=bquote(""~beta[FAM134A/B/C]~""))+
  ylim(c(-.25,.25))+
  xlim(c(-.25,.25))+geom_abline(slope = 1,linetype="dashed")


 # p2
### CAB TEX

accum_fc2_CABTEX_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CABTEXCCPG1=median(coeff_FAM134ABCTEXCCPG1),
            med_CABTEX = median(coeff_FAM134ABCTEX),
            q1_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1,0.25),
            q3_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1,0.75),
            q1_CABTEX= quantile(coeff_FAM134ABCTEX,0.25),
            q3_CABTEX= quantile(coeff_FAM134ABCTEX,0.75),
            num_proteins = n())

p3<-ggplot(accum_fc2_CABTEX_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CABTEX,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CABTEX,xend=q3_CABTEX,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CABTEX,xend=med_CABTEX,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEX_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CABTEX,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  # labs(y="ABC TEX CCPG1 KO Coef - WT",x="ABC TEX KO Coef - WT")+
  labs(y=bquote(""~beta[FAM134A/B/C_TEX264_CCPG1]~""),x=bquote(""~beta[FAM134A/B/C_TEX264]~""))+
  ylim(c(-.25,.25))+
  xlim(c(-.25,.25))+geom_abline(slope = 1,linetype="dashed")

p3

### CAB TEX

accum_fc2_CABTEXCCPG1_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CABTEXCCPG1 = median(coeff_FAM134ABCTEXCCPG1),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1 ,0.25),
            q3_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1,0.75),
            num_proteins = n())

p4<-ggplot(accum_fc2_CABTEXCCPG1_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEXCCPG1_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC TEX CCPG1 KO Coef - WT",x="ATG12 KO - WT")+
  ylim(c(-.3,.45))+
  xlim(c(-.3,.65))+geom_abline(slope = 1,linetype="dashed")
  

plot_accum_fc <- plot_grid(p1,p2,p3,p4,nrow=1, rel_widths = c(1,1,1,1.5))

plot_accum_fc <- plot_grid(p1,p2,p3,nrow=1, rel_widths = c(1.3,1,1))

plot_accum_fc
# ggsave(plot = plot_accum_fc, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/supfig4_point_plot_coef_accum_compare.pdf", height = 5.1,width=18)



p3

# ggsave(plot = p3, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4h_point_plot_quad_penta.pdf", height = 5.1,width=5.1)
```


#### AC vs penta beta point plot

```{r}
accum_fc2_CABTEX_CA_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CABTEXCCPG1=median(coeff_FAM134ABCTEXCCPG1),
            med_CA = median(coeff_FAM134AC),
            q1_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1,0.25),
            q3_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1,0.75),
            q1_CA= quantile(coeff_FAM134AC,0.25),
            q3_CA=  quantile(coeff_FAM134AC,0.75),
            num_proteins = n())

p4h<-ggplot(accum_fc2_CABTEX_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CA,xend=q3_CA,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CA,xend=med_CA,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEX_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  # labs(y="ABC TEX CCPG1 KO Coef - WT",x="ABC TEX KO Coef - WT")+
  labs(y=bquote(""~beta[FAM134A/B/C_TEX264_CCPG1]~""),x=bquote(""~beta[FAM134A/C]~""))+
  ylim(c(-.25,.25))+
  xlim(c(-.25,.4))+geom_abline(slope = 1,linetype="dashed")

p4h

# ggsave(plot = p4h, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4h_point_plot_AC_penta_betas.pdf", height = 5.1,width=7.14)
```



#### stats local coef

```{r}
linear_results_all_stats <- nest_df4_ann2%>%
  select(Reference, Gene.Symbol, Annotation, coeff_FAM134AC, coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1)%>%
  # left_join(.,accum_fc2_all,by = c("Reference", "Gene.Symbol","Annotation"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  distinct()%>%
  group_by(Compartment_ss)%>%
  nest()%>%
  mutate(Compartment_ss = if_else(is.na(Compartment_ss), "Unannotated",Compartment_ss))

ttest_enrich<- function(data){
  df <- data.frame(data)
  # print("one")
  t_ac <- t.test(df$coeff_FAM134AC, mu = 0)
  t_abc <- t.test(df$coeff_FAM134ABC, mu = 0)
  t_abct <- t.test(df$coeff_FAM134ABCTEX, mu = 0)
  t_abctc <- t.test(df$coeff_FAM134ABCTEXCCPG1, mu = 0)

  p.val_AC <- t_ac$p.value
  p.val_ABC <- t_abc$p.value
  p.val_ABCTEX <- t_abct$p.value
  p.val_ABCTEXCCPG1 <- t_abctc$p.value

  FC_AC <- t_ac$estimate[[1]]
  FC_ABC <- t_abc$estimate[[1]]
  FC_ABCTEX <- t_abct$estimate[[1]]
  FC_ABCTEXCCPG1 <- t_abctc$estimate[[1]]

  df2<-data.frame(
    "FC_AC" = FC_AC,
    "FC_ABC" = FC_ABC,
    "FC_ABCTEX" = FC_ABCTEX,
    "FC_ABCTEXCCPG1"= FC_ABCTEXCCPG1,
    "p.val_AC" = p.val_AC,
    "p.val_ABC" = p.val_ABC,
    "p.val_ABCTEX" = p.val_ABCTEX,
    "p.val_ABCTEXCCPG1" = p.val_ABCTEXCCPG1
  )
  return(df2)
}

linear_results_all_stats2<-linear_results_all_stats%>%
  mutate(df_stats = data %>% map(ttest_enrich))%>%
  unnest(df_stats)

linear_results_all_stats2$q.val_AC <- p.adjust(linear_results_all_stats2$p.val_AC,method="bonferroni")
linear_results_all_stats2$q.val_ABC <- p.adjust(linear_results_all_stats2$p.val_ABC,method="bonferroni")
linear_results_all_stats2$q.val_ABCTEX <- p.adjust(linear_results_all_stats2$p.val_ABCTEX,method="bonferroni")
linear_results_all_stats2$q.val_ABCTEXCCPG1 <- p.adjust(linear_results_all_stats2$p.val_ABCTEXCCPG1,method="bonferroni")
```



#### DO NOT USE Accum KO Coeff based Additive 

this is equivalent to the fold changes


```{r}
accum_fc2_all<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WTd12"))


linear_results_all <- nest_df4_ann2%>%
  select(Reference, Gene.Symbol, Annotation, coeff_FAM134AC, coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1, q.value_FAM134AC,q.value_FAM134ABC,q.value_FAM134ABCTEX,q.value_FAM134ABCTEXCCPG1)%>%
  left_join(.,accum_fc2_all,by = c("Reference", "Gene.Symbol","Annotation"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  distinct()



accum_fc2_CA_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CAB=median(coeff_FAM134ABC+coeff_FAM134AC),
            med_CA = median(coeff_FAM134AC),
            q1_CAB= quantile(coeff_FAM134ABC+coeff_FAM134AC,0.25),
            q3_CAB= quantile(coeff_FAM134ABC+coeff_FAM134AC,0.75),
            q1_CA= quantile(coeff_FAM134AC,0.25),
            q3_CA= quantile(coeff_FAM134AC,0.75),
            num_proteins = n())

p1<-ggplot(accum_fc2_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CAB,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CA,xend=q3_CA,y=med_CAB,yend=med_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CA,xend=med_CA,y=q1_CAB,yend=q3_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CAB,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="CAB KO - WT",x="CA KO - WT")+
  ylim(c(-.2,.4))+
  xlim(c(-.2,.4))+
  geom_abline(slope = 1,linetype="dashed")
p1

### CAB

accum_fc2_CAB_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CABTEX=median(coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC),
            med_CAB = median(coeff_FAM134ABC+coeff_FAM134AC),
            q1_CABTEX= quantile(coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC,0.25),
            q3_CABTEX= quantile(coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC,0.75),
            q1_CAB= quantile(coeff_FAM134ABC+coeff_FAM134AC,0.25),
            q3_CAB= quantile(coeff_FAM134ABC+coeff_FAM134AC,0.75),
            num_proteins = n())

p2<-ggplot(accum_fc2_CAB_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CAB,med_CABTEX,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CAB,xend=q3_CAB,y=med_CABTEX,yend=med_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CAB,xend=med_CAB,y=q1_CABTEX,yend=q3_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CAB_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CAB,med_CABTEX,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC TEX KO Coeff - WT",x="CAB KO - WT")+
  ylim(c(-.2,.4))+
  xlim(c(-.2,.4))+
  geom_abline(slope = 1,linetype="dashed")


p2
### CAB TEX

accum_fc2_CABTEX_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CABTEXCCPG1=median(coeff_FAM134ABCTEXCCPG1+coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC),
            med_CABTEX = median(coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC),
            q1_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1+coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC,0.25),
            q3_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1+coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC,0.75),
            q1_CABTEX= quantile(coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC,0.25),
            q3_CABTEX= quantile(coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC,0.75),
            num_proteins = n())

p3<-ggplot(accum_fc2_CABTEX_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CABTEX,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CABTEX,xend=q3_CABTEX,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CABTEX,xend=med_CABTEX,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEX_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CABTEX,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC TEX KO Coeff - WT",x="ATG12 KO - WT")+
  ylim(c(-.2,.4))+
  xlim(c(-.2,.4))+
  geom_abline(slope = 1,linetype="dashed")

p3

### CAB TEX

accum_fc2_CABTEXCCPG1_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CABTEXCCPG1 = median(coeff_FAM134ABCTEXCCPG1 + coeff_FAM134AC + coeff_FAM134ABC + coeff_FAM134ABCTEX),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1 + coeff_FAM134AC + coeff_FAM134ABC + coeff_FAM134ABCTEX,0.25),
            q3_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1 + coeff_FAM134AC + coeff_FAM134ABC + coeff_FAM134ABCTEX,0.75),
            num_proteins = n())

p4<-ggplot(accum_fc2_CABTEXCCPG1_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEXCCPG1_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC TEX CCPG1 KO Coeff - WT",x="ATG12 KO - WT")+
  ylim(c(-.3,.45))+
  xlim(c(-.3,.65))
  

plot_grid(p1,p2,p3,p4,nrow=1)
```



## Combine the singlet and accum

```{r}

singles_final <- singles%>%
  select(Reference,Gene.Symbol,Annotation,
         log2FC_ATG12.WT,log2FC_CCPG1.WT,log2FC_TEX264.WT,
         log2FC_FAM134A.WT,log2FC_FAM134B.WT,log2FC_FAM134C.WT,
         q.val_ATG12.WT,q.val_CCPG1.WT,q.val_TEX264.WT,
         q.val_FAM134A.WT,q.val_FAM134B.WT,q.val_FAM134C.WT)%>%
  distinct()

fc_accum<-d12_plexa%>%
  select(Reference, Gene.Symbol,Annotation,
         log2FC_ATG12d12.WTd12,log2FC_CAd12.WTd12,log2FC_CABd12.WTd12,log2FC_CABTEXd12.WTd12,
         log2FC_CABTEXCCPG1d12.WTd12,
         q.val_ATG12d12.WTd12,q.val_CAd12.WTd12,q.val_CABd12.WTd12,q.val_CABTEXd12.WTd12,
         q.val_CABTEXCCPG1d12.WTd12)%>%
  distinct()
  

accum_final_df<-left_join(nest_df4, fc_accum,by=c("Reference", "Gene.Symbol","Annotation"))

singles_accum <- inner_join(accum_final_df, singles_final,by=c("Reference", "Gene.Symbol","Annotation"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")


```


#### Penta lumenal accumulators

```{r}

p2<-ggplot(singles_accum%>%filter(Compartment_ss == "ER.Lumen"),aes(log2FC_CCPG1.WT,coeff_FAM134ABCTEXCCPG1))+geom_point()+
  geom_text_repel(data=singles_accum%>%filter(Compartment_ss == "ER.Lumen")%>%filter(coeff_FAM134ABCTEXCCPG1>0.25|log2FC_CCPG1.WT>0.25),aes(log2FC_CCPG1.WT,coeff_FAM134ABCTEXCCPG1,label=Gene.Symbol),max.overlaps = Inf,box.padding = 1)+theme_classic()+geom_abline(slope=1,linetype="dashed")+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")


ggplot(singles_accum%>%filter(Compartment_ss == "ER.Lumen"),aes(log2FC_CCPG1.WT,coeff_FAM134ABCTEXCCPG1+coeff_FAM134AC))+geom_point()+
  geom_text_repel(data=singles_accum%>%filter(Compartment_ss == "ER.Lumen")%>%filter(coeff_FAM134ABCTEXCCPG1>0.25|log2FC_CCPG1.WT>0.25),aes(log2FC_CCPG1.WT,coeff_FAM134ABCTEXCCPG1+coeff_FAM134AC,label=Gene.Symbol),max.overlaps = Inf,box.padding = 1)+theme_classic()+geom_abline(slope=1,linetype="dashed")+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")

p1<-ggplot(singles_accum%>%filter(Compartment_ss == "ER.Lumen"),aes(log2FC_CCPG1.WT,log2FC_CABTEXCCPG1d12.WTd12))+geom_point()+
  geom_text_repel(data=singles_accum%>%filter(Compartment_ss == "ER.Lumen")%>%filter(coeff_FAM134ABCTEXCCPG1>0.25|log2FC_CCPG1.WT>0.25),aes(log2FC_CCPG1.WT,log2FC_CABTEXCCPG1d12.WTd12,label=Gene.Symbol),max.overlaps = Inf,box.padding = 1)+theme_classic()+geom_abline(slope=1,linetype="dashed")+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")

plot_grid(p1,p2)
```




```{r}
up_down2<-up_down%>%
  arrange(Gene.Symbol,coeff)%>%
  distinct()%>%group_by(Gene.Symbol,Compartment_ss)%>%
  mutate(counts=n())
```


### CA

```{r}

### CA to C
CA_fc_to_Csing<-singles_accum%>%
  # left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_C=median(log2FC_FAM134C.WT),
            med_CA_fc = median(log2FC_CAd12.WTd12),
            q1_C= quantile(log2FC_FAM134C.WT,0.25),
            q3_C= quantile(log2FC_FAM134C.WT,0.75),
            q1_CA_fc= quantile(log2FC_CAd12.WTd12,0.25),
            q3_CA_fc= quantile(log2FC_CAd12.WTd12,0.75),
            num_proteins = n())

p1<-ggplot(CA_fc_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_C,med_CA_fc,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_C,xend=q3_C,y=med_CA_fc,yend=med_CA_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_C,xend=med_C,y=q1_CA_fc,yend=q3_CA_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=CA_fc_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_C,med_CA_fc,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  # labs(y="FAM134A/C KO FC - WT",x="FAM134C sing - WT")+
  labs(y=bquote(""~Log[2]~"(FAM134A/C KO - WT)"),x=bquote(""~Log[2]~"(FAM134C KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")



### A vs CA

### extra based on all proteins by compartment
CA_fc_to_Asing<-singles_accum%>%
  # left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_A=median(log2FC_FAM134A.WT),
            med_CA_fc = median(log2FC_CAd12.WTd12),
            q1_A= quantile(log2FC_FAM134A.WT,0.25),
            q3_A= quantile(log2FC_FAM134A.WT,0.75),
            q1_CA_fc= quantile(log2FC_CAd12.WTd12,0.25),
            q3_CA_fc= quantile(log2FC_CAd12.WTd12,0.75),
            num_proteins = n())

p3<-ggplot(CA_fc_to_Asing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_A,med_CA_fc,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_A,xend=q3_A,y=med_CA_fc,yend=med_CA_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_A,xend=med_A,y=q1_CA_fc,yend=q3_CA_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=CA_fc_to_Asing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_A,med_CA_fc,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  # labs(y="FAM134A/C KO FC - WT",x="FAM134A sing - WT")+
  labs(y=bquote(""~Log[2]~"(FAM134A/C KO - WT)"),x=bquote(""~Log[2]~"(FAM134A KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")



### A vs CA coeff

### extra based on all proteins by compartment
CA_coef_to_Asing<-singles_accum%>%
  # left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_A=median(log2FC_FAM134A.WT),
            med_CA_coef = median(coeff_FAM134AC),
            q1_A= quantile(log2FC_FAM134A.WT,0.25),
            q3_A= quantile(log2FC_FAM134A.WT,0.75),
            q1_CA_coef= quantile(coeff_FAM134AC,0.25),
            q3_CA_coef= quantile(coeff_FAM134AC,0.75),
            num_proteins = n())

p4<-ggplot(CA_coef_to_Asing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_A,med_CA_coef,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_A,xend=q3_A,y=med_CA_coef,yend=med_CA_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_A,xend=med_A,y=q1_CA_coef,yend=q3_CA_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=CA_coef_to_Asing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_A,med_CA_coef,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  # labs(y="FAM134A/C KO Coef- WT",x="FAM134A sing - WT")+
  labs(y=bquote(""~beta[FAM134A/C]~""),x=bquote(""~Log[2]~"(FAM134A KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,.35))+
  ylim(c(-0.25,0.5))



### extra based on all proteins by compartment
CA_coef_to_Csing<-singles_accum%>%
  # left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_C=median(log2FC_FAM134C.WT),
            med_CA_coef = median(coeff_FAM134AC),
            q1_C= quantile(log2FC_FAM134C.WT,0.25),
            q3_C= quantile(log2FC_FAM134C.WT,0.75),
            q1_CA_coef= quantile(coeff_FAM134AC,0.25),
            q3_CA_coef= quantile(coeff_FAM134AC,0.75),
            num_proteins = n())

p2<-ggplot(CA_coef_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_C,med_CA_coef,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_C,xend=q3_C,y=med_CA_coef,yend=med_CA_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_C,xend=med_C,y=q1_CA_coef,yend=q3_CA_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=CA_coef_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_C,med_CA_coef,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  # labs(y="FAM134A/C KO Coef - WT",x="FAM134C sing - WT")+
  labs(y=bquote(""~beta[FAM134A/C]~""),x=bquote(""~Log[2]~"(FAM134C KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,.35))+
  ylim(c(-0.25,0.5))


```


### Triple / CAB

```{r}
### CA to C
CAB_fc_to_Csing<-singles_accum%>%
  # left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_B=median(log2FC_FAM134B.WT),
            med_CAB_fc = median(log2FC_CABd12.WTd12),
            q1_B= quantile(log2FC_FAM134B.WT,0.25),
            q3_B= quantile(log2FC_FAM134B.WT,0.75),
            q1_CAB_fc= quantile(log2FC_CABd12.WTd12,0.25),
            q3_CAB_fc= quantile(log2FC_CABd12.WTd12,0.75),
            num_proteins = n())

p5<-ggplot(CAB_fc_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_B,med_CAB_fc,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_B,xend=q3_B,y=med_CAB_fc,yend=med_CAB_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_B,xend=med_B,y=q1_CAB_fc,yend=q3_CAB_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=CAB_fc_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_B,med_CAB_fc,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  # labs(y="FAM134A/B/C KO FC - WT",x="FAM134B sing - WT")+
  labs(y=bquote(""~Log[2]~"(FAM134A/B/C KO - WT)"),x=bquote(""~Log[2]~"(FAM134B KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,0.35))+
  ylim(c(-.25,0.5))


### CA to C
CAB_coef_to_Csing<-singles_accum%>%
  # left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_B=median(log2FC_FAM134B.WT),
            med_CAB_coef = median(coeff_FAM134ABC),
            q1_B= quantile(log2FC_FAM134B.WT,0.25),
            q3_B= quantile(log2FC_FAM134B.WT,0.75),
            q1_CAB_coef= quantile(coeff_FAM134ABC,0.25),
            q3_CAB_coef= quantile(coeff_FAM134ABC,0.75),
            num_proteins = n())

p6<-ggplot(CAB_coef_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_B,med_CAB_coef,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_B,xend=q3_B,y=med_CAB_coef,yend=med_CAB_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_B,xend=med_B,y=q1_CAB_coef,yend=q3_CAB_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=CAB_coef_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_B,med_CAB_coef,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  # labs(y="FAM134A/B/C KO Coef - WT",x="FAM134B sing - WT")+
  labs(y=bquote(""~beta[FAM134A/B/C]~""),x=bquote(""~Log[2]~"(FAM134B KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,.35))+
  ylim(c(-0.25,0.5))

```


### Quad/TEX264

```{r}
quad_coef_to_TEXsing<-singles_accum%>%
  # left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_TEX=median(log2FC_TEX264.WT),
            med_quad_coef = median(coeff_FAM134ABCTEX),
            q1_TEX= quantile(log2FC_TEX264.WT,0.25),
            q3_TEX= quantile(log2FC_TEX264.WT,0.75),
            q1_quad_coef= quantile(coeff_FAM134ABCTEX,0.25),
            q3_quad_coef= quantile(coeff_FAM134ABCTEX,0.75),
            num_proteins = n())

p8<-ggplot(quad_coef_to_TEXsing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_TEX,med_quad_coef,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_TEX,xend=q3_TEX,y=med_quad_coef,yend=med_quad_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_TEX,xend=med_TEX,y=q1_quad_coef,yend=q3_quad_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=quad_coef_to_TEXsing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_TEX,med_quad_coef,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  # labs(y="Quad KO Coef - WT",x="TEX264 sing - WT")+
  labs(y=bquote(""~beta[Quad]~""),x=bquote(""~Log[2]~"(TEX264 KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,.35))+
  ylim(c(-0.25,0.5))


####

quad_fc_to_TEXsing<-singles_accum%>%
  # left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_TEX=median(log2FC_TEX264.WT),
            med_quad_fc = median(log2FC_CABTEXd12.WTd12),
            q1_TEX= quantile(log2FC_TEX264.WT,0.25),
            q3_TEX= quantile(log2FC_TEX264.WT,0.75),
            q1_quad_fc= quantile(log2FC_CABTEXd12.WTd12,0.25),
            q3_quad_fc= quantile(log2FC_CABTEXd12.WTd12,0.75),
            num_proteins = n())

p7<-ggplot(quad_fc_to_TEXsing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_TEX,med_quad_fc,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_TEX,xend=q3_TEX,y=med_quad_fc,yend=med_quad_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_TEX,xend=med_TEX,y=q1_quad_fc,yend=q3_quad_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=quad_fc_to_TEXsing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_TEX,med_quad_fc,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  # labs(y="Quad KO FC - WT",x="TEX264 sing - WT")+
  labs(y=bquote(""~Log[2]~"(Quad KO - WT)"),x=bquote(""~Log[2]~"(TEX264 KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,0.35))+
  ylim(c(-.25,0.5))
```




### Penta


```{r}

### CCPG1 coeff


penta_coef_to_CCPG1sing<-singles_accum%>%
  # left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CCPG1=median(log2FC_CCPG1.WT),
            med_penta_coef = median(coeff_FAM134ABCTEXCCPG1),
            q1_CCPG1= quantile(log2FC_CCPG1.WT,0.25),
            q3_CCPG1= quantile(log2FC_CCPG1.WT,0.75),
            q1_penta_coef= quantile(coeff_FAM134ABCTEXCCPG1,0.25),
            q3_penta_coef= quantile(coeff_FAM134ABCTEXCCPG1,0.75),
            num_proteins = n())

p10<-ggplot(penta_coef_to_CCPG1sing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CCPG1,med_penta_coef,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CCPG1,xend=q3_CCPG1,y=med_penta_coef,yend=med_penta_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CCPG1,xend=med_CCPG1,y=q1_penta_coef,yend=q3_penta_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=penta_coef_to_CCPG1sing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CCPG1,med_penta_coef,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~beta[Penta]~""),x=bquote(""~Log[2]~"(CCPG1 KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  # xlim(c(-0.17,0.35))+
  # ylim(c(-0.17,0.35))+
  xlim(c(-.4,.35))+
  ylim(c(-0.25,0.5))




p10

### CCPG1 FC


penta_fc_to_CCPG1sing<-singles_accum%>%
  # left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CCPG1=median(log2FC_CCPG1.WT),
            med_penta_fc = median(log2FC_CABTEXCCPG1d12.WTd12),
            q1_CCPG1= quantile(log2FC_CCPG1.WT,0.25),
            q3_CCPG1= quantile(log2FC_CCPG1.WT,0.75),
            q1_penta_fc= quantile(log2FC_CABTEXCCPG1d12.WTd12,0.25),
            q3_penta_fc= quantile(log2FC_CABTEXCCPG1d12.WTd12,0.75),
            num_proteins = n())

p9<-ggplot(penta_fc_to_CCPG1sing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CCPG1,med_penta_fc,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CCPG1,xend=q3_CCPG1,y=med_penta_fc,yend=med_penta_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CCPG1,xend=med_CCPG1,y=q1_penta_fc,yend=q3_penta_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=penta_fc_to_CCPG1sing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CCPG1,med_penta_fc,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~Log[2]~"(Penta KO - WT)"),x=bquote(""~Log[2]~"(CCPG1 KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  # ylim(c(-.25,0.48))+xlim(c(-0.25,0.48))+
  xlim(c(-.4,0.35))+
  ylim(c(-.25,0.5))



p9
```


#### All plots 


```{r}
p21<-plot_grid(p3,p4)
p22<-plot_grid(p1,p2)
p20 <- plot_grid(p4,p2)
p23<-plot_grid(p5,p6)
p24<-plot_grid(p7,p8)
p25<-plot_grid(p9,p10)

supfig4_sing_accum<-plot_grid(p20,p23,p24,p25,nrow=2,ncol=2, align="hv")

# ggsave(plot = supfig4_sing_accum, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/supfig4_point_plot_singlets_vs_KOaccum.pdf", height = 10.2,width=20.4)


# ggsave(plot = p25, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4i_point_plot_singlets_vs_KOaccum_CCPG1only.pdf", height = 5.1,width=10.2)
# plot_grid(p9,p10)
```


## Individual protein plots

### FAM134A


```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("FAM134A")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-3.5,3.5))



# 
# target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
#   select(Reference,Gene.Symbol,Annotation,condition,coeff)%>%
#   spread(condition,coeff)%>%
#   separate(Reference, into=c("type","Reference","extra"),sep="\\|")%>%
#   mutate(ProtID = paste(Gene.Symbol,Reference,sep="_"))%>%
#   ungroup()%>%
#   select(ProtID,FAM134AC,FAM134ABC,FAM134ABCTEX,FAM134ABCTEXCCPG1)%>%
#   column_to_rownames("ProtID")


# paletteLength <- 50
# myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
# myBreaks <- c(seq(-3, 0, length.out=ceiling(paletteLength/2) + 1), 
#               seq(4/paletteLength, 3, length.out=floor(paletteLength/2)))
# 
# 
# p1
# 
# test<-pheatmap(target, cluster_cols = F,  color=myColor, breaks=myBreaks, border_color = "black",cluster_rows = F,
#                cellwidth = 30,cellheight = 30)


target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-3.5,3.5))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



FAM134A<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
```




### REEP1


```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("REEP1")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


# p2<-ggplot(target_prot_data %>% 
#          filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
#   facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
#   theme(legend.position = "none",
#         axis.title = element_text(size = 18),
#         axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         strip.text = element_text(size=16))+
#   labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
#   ylim(c(-1,1))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



REEP1<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
```



### ATL1


```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("ATL1")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


# p2<-ggplot(target_prot_data %>% 
#          filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
#   facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
#   theme(legend.position = "none",
#         axis.title = element_text(size = 18),
#         axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         strip.text = element_text(size=16))+
#   labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
#   ylim(c(-1,1))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



ATL1<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
```



### REEP3


```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("REEP3")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


# p2<-ggplot(target_prot_data %>% 
#          filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
#   facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
#   theme(legend.position = "none",
#         axis.title = element_text(size = 18),
#         axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         strip.text = element_text(size=16))+
#   labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
#   ylim(c(-1,1))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-2,2))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



REEP3<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
```



### REEP4


```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("REEP4")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


# p2<-ggplot(target_prot_data %>% 
#          filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
#   facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
#   theme(legend.position = "none",
#         axis.title = element_text(size = 18),
#         axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         strip.text = element_text(size=16))+
#   labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
#   ylim(c(-1,1))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1.5,1.5))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



REEP4<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
```



### REEP5


```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("REEP5")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


# p2<-ggplot(target_prot_data %>% 
#          filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
#   facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
#   theme(legend.position = "none",
#         axis.title = element_text(size = 18),
#         axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         strip.text = element_text(size=16))+
#   labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
#   ylim(c(-1,1))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



REEP5<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
```


### VAPA


```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("PLOD1")
# list_proteins <- c("P4HA1")

# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


# p2<-ggplot(target_prot_data %>% 
#          filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
#   facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
#   theme(legend.position = "none",
#         axis.title = element_text(size = 18),
#         axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         strip.text = element_text(size=16))+
#   labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
#   ylim(c(-1,1))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1.5,1.5))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
```




### VAPA


```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("VAPA")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


# p2<-ggplot(target_prot_data %>% 
#          filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
#   facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
#   theme(legend.position = "none",
#         axis.title = element_text(size = 18),
#         axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         strip.text = element_text(size=16))+
#   labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
#   ylim(c(-1,1))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1.5,1.5))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



VAPA<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
```





### VAPB


```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("VAPB")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


# p2<-ggplot(target_prot_data %>% 
#          filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
#   facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
#   theme(legend.position = "none",
#         axis.title = element_text(size = 18),
#         axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         strip.text = element_text(size=16))+
#   labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
#   ylim(c(-1,1))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



VAPB<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
```

### RTN1-3

```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("RTN1")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
    filter(Reference  ==  "sp|Q16799-3|RTN1_HUMAN")%>%
         # filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


target_prot_data<-combine_df_complete %>% 
         # filter(Gene.Symbol %in%list_proteins)%>%
  filter(Reference  ==  "sp|Q16799-3|RTN1_HUMAN")%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data%>%mutate(Gene.Symbol= "RTN1-C") , aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Reference  ==  "sp|Q16799-3|RTN1_HUMAN")%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



RTN1<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))

RTN1

# ggsave(RTN1,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4e_RTN1C.pdf", height = 7,width=6)
```




### CNPY2

```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("CNPY2")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


# p2<-ggplot(target_prot_data %>% 
#          filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
#   facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
#   theme(legend.position = "none",
#         axis.title = element_text(size = 18),
#         axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         strip.text = element_text(size=16))+
#   labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
#   ylim(c(-1,1))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1.75,1.75))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



CNPY2<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
```



### P4HA1

```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("P4HA1")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


# p2<-ggplot(target_prot_data %>% 
#          filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
#   facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
#   theme(legend.position = "none",
#         axis.title = element_text(size = 18),
#         axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         strip.text = element_text(size=16))+
#   labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
#   ylim(c(-1,1))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



P4HA1<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
P4HA1
```

### P4HA2

```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("P4HA2")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


# p2<-ggplot(target_prot_data %>% 
#          filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
#   facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
#   theme(legend.position = "none",
#         axis.title = element_text(size = 18),
#         axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         strip.text = element_text(size=16))+
#   labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
#   ylim(c(-1,1))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



P4HA2<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
P4HA2
```

### MANF

```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("MANF")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


# p2<-ggplot(target_prot_data %>% 
#          filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
#   facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
#   theme(legend.position = "none",
#         axis.title = element_text(size = 18),
#         axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         strip.text = element_text(size=16))+
#   labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
#   ylim(c(-1,1))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1.5,1.5))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



MANF<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
MANF
```





### NLRP2

```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("NLRP2")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


# p2<-ggplot(target_prot_data %>% 
#          filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
#   facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
#   theme(legend.position = "none",
#         axis.title = element_text(size = 18),
#         axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         strip.text = element_text(size=16))+
#   labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
#   ylim(c(-1,1))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-6,6))

###

target <-linear_results %>% filter(Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



NLRP2<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))

NLRP2
```





### SPAST

```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("SPAST")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-.75,.75))

###

target <-linear_results %>% filter(Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



SPAST<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))

SPAST
```


### pdf output of individual proteins


```{r}
# ggsave(SPAST,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4e_SPAST.pdf", height = 7,width=6)

# ggsave(FAM134A,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4e_FAM134A.pdf", height = 7,width=6)

# ggsave(REEP1,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4e_REEP1.pdf", height = 7,width=6)

# ggsave(REEP3,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4e_REEP3.pdf", height = 7,width=6)

# ggsave(REEP4,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4e_REEP4.pdf", height = 7,width=6)

# ggsave(REEP5,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4e_REEP5.pdf", height = 7,width=6)

# ggsave(VAPA,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4e_VAPA.pdf", height = 7,width=6)


# ggsave(VAPB,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4e_VAPB.pdf", height = 7,width=6)


# ggsave(RTN3,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4e_RTN3.pdf", height = 7,width=6)

# ggsave(ATL1,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4e_ATL1.pdf", height = 7,width=6)




# ggsave(P4HA1,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4e_P4HA1.pdf", height = 7,width=6)


# ggsave(P4HA2,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4e_P4HA2.pdf", height = 7,width=6)
```


### SNCA - alpha synuc.

```{r}

# all_data_tidy_split<-all_data_tidy%>%
#   separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")


list_proteins <- c("SNCA")


# combine_df_complete2<-combine_df_complete%>%
#   mutate(samp = if_else(as.character(samp) =="CABTEXCCPG1","Penta",if_else(as.character(samp) == "CABTEX","Quad",as.character(samp))))
target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-.75,.75))

###

target <-linear_results %>% filter(Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())
  
  
  # theme(axis.text.x = element_text())
 
p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



SNCA<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))

SNCA
```








```{r}
up_down2<-up_down%>%
  distinct()%>%
  group_by(Gene.Symbol,Compartment_ss)%>%
  mutate(counts=n())
```



### GO terms Penta ER only


```{r}
goinput_start<-read.csv("C:/Harper/Side_analysis/Kelsey_shiny/Golgiphagy_final/PaperCode/human_mouse_go.csv")%>%
  dplyr::mutate(GO=dplyr::if_else(stringr::str_sub(GO,1,1)==" ",stringr::str_sub(GO,2,-1),GO))%>%
  dplyr::filter(GO != "")

go.df <- goinput_start%>%
      dplyr::filter(organism == "human")%>%
      dplyr::select(-organism)


filt_ttest2<-singles%>%
  # filter(Compartment_ss == "ER")%>%
    dplyr::ungroup()%>%
    dplyr::mutate(set = dplyr::if_else(log2FC_CCPG1.WT> 0, dplyr::if_else(q.val_CCPG1.WT < 0.05,"sig","n.s."),"n.s."))%>%
    tidyr::separate(Reference,into = c("type","Reference","Description"),sep="\\|")%>%
    dplyr::select(Reference,set)



# filt_ttest2<-singles%>%
#   # filter(Compartment_ss == "ER")%>%
#     dplyr::ungroup()%>%
#     dplyr::mutate(set = dplyr::if_else(log2FC_ATG12.WT> 0, dplyr::if_else(q.val_ATG12.WT < 0.05,"sig","n.s."),"n.s."))%>%
#     tidyr::separate(Reference,into = c("type","Reference","Description"),sep="\\|")%>%
#     dplyr::select(Reference,set)



filt_ttest2<-nest_df4_ann2%>%
    dplyr::ungroup()%>%
    dplyr::mutate(set = dplyr::if_else(coeff_FAM134ABCTEXCCPG1> 0, dplyr::if_else(q.value_FAM134ABCTEXCCPG1 < 0.05,"sig","n.s."),"n.s."))%>%
    tidyr::separate(Reference,into = c("type","Reference","Description"),sep="\\|")%>%
    dplyr::select(Reference,set)

  
  
  
df.bg <- filt_ttest2 %>% 
  dplyr::distinct(Reference) %>% 
  dplyr::left_join(go.df) %>% 
  dplyr::mutate(all = dplyr::n_distinct(Reference)) %>% 
  dplyr::group_by(GO,GO_cat) %>% 
  dplyr::summarise("pos" = dplyr::n_distinct(Reference),
            "neg" = all - pos) %>% 
  dplyr::distinct() %>% 
  dplyr::mutate(selection="background") %>% 
  dplyr::ungroup()


go.df <- df.bg %>%
  dplyr::select(GO,GO_cat) %>%
  dplyr::left_join(go.df)


df.fg <- filt_ttest2 %>%  
  dplyr::mutate(selection = "foreground") %>% 
  dplyr::distinct(Reference, selection, set) %>% 
  dplyr::right_join(go.df) %>% 
  dplyr::group_by(selection, set) %>% 
  dplyr::mutate(term_all = dplyr::n_distinct(Reference)) %>% 
  dplyr::group_by(GO,GO_cat, selection, set) %>% 
  dplyr::summarise("pos" = dplyr::n_distinct(Reference),
            "neg" = term_all - pos) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(set == "sig")%>%
  dplyr::distinct()

df.nest <- df.bg %>% dplyr::left_join(df.fg %>% dplyr::distinct(GO,GO_cat, set)) %>% 
  dplyr::distinct() %>% 
  dplyr::full_join(df.fg) %>% 
  tidyr::drop_na(set) %>% 
  tidyr::drop_na(GO) %>% 
  dplyr::distinct() %>% 
  dplyr::group_by(GO,GO_cat, set) %>% 
  tidyr::nest() 


exact_pval_fun<-function(data){
  dataframe<-data.frame(data) %>%
    tibble::column_to_rownames(var = "selection")
  matrix<-as.matrix(dataframe) 
  exact_test_result<-fisher.test(matrix, alternative = "two.sided")
  return(exact_test_result$p.value)
}

## function to perform fisher test and get enrichment
enrich_fun<-function(data){
  dataframe<-data.frame(data) %>% 
    dplyr::mutate(frac = pos/neg) %>% 
    dplyr::select(-c(pos,neg)) %>% 
    tidyr::pivot_wider(names_from = selection, values_from = frac) %>% 
    dplyr::summarise(enrichment = foreground/background) 
  
  return(dataframe$enrichment[1])
}


fish.df <- df.nest %>% 
  dplyr::mutate(p.val = data %>% purrr::map_dbl(exact_pval_fun)) %>% #calc p val
  dplyr::mutate(enrich = data %>% purrr::map_dbl(enrich_fun)) %>%   #calc enrichment
  dplyr::select(-c(data)) %>%
  dplyr::filter(GO != "")%>%
  dplyr::arrange(p.val)
# print("fifth")


fish.df$p.val.adj <- p.adjust(fish.df$p.val,method="fdr")

fish.df<-fish.df%>%
  dplyr::arrange(p.val.adj)%>%    
  tibble::rownames_to_column("GORank")%>%
  dplyr::mutate(GORank=as.numeric(as.character(GORank)))


fish.df.sig_atg12<-fish.df%>%
  dplyr::mutate(sig_GO = dplyr::if_else(p.val.adj<0.05,"sig","n.s."))%>%
  dplyr::mutate(GO_id = stringr::str_sub(GO,-11,-2),
         GO_shrink1 = stringr::str_sub(GO,1,-13),
         GO_shrink = stringr::str_sub(GO_shrink1,1,70))

fish.df.sig_atg12$GO_cat <- factor(fish.df.sig_atg12$GO_cat, levels = c("molecular_function","cellular_component","biological_process"))
  
  

ggplot()+geom_point(data=fish.df.sig_atg12%>%filter(sig_GO != "sig"),  aes(log2(enrich), -log10(p.val.adj)),color="grey50",alpha=0.75)+
  theme_classic()+
  geom_point(data=fish.df.sig_atg12%>%filter(sig_GO == "sig"),  aes(log2(enrich), -log10(p.val.adj),color=GO_cat),alpha=0.75)+
    geom_hline(yintercept = -log10(0.05))+scale_color_viridis_d(end=0.8)+
    theme(axis.title = element_text(size=20),axis.text = element_text(size = 18))+
  geom_label_repel(data=fish.df.sig_atg12%>%filter(sig_GO == "sig"),  aes(log2(enrich), -log10(p.val.adj), color=GO_cat,label=GO_shrink),box.padding = 1,max.overlaps = Inf,size=3)+ 
    labs(x="Enrichment", y="-log10(q-value)",title="Up Regulated in ATG12 KO")
```


### Fig5 model figure

```{r}


tm_annotation <- read.csv("C:/Harper/Side_analysis/Melissa_shiny/ERphagy/ER_proteins_TMannotation.csv")%>%
  left_join(.,organelle_input_er_split,by="Gene.Symbol")%>%
  filter(Compartment_ss != "ER")%>%
  filter(str_detect(Compartment_ss,"ER." ), Compartment_ss !="ERGIC")

fig5_df<-nest_df4_ann2%>%
  filter(Compartment_ss %in% c("ER.Lumen","ER.Membrane.associated","ER.Membrane",
                               "ER.Receptors","ER.high.sheet","ER.high.curvature"  ))%>%
  mutate(sig_AC = if_else(q.value_FAM134AC<0.05,if_else(coeff_FAM134AC>0,"up","down"),"n.s."),
         sig_TEX = if_else(q.value_FAM134ABCTEX<0.05,if_else(coeff_FAM134ABCTEX>0,"up","down"),"n.s."),
         sig_CCPG1 = if_else(q.value_FAM134ABCTEXCCPG1<0.05,if_else(coeff_FAM134ABCTEXCCPG1>0,"up","down"),"n.s."))%>%
  filter(sig_AC != "n.s." |  sig_TEX != "n.s." | sig_CCPG1 != "n.s.")%>%
  mutate(group = if_else(sig_AC == "up", if_else(sig_CCPG1 == "up", "AC_up_CCPG1_up", if_else(sig_CCPG1 == "down", "AC_up_CCPG1_down", "AC_up")),
                         if_else(sig_AC == "down", if_else(sig_CCPG1 == "up","AC_down_CCPG1_up",if_else(sig_CCPG1 == "down", "AC_down_CCPG1_down",if_else(sig_TEX == "down","AC_down_TEX_down","AC_down"))),
                                 if_else(sig_AC == "n.s.",
                                         if_else(sig_CCPG1 == "up","CCPG1_up", if_else(sig_CCPG1 == "down", "CCPG1_down", "ERROR")),"ERROR"))))


fig5_df_tm <- left_join(fig5_df%>%select(-Compartment_ss),tm_annotation,by="Gene.Symbol")%>%
  filter(Compartment_ss != "ER.Receptors")%>%
  distinct()%>%
  group_by(Gene.Symbol)%>%
  mutate(counts_geneSymbol =n())%>%
  arrange(TMval, Compartment_ss,group)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank= as.numeric(as.character(Rank)))%>%
  group_by(TMval, Compartment_ss)%>%
  mutate(rank_val = rank(Rank))%>%
  mutate(ac_plot = if_else(sig_AC != "n.s.",coeff_FAM134AC,-1000),
         tex_plot = if_else(sig_TEX != "n.s.",coeff_FAM134ABCTEX,-1000),
         ccpg1_plot = if_else(sig_CCPG1 != "n.s.",coeff_FAM134ABCTEXCCPG1,-1000))

fig5_df_tm[fig5_df_tm == -1000] <- NA

fig5_df_tm2<-fig5_df_tm

# write.csv(fig5_df_tm , "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/fig5_er_beta_map_info_TMannotation.csv")


ggplot()+
  geom_text(data=fig5_df_tm, aes(as.factor(TMval),rank_val,color=group,label=Gene.Symbol))+
  facet_wrap(.~Compartment_ss,nrow=1)

lumen_fig5<- fig5_df_tm%>%filter(Compartment_ss == "ER.Lumen")

# lumen_fig5[lumen_fig5 == -1000] <- NA

ggplot()+
  geom_text(data=lumen_fig5, aes(TMval,-rank_val,color=group,label=Gene.Symbol),size=3)+
  geom_rect(data=lumen_fig5,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.75,xmax=TMval+.97,fill=ac_plot))+
  geom_rect(data=lumen_fig5,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+1,xmax=TMval+1.23,fill=tex_plot))+
  geom_rect(data=lumen_fig5,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+1.25,xmax=TMval+1.47,fill=ccpg1_plot))+
  geom_rect(data=lumen_fig5%>%filter(ac_plot>0.6),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.75,xmax=TMval+.97),fill="#B35806")+
  geom_rect(data=lumen_fig5%>%filter(tex_plot>0.6),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+1,xmax=TMval+1.23),fill="#B35806")+
  geom_rect(data=lumen_fig5%>%filter(ccpg1_plot>0.6),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+1.25,xmax=TMval+1.47),fill="#B35806")+
  geom_rect(data=lumen_fig5%>%filter(ac_plot<(-0.6)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.75,xmax=TMval+.97),fill="#542788")+
  geom_rect(data=lumen_fig5%>%filter(tex_plot<(-0.6)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+1,xmax=TMval+1.23),fill="#542788")+
  geom_rect(data=lumen_fig5%>%filter(ccpg1_plot<(-0.6)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+1.25,xmax=TMval+1.47),fill="#542788")+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806",limits=c(-.6,.6))+
  facet_wrap(.~TMval,nrow=1)+xlim(c(-1,3))+
  theme_classic()


ggplot()+
  geom_text(data=fig5_df_tm, aes(TMval,-rank_val,color=group,label=Gene.Symbol),size=3)+
  geom_rect(data=fig5_df_tm,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.75,xmax=TMval+.97,fill=ac_plot))+
  geom_rect(data=fig5_df_tm,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+1,xmax=TMval+1.23,fill=tex_plot))+
  geom_rect(data=fig5_df_tm,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+1.25,xmax=TMval+1.47,fill=ccpg1_plot))+
  
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806",limits=c(-.6,.6))+
  facet_wrap(.~TMval,nrow=1)+xlim(c(-2,12))+
  theme_classic()+facet_grid(Compartment_ss~TMval,scales="free")


fig5_df_tm3<-fig5_df_tm2%>%
  filter(Compartment_ss == "ER.Membrane")

mem<-ggplot()+
  geom_text(data=fig5_df_tm3%>%distinct(TMval,TMname), aes(TMval+0.25,0.5,label=TMname),size=6)+
  geom_text(data=fig5_df_tm3, aes(TMval-0.1,-rank_val+0.1,color=group,label=Gene.Symbol),size=3)+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28,fill=ac_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43,fill=tex_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58,fill=ccpg1_plot))+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#542788")+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806",limits=c(-.75,0.75),na.value = "grey90")+xlim(c(-1,11))+
  theme_classic()+
  labs(fill="Beta")+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())+
  ylim(c(-44,1))




fig5_df_tm3<-fig5_df_tm2%>%
  filter(Compartment_ss == "ER.Lumen")

lum<-ggplot()+
  geom_text(data=fig5_df_tm3%>%distinct(TMval,TMname), aes(TMval+0.25,0.5,label=TMname),size=6)+
  geom_text(data=fig5_df_tm3, aes(TMval-0.1,-rank_val+0.1,color=group,label=Gene.Symbol),size=3)+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28,fill=ac_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43,fill=tex_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58,fill=ccpg1_plot))+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#542788")+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806",limits=c(-.75,0.75),na.value = "grey90")+xlim(c(-1,11))+
  theme_classic()+
  labs(fill="Beta")+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())+
  ylim(c(-44,1))



fig5_df_tm3<-fig5_df_tm2%>%
  filter(Compartment_ss != "ER.Lumen", Compartment_ss != "ER.Membrane" , Compartment_ss != "ER.high.sheet")

rest<-ggplot()+
  geom_text(data=fig5_df_tm3%>%distinct(TMval,TMname), aes(TMval+0.25,0.5,label=TMname),size=6)+
  geom_text(data=fig5_df_tm3, aes(TMval-0.1,-rank_val+0.1,color=group,label=Gene.Symbol),size=3)+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28,fill=ac_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43,fill=tex_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58,fill=ccpg1_plot))+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#542788")+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806",limits=c(-.75,0.75),na.value = "grey90")+xlim(c(-1,11))+
  theme_classic()+
  labs(fill="Beta")+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())+
  ylim(c(-44,1))


fig5_df_tm3<-fig5_df_tm2%>%
  filter( Compartment_ss == "ER.high.sheet")

high_sheet<-ggplot()+
  geom_text(data=fig5_df_tm3%>%distinct(TMval,TMname), aes(TMval+0.25,0.5,label=TMname),size=6)+
  geom_text(data=fig5_df_tm3, aes(TMval-0.1,-rank_val+0.1,color=group,label=Gene.Symbol),size=3)+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28,fill=ac_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43,fill=tex_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58,fill=ccpg1_plot))+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#542788")+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806",limits=c(-.75,0.75),na.value = "grey90")+xlim(c(-1,11))+
  theme_classic()+
  labs(fill="Beta")+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())+
  ylim(c(-44,1))

test<-plot_grid(mem,lum,rest,high_sheet,nrow=4)
ggsave(test,file = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/fig5_test.pdf",height=40,width=20)
```



## Torin data

```{r}
tor<- read.csv("C:/Harper/Side_analysis/Melissa_shiny/ERphagy/data/2023_02_05 WTATG12PENTA torin treat/all_ttest_results (5).csv")

tor_ann<-tor%>%left_join(.,organelle_input_er_split,by="Gene.Symbol")

er<-tor_ann%>%filter(Compartment_ss == "ER")



tor_df_full<-left_join(tor,organelle_input_er_simple,by="Gene.Symbol")%>%
  distinct()


tor_df_full_erOnly<-left_join(tor,organelle_input_er_split,by="Gene.Symbol")%>%
  distinct()%>%
  filter(Compartment_ss %in% c("ER.Lumen","ER.Membrane","ER.Membrane.associated","ER.high.curvature","ER.Receptors","ER.high.sheet"))


write.csv(tor_df_full_erOnly, "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/SuppData_torin_erOnly.csv")

write.csv(tor_df_full, "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/SuppData_torin_allData.csv")
```


### Volcanoes

```{r}
ggplot(tor_ann,aes(log2FC_Pentad12torin.WTd12torin, -log10(q.val_Pentad12torin.WTd12torin), color=Compartment_ss))+geom_point(size=.5,alpha=0.5)+
  geom_text_repel(data=tor_ann%>%filter(sig_Pentad12torin.WTd12torin != "n.s."),aes(log2FC_Pentad12torin.WTd12torin, -log10(q.val_Pentad12torin.WTd12torin),label=Gene.Symbol),max.overlaps = Inf,box.padding = 1,alpha=0.5)+
  geom_vline(xintercept = log2(1.5))+
  geom_vline(xintercept = -log2(1.5))+
  geom_hline(yintercept = -log10(0.05))+facet_wrap(.~Compartment_ss)

ggplot(tor_ann,aes(log2FC_ATG12d12torin.WTd12torin, -log10(q.val_ATG12d12torin.WTd12torin), color=Compartment_ss))+geom_point(size=.5,alpha=0.5)+
  geom_text_repel(data=tor_ann%>%filter(sig_Pentad12torin.WTd12torin != "n.s."),aes(log2FC_ATG12d12torin.WTd12torin, -log10(q.val_ATG12d12torin.WTd12torin),label=Gene.Symbol),max.overlaps = Inf,box.padding = 1,alpha=0.5)+
  geom_vline(xintercept = log2(1.5))+
  geom_vline(xintercept = -log2(1.5))+
  geom_hline(yintercept = -log10(0.05))+facet_wrap(.~Compartment_ss)


ggplot(tor_ann,aes(log2FC_ATG12d12torin.WTd12torin, log2FC_Pentad12torin.WTd12torin, color=Compartment_ss))+geom_point(size=.5,alpha=0.5)+
  geom_text_repel(data=tor_ann%>%filter(sig_Pentad12torin.WTd12torin != "n.s."),aes(log2FC_ATG12d12torin.WTd12torin, log2FC_Pentad12torin.WTd12torin,label=Gene.Symbol),max.overlaps = Inf,alpha=0.5)+
  geom_vline(xintercept = 0, linetype="dashed")+
  # geom_vline(xintercept = -log2(1.5))+
  geom_hline(yintercept = 0, linetype="dashed")+facet_wrap(.~Compartment_ss)+ylim(c(-2.5,2.5))+xlim(c(-2.5,2.5))



# tor_ann_fk<-tor%>%left_join(.,ss_organelle_list_fk,by="Gene.Symbol")
# 
# 
# ggplot(tor_ann_fk,aes(Compartment_ss,log2FC_Pentad12torin.WTd12torin))+geom_boxplot(outlier.shape = NA)+coord_flip()+ylim(c(-1,1))+
#   geom_hline(yintercept = 0)+geom_jitter(size=0.1,alpha=0.4)
# 
# ggplot(tor_ann_fk,aes(Compartment_ss,log2FC_Pentad12torin.WTd12torin-log2FC_Pentad12.WTd12))+geom_boxplot(outlier.shape = NA)+coord_flip()+ylim(c(-1,1))+
#   geom_hline(yintercept = 0)+geom_jitter(size=0.1,alpha=0.4)
# 
# ggplot(tor_ann_fk,aes(Compartment_ss,log2FC_ATG12d12torin.WTd12torin))+geom_boxplot(outlier.shape = NA)+coord_flip()+ylim(c(-1,1))+
#   geom_hline(yintercept = 0)+geom_jitter(size=0.1,alpha=0.4)
# 
# ggplot(tor_ann_fk,aes(Compartment_ss,log2FC_Pentad12torin.WTd12torin))+geom_boxplot(outlier.shape = NA)+coord_flip()+ylim(c(-1,1))+
#   geom_hline(yintercept = 0)+geom_jitter(size=0.1,alpha=0.4)
```


### Point Plot



```{r}


### extra based on all proteins by compartment



### Figure 6 point plot
point_plot_tor_input<-tor_ann%>%
  # dplyr::filter(Compartment_ss %in% list_compartments )%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,cluster,Compartment_ss, matches("Log2"))%>%
  dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
         delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(delta_atg12_flux),
            med_penta = median(delta_penta_flux),
            q1_atg12= quantile(delta_atg12_flux,0.25),
            q3_atg12= quantile(delta_atg12_flux,0.75),
            q1_penta= quantile(delta_penta_flux,0.25),
            q3_penta= quantile(delta_penta_flux,0.75),
            num_proteins = n())

pointplot_double<-ggplot(point_plot_tor_input%>%filter(Compartment_ss %!in% c("Cis.Golgi","Trans.Golgi","ERGIC","ER.high.sheet","ER.high.curvature","ER.Receptors")),aes(med_atg12,med_penta,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_penta,yend=med_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_penta,yend=q3_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>%filter(Compartment_ss %!in% c("Cis.Golgi","Trans.Golgi","ERGIC","ER.high.sheet","ER.high.curvature","ER.Receptors")),aes(med_atg12,med_penta,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="Penta KO Torin/UT - WT Torin/UT",x="ATG12 KO Torin/UT - WT Torin/UT")

pointplot_double

# ggsave(pointplot_double,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/PointPlot_TorinMinUntreated.pdf", height = 8,width=10)


point_plot_tor_input<-tor_ann%>%
  # dplyr::filter(Compartment_ss %in% list_compartments )%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,cluster,Compartment_ss, matches("Log2"))%>%
  dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.WTd12torin,
         delta_atg12_flux = log2FC_ATG12d12torin.WTd12torin )%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(delta_atg12_flux),
            med_penta = median(delta_penta_flux),
            q1_atg12= quantile(delta_atg12_flux,0.25),
            q3_atg12= quantile(delta_atg12_flux,0.75),
            q1_penta= quantile(delta_penta_flux,0.25),
            q3_penta= quantile(delta_penta_flux,0.75),
            num_proteins = n())


# 
# point_plot_tor_input<-point_plot_tor_input%>%
#   dplyr::mutate(Compartment_ss = stringr::str_replace_all(Compartment_ss,"\\.","\\ "),
#                 Compartment_ss = stringr::str_replace_all(Compartment_ss,"Membrane","membrane"),
#                 Compartment_ss = stringr::str_replace_all(Compartment_ss,"membrane associated","associated")
                                # )



p1<-ggplot(point_plot_tor_input%>%filter(Compartment_ss %!in% c("Cis.Golgi","Trans.Golgi","ERGIC","ER.high.sheet","ER.high.curvature","ER.Receptors")),aes(med_atg12,med_penta,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_penta,yend=med_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_penta,yend=q3_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  xlim(c(-.25,.75))+ylim(c(-.25,0.5))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>%filter(Compartment_ss %!in% c("Cis.Golgi","Trans.Golgi","ERGIC","ER.high.sheet","ER.high.curvature","ER.Receptors")),aes(med_atg12,med_penta,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="Penta KO Torin - WT Torin",x="ATG12 KO Torin - WT Torin")+
  geom_abline(slope=1,linetype="dashed")

p1




point_plot_tor_input<-tor_ann%>%
  # dplyr::filter(Compartment_ss %in% list_compartments )%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,cluster,Compartment_ss, matches("Log2"))%>%
  dplyr::mutate(delta_penta_flux = log2FC_Pentad12.WTd12,
         delta_atg12_flux = log2FC_ATG12d12.WTd12 )%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(delta_atg12_flux),
            med_penta = median(delta_penta_flux),
            q1_atg12= quantile(delta_atg12_flux,0.25),
            q3_atg12= quantile(delta_atg12_flux,0.75),
            q1_penta= quantile(delta_penta_flux,0.25),
            q3_penta= quantile(delta_penta_flux,0.75),
            num_proteins = n())


# 
# point_plot_tor_input<-point_plot_tor_input%>%
#   dplyr::mutate(Compartment_ss = stringr::str_replace_all(Compartment_ss,"\\.","\\ "),
#                 Compartment_ss = stringr::str_replace_all(Compartment_ss,"Membrane","membrane"),
#                 Compartment_ss = stringr::str_replace_all(Compartment_ss,"membrane associated","associated")
                                # )



p2<-ggplot(point_plot_tor_input%>%filter(Compartment_ss %!in% c("Cis.Golgi","Trans.Golgi","ERGIC","ER.high.sheet","ER.high.curvature","ER.Receptors")),aes(med_atg12,med_penta,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_penta,yend=med_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_penta,yend=q3_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  xlim(c(-.25,.75))+ylim(c(-.25,0.5))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>%filter(Compartment_ss %!in% c("Cis.Golgi","Trans.Golgi","ERGIC","ER.high.sheet","ER.high.curvature","ER.Receptors")),aes(med_atg12,med_penta,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="Penta KO - WT",x="ATG12 KO - WT")+
  geom_abline(slope=1,linetype="dashed")


point_plot<-plot_grid(p2,p1,pointplot_double,nrow = 1)

point_plot
# ggsave(point_plot,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/ER_PointPlot_Torin_Untreated_all3.pdf", height = 6,width=18)

```


### Top Fluxers

```{r}

### based on candidates

## just ER

### Figure 6 point plot
point_plot_tor_input<-tor_ann%>%
  # dplyr::filter(Compartment_ss %in% list_compartments )%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,cluster,Compartment_ss, matches("Log2"))%>%
  dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
         delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  filter(str_detect(Compartment_ss,"ER")==T)%>%
  filter(Compartment_ss=="ER")

ggplot(point_plot_tor_input,aes(delta_atg12_flux,delta_penta_flux,color=Compartment_ss))+
  geom_point(size=1,alpha=0.6)+
  # geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_penta,yend=med_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  # geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_penta,yend=q3_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>% filter(delta_penta_flux>0.15, delta_atg12_flux>0.15),aes(delta_atg12_flux,delta_penta_flux,color=Compartment_ss, label=Gene.Symbol),max.overlaps = Inf,show.legend=FALSE)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="Penta KO Torin/UT - WT Torin/UT",x="ATG12 KO Torin/UT - WT Torin/UT")+facet_wrap(.~Compartment_ss)+xlim(c(-.5,1))+ylim(c(-.5,1))


atg12_fluxers<-ggplot(point_plot_tor_input,aes(log2FC_ATG12d12torin.WTd12torin,delta_atg12_flux))+
  geom_point(size=1,alpha=0.6)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>% filter(log2FC_ATG12d12torin.WTd12torin>0.25, delta_atg12_flux>0.15),aes(log2FC_ATG12d12torin.WTd12torin,delta_atg12_flux, label=Gene.Symbol),max.overlaps = Inf,show.legend=FALSE)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(x="ATG12 KO Torin - WT Torin",y="ATG12 KO Torin/UT - WT Torin/UT")+facet_wrap(.~Compartment_ss)+ylim(c(-.5,1.5))+xlim(c(-.05,0.95))

atg12_fluxers


# ggsave(atg12_fluxers,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/ER_ToppATG12_Fluxers.pdf", height = 8,width=15)




p3<-ggplot(point_plot_tor_input,aes(log2FC_Pentad12torin.WTd12torin,delta_penta_flux))+
  geom_point(size=1,alpha=0.6)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>% filter(Gene.Symbol %in% c("REEP1","REEP2","REEP3","REEP4","REEP5","FAM134C","TEX264","SEC62","FAM134A","VAPA","VAPB","ARL6IP5")),aes(log2FC_Pentad12torin.WTd12torin,delta_penta_flux, label=Gene.Symbol),max.overlaps = Inf,show.legend=FALSE,color="red")+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(x="Penta KO Torin - WT Torin",y="Penta KO Torin/UT - WT Torin/UT")+facet_wrap(.~Compartment_ss)+ylim(c(-2,2))+xlim(c(-2,2))

p3<-ggplot(point_plot_tor_input,aes(delta_atg12_flux,delta_penta_flux))+
  geom_point(size=1,alpha=0.6)+
  # geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_penta,yend=med_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  # geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_penta,yend=q3_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>% filter(Gene.Symbol %in% c("REEP1","REEP2","REEP3","REEP4","REEP5","FAM134C","TEX264","SEC62","FAM134A","VAPA","VAPB","ARL6IP5")),aes(delta_atg12_flux,delta_penta_flux,color=Compartment_ss, label=Gene.Symbol),max.overlaps = Inf,show.legend=FALSE,color="red")+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="Penta KO Torin/UT - WT Torin/UT",x="ATG12 KO Torin/UT - WT Torin/UT")+facet_wrap(.~Compartment_ss)+xlim(c(-.5,1))+ylim(c(-.5,1))


p1<-ggplot(point_plot_tor_input,aes(log2FC_ATG12d12.WTd12,log2FC_Pentad12.WTd12))+
  geom_point(size=1,alpha=0.6)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>% filter(Gene.Symbol %in% c("REEP1","REEP2","REEP3","REEP4","REEP5","FAM134C","TEX264","SEC62","FAM134A","VAPA","VAPB","ARL6IP5")),aes(log2FC_ATG12d12.WTd12,log2FC_Pentad12.WTd12, label=Gene.Symbol),max.overlaps = Inf,show.legend=FALSE,color="red")+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(x="Penta KO  - WT ",y="ATG12 KO  - WT ")+facet_wrap(.~Compartment_ss)+geom_abline()+xlim(c(-2,2))+ylim(c(-2,2))


p2<-ggplot(point_plot_tor_input,aes(log2FC_ATG12d12torin.WTd12torin,log2FC_Pentad12torin.WTd12torin))+
  geom_point(size=1,alpha=0.6)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>% filter(Gene.Symbol %in% c("REEP1","REEP2","REEP3","REEP4","REEP5")),aes(log2FC_ATG12d12torin.WTd12torin,log2FC_Pentad12torin.WTd12torin, label=Gene.Symbol),color="red",max.overlaps = Inf,show.legend=FALSE)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(x="Penta KO Torin - WT Torin",y="ATG12 KO Torin - WT Torin")+facet_wrap(.~Compartment_ss)+geom_abline()+xlim(c(-2,2))+ylim(c(-2,2))










plot_grid(p1,p2,p3,nrow=1)



ggplot(point_plot_tor_input,aes(log2FC_Pentad12.WTd12,log2FC_Pentad12torin.WTd12torin))+
  geom_point(size=1,alpha=0.6)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>% filter(Gene.Symbol %in% c("REEP1","REEP2","REEP3","REEP4","REEP5")),aes(log2FC_Pentad12.WTd12,log2FC_Pentad12torin.WTd12torin, label=Gene.Symbol),color="red",max.overlaps = Inf,show.legend=FALSE)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(x="Penta KO  - WT ",y="Penta KO Torin - WT Torin")+facet_wrap(.~Compartment_ss)+geom_abline()+xlim(c(-2,2))+ylim(c(-2,2))



ggplot(point_plot_tor_input,aes(log2FC_ATG12d12.WTd12,log2FC_ATG12d12torin.WTd12torin))+
  geom_point(size=1,alpha=0.6)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>% filter(Gene.Symbol %in% c("REEP1","REEP2","REEP3","REEP4","REEP5")),aes(log2FC_ATG12d12.WTd12,log2FC_ATG12d12torin.WTd12torin, label=Gene.Symbol),color="red",max.overlaps = Inf,show.legend=FALSE)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(x="ATG12 KO  - WT ",y="ATG12 KO Torin - WT Torin")+facet_wrap(.~Compartment_ss)+geom_abline()+xlim(c(-2,2))+ylim(c(-2,2))




ggplot(point_plot_tor_input,aes(log2FC_ATG12d12.WTd12,log2FC_ATG12d12torin.WTd12torin))+
  geom_point(size=1,alpha=0.6)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>% filter(Gene.Symbol %in% c("REEP1","REEP2","REEP3","REEP4","REEP5")),aes(log2FC_ATG12d12.WTd12,log2FC_ATG12d12torin.WTd12torin, label=Gene.Symbol),color="red",max.overlaps = Inf,show.legend=FALSE)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(x="ATG12 KO  - WT ",y="ATG12 KO Torin - WT Torin")+facet_wrap(.~Compartment_ss)+geom_abline()+xlim(c(-2,2))+ylim(c(-2,2))




p1<-ggplot(point_plot_tor_input,aes(log2FC_WTd12torin.WTd12,log2FC_ATG12d12torin.ATG12d12))+
  geom_point(size=1,alpha=0.3)+
  geom_point(data=point_plot_tor_input%>% filter(Gene.Symbol %in% c("REEP1","REEP2","REEP3","REEP4","REEP5","FAM134C","TEX264","SEC62","FAM134A","VAPA","VAPB","ARL6IP5")),aes(log2FC_WTd12torin.WTd12,log2FC_ATG12d12torin.ATG12d12),color="red")+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>% filter(Gene.Symbol %in% c("REEP1","REEP2","REEP3","REEP4","REEP5","FAM134C","TEX264","SEC62","FAM134A","VAPA","VAPB","ARL6IP5")),aes(log2FC_WTd12torin.WTd12,log2FC_ATG12d12torin.ATG12d12, label=Gene.Symbol),color="red",max.overlaps = Inf,show.legend=FALSE)+
  theme_classic()+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(x="WT torin  - WT ",y="ATG12 Torin - ATG12 ")+facet_wrap(.~Compartment_ss)+geom_abline()+xlim(c(-2,2))+ylim(c(-2,2))

p2<-ggplot(point_plot_tor_input,aes(log2FC_WTd12torin.WTd12,log2FC_Pentad12torin.Pentad12))+
  geom_point(size=1,alpha=0.3)+
  geom_point(data=point_plot_tor_input%>% filter(Gene.Symbol %in% c("REEP1","REEP2","REEP3","REEP4","REEP5","FAM134C","TEX264","SEC62","FAM134A","VAPA","VAPB","ARL6IP5")),aes(log2FC_WTd12torin.WTd12,log2FC_Pentad12torin.Pentad12),color="red")+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>% filter(Gene.Symbol %in% c("REEP1","REEP2","REEP3","REEP4","REEP5","FAM134C","TEX264","SEC62","FAM134A","VAPA","VAPB","ARL6IP5")),aes(log2FC_WTd12torin.WTd12,log2FC_Pentad12torin.Pentad12, label=Gene.Symbol),color="red",max.overlaps = Inf,show.legend=FALSE)+
  theme_classic()+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(x="WT torin  - WT ",y="penta Torin - penta ")+facet_wrap(.~Compartment_ss)+geom_abline()+xlim(c(-2,2))+ylim(c(-2,2))



plot_grid(p1,p2)

ggplot(point_plot_tor_input,aes(log2FC_WTd12torin.WTd12,log2FC_Pentad12torin.Pentad12))+
  geom_point(size=1,alpha=0.6)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>% filter(Gene.Symbol %in% c("REEP1","REEP2","REEP3","REEP4","REEP5")),aes(log2FC_WTd12torin.WTd12,log2FC_Pentad12torin.Pentad12, label=Gene.Symbol),color="red",max.overlaps = Inf,show.legend=FALSE)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(x="WT torin  - WT ",y="penta Torin - penta ")+facet_wrap(.~Compartment_ss)+geom_abline()+xlim(c(-2,2))+ylim(c(-2,2))

















###
point_plot_tor_input<-tor_ann%>%
  # dplyr::filter(Compartment_ss %in% list_compartments )%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,cluster,Compartment_ss, matches("Log2"))%>%
  dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
         delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  filter(str_detect(Compartment_ss,"ER")==T)%>%
  filter(Compartment_ss!="Peroxisome", Compartment_ss != "ER.Receptors")%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  
  dplyr::summarise(med_torin_ATG12=median(log2FC_ATG12d12torin.WTd12torin),
            med_atg12Flux = median(delta_atg12_flux),
            q1_torin_ATG12= quantile(log2FC_ATG12d12torin.WTd12torin,0.25),
            q3_torin_ATG12= quantile(log2FC_ATG12d12torin.WTd12torin,0.75),
            q1_atg12Flux= quantile(delta_atg12_flux,0.25),
            q3_atg12Flux= quantile(delta_atg12_flux,0.75),
            num_proteins = n())%>%
  distinct()


p2<-ggplot(point_plot_tor_input,aes(med_torin_ATG12,med_atg12Flux,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_torin_ATG12,xend=q3_torin_ATG12,y=med_atg12Flux,yend=med_atg12Flux,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_torin_ATG12,xend=med_torin_ATG12,y=q1_atg12Flux,yend=q3_atg12Flux,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input,aes(med_torin_ATG12,med_atg12Flux,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ATG12 Torin/UT - WT Torin/UT",x="ATG12 KO Torin / WT Torin")




point_plot_tor_input<-tor_ann%>%
  # dplyr::filter(Compartment_ss %in% list_compartments )%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,cluster,Compartment_ss, matches("Log2"))%>%
  dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
         delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  filter(str_detect(Compartment_ss,"ER")==T)%>%
  filter(Compartment_ss!="Peroxisome", Compartment_ss != "ER.Receptors")%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  
  dplyr::summarise(med_torin_ATG12=median(log2FC_ATG12d12.WTd12),
            med_atg12Flux = median(delta_atg12_flux),
            q1_torin_ATG12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_torin_ATG12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_atg12Flux= quantile(delta_atg12_flux,0.25),
            q3_atg12Flux= quantile(delta_atg12_flux,0.75),
            num_proteins = n())%>%
  distinct()


p1<-ggplot(point_plot_tor_input,aes(med_torin_ATG12,med_atg12Flux,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_torin_ATG12,xend=q3_torin_ATG12,y=med_atg12Flux,yend=med_atg12Flux,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_torin_ATG12,xend=med_torin_ATG12,y=q1_atg12Flux,yend=q3_atg12Flux,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input,aes(med_torin_ATG12,med_atg12Flux,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ATG12 Torin/UT - WT Torin/UT",x="ATG12 KO / WT")



plot_grid(p1,p2,nrow=1)

















####

point_plot_tor_input<-tor_ann%>%
  # dplyr::filter(Compartment_ss %in% list_compartments )%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,cluster,Compartment_ss, matches("Log2"))%>%
  dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
         delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  filter(str_detect(Compartment_ss,"ER")==T)%>%
  filter(Compartment_ss!="Peroxisome", Compartment_ss != "ER.Receptors")%>%
  dplyr::ungroup()


ggplot(point_plot_tor_input,aes(log2FC_ATG12d12torin.WTd12torin,delta_atg12_flux,color=Compartment_ss))+
  geom_point(size=1,alpha=0.6)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  theme(axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(x="ATG12 KO Torin - WT Torin",y="ATG12 KO Torin/UT - WT Torin/UT")+
  facet_wrap(.~Compartment_ss)



p6<-ggplot(point_plot_tor_input,aes(delta_atg12_flux,delta_penta_flux))+
  geom_point(size=1,alpha=0.6)+
  # geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_penta,yend=med_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  # geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_penta,yend=q3_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  # xlim(c(-.1,.3))+ylim(c(-.1,0.15))+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>% filter( delta_atg12_flux>0.25),aes(delta_atg12_flux,delta_penta_flux, label=Gene.Symbol),max.overlaps = Inf,show.legend=FALSE,box.padding = 1)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="Penta KO Torin/UT - WT Torin/UT",x="ATG12 KO Torin/UT - WT Torin/UT")+facet_wrap(.~Compartment_ss)+xlim(c(-.5,1.5))+ylim(c(-.5,0.5))

subset_atg12_torinCargo<-point_plot_tor_input%>% filter( delta_atg12_flux>0.25)
subset_atg12_torinCargo<-subset_atg12_torinCargo$Gene.Symbol



# log2FC_Pentad12.WTd12, log2FC_ATG12d12.WTd12 

p7<-ggplot(point_plot_tor_input%>%filter(Gene.Symbol %in% subset_atg12_torinCargo),aes( log2FC_ATG12d12torin.WTd12torin,log2FC_Pentad12torin.WTd12torin ))+
  geom_point(size=1,alpha=0.6)+
  geom_text_repel(data=point_plot_tor_input%>%filter(Gene.Symbol %in% subset_atg12_torinCargo),aes(log2FC_ATG12d12torin.WTd12torin,log2FC_Pentad12torin.WTd12torin , label=Gene.Symbol),max.overlaps = Inf,box.padding = 1,show.legend=FALSE)+geom_vline(xintercept = 0,linetype="dashed")+
  geom_hline(yintercept = 0, linetype="dashed")+theme_classic()+facet_wrap(.~Compartment_ss)

top_delta_fluxers <-plot_grid(p6,p7,align = "hv")


# ggsave(top_delta_fluxers,  filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/ER_ATG12_torinIncFluxers.pdf", height = 8,width=15)
```




### heatmap Singles top beta ccpg1

heat map of only high curvature and high sheet normalized to mean wt value


```{r}
high


er_raw<-singles_norm%>%
  # left_join(.,organelle_input_er_split,by="Gene.Symbol")%>%
  inner_join(.,high,by="Gene.Symbol")%>%
  # filter(str_detect(Compartment_ss,"ER")==T)%>%
  # filter(Compartment_ss != "ER")%>%
  # filter(Compartment_ss != 'Peroxisome')%>%
  # filter(Compartment_ss == "ER.high.curvature"| Compartment_ss == "ER.high.sheet")%>%
  group_by(Gene.Symbol)%>%
  mutate(counts=n(),
         Compartment=Compartment_ss)%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  select(-type,-desc)%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-log2_int,-cellLine,-mean_wt0, -counts,-Annotation,-Compartment)%>%
  group_by(ProtID, Compartment_ss)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  arrange(Compartment_ss)%>%
  mutate(Compartment_ss =str_replace_all(Compartment_ss,"\\."," "))


all_dataB_heatmap <- er_raw %>%
  ungroup()%>%
  # filter(Compartment_ss =="ER")%>%
  select(-Compartment_ss)%>%
  column_to_rownames(var="ProtID")

annotation_allB<-er_raw %>%
  # filter(Compartment_ss =="ER")%>%
  select(ProtID, Compartment_ss)

df_col_ann <- data.frame("sample"= colnames(er_raw)[3:20], values = c("WT","WT","WT",
                                                                "ATG12","ATG12","ATG12",
                                                                "CCPG1","CCPG1","CCPG1",
                                                                "TEX264","TEX264","TEX264",
                                                                "FAM134A","FAM134A",
                                                                "FAM134B","FAM134B",
                                                                "FAM134C","FAM134C"))
annoD<-data.frame(row.names=df_col_ann$sample, Condition=df_col_ann$values)
annoB<-data.frame(row.names=annotation_allB$ProtID, Annotation=annotation_allB$Compartment_ss)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann$sample, Condition=df_col_ann$values)

# annoD$Condition<-factor(annoD$Condition, values=c("WT","ATG12","CCPG1","TEX264","FAM134A","FAM134B","FAM134C"))

# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 1, length.out=floor(paletteLength/2)))

# test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


rownames(annoD) <- colnames(all_dataB_heatmap)

test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB,annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)

# ggsave(plot = test, filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/paper_figures_v1/fig4a_singlets_heatmap_ERhc_ERhs.pdf", height = 4.5,width=7.5)

```

## CALCOCO

```{r}
calco<-read.csv("C:/Harper/Side_analysis/Melissa_shiny/ERphagy/data/all_ttest_results_d12_WTATG12TEXCCPG1.csv")

calco<-left_join(calco,organelle_input_er_split,by="Gene.Symbol")%>%
  distinct()%>%
  filter(Compartment_ss %in% c("ER","ER.Lumen","ER.Membrane"))%>%
  select(Reference, Gene.Symbol, Annotation, WT, ATG12 , TEXCCPG1,Compartment_ss)%>%
  mutate(ATG12val = ATG12 -WT,
         TEXCCPG1val = TEXCCPG1 - WT)%>%
  select(Reference, Gene.Symbol, Annotation, Compartment_ss,ATG12val,TEXCCPG1val)%>%
  group_by(Reference, Gene.Symbol, Annotation, Compartment_ss)%>%
  gather("comparison","value",5:6)%>%
  mutate(comparison = str_remove(comparison,"val"))


p5<-ggplot(calco, aes(comparison,value,fill=Compartment_ss))+
  geom_hline(yintercept = 0,linetype="dashed")+geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.5,color="black")+
  # geom_jitter(data=calco, aes(comparison,value,color=Compartment_ss),position = "dodge")+
  theme_classic()+
  scale_fill_viridis_d(end=0.8)+
  labs(x="",
       y="Log2FC to WT",
       color="Compartment")+
  theme(
    axis.text = element_text(size=16),
    axis.title = element_text(size=18),
    legend.title = element_blank(),
    legend.text = element_text(size=16),
    legend.position = "top"
  )


ggsave(plot=p5,filename = "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/TEXCCPG1_ER_violin.pdf",
width = 6,height = 5)

calco<-read.csv("C:/Harper/Side_analysis/Melissa_shiny/ERphagy/data/all_ttest_results_d12_WTATG12TEXCCPG1.csv")

ccpg1tex_df_full<-left_join(calco,organelle_input_er_simple,by="Gene.Symbol")%>%
  distinct()


ccpg1tex_df_full_erOnly<-left_join(calco,organelle_input_er_split,by="Gene.Symbol")%>%
  distinct()%>%
  filter(Compartment_ss %in% c("ER.Lumen","ER.Membrane","ER.Membrane.associated","ER.high.curvature","ER.Receptors","ER.high.sheet"))


write.csv(ccpg1tex_df_full_erOnly, "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/SuppData_TEXCCPG1_erOnly.csv")

write.csv(ccpg1tex_df_full, "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/figures_2302/SuppData_TEXCCPG1_allData.csv")

```

